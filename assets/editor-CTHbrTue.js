const W=([e],[t])=>e===t?0:e<t?1:-1,m=(e,t)=>{const n=W(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},G=([e,t])=>m(e,t)===-1?[t,e]:[e,t],Ye=(e,t=n=>F(n)?n.text:"")=>e.reduce((n,s,r)=>(r!==0&&(n+=`
`),n+s.reduce((i,a)=>i+t(a),"")),""),de=(e,t)=>e.split(`
`).map(n=>n?[{...t,text:n}]:[]);const Ae=e=>e._type!==4;class V{constructor(t){this._ops=t?t.slice():[]}get ops(){return this._ops}insert(t,n){return this._ops.push({_type:2,_pos:t,_text:n}),this}insertFragment(t,n){return this._ops.push({_type:3,_pos:t,_fragment:n}),this}delete(t,n){return this._ops.push({_type:1,_start:t,_end:n}),this}select(t,n){return this._ops.push({_type:4,_anchor:t,_focus:n}),this}transform(t){return this._ops.reduce((n,s)=>Ae(s)?ae(n,s):n,t)}}const je=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),F=e=>"text"in e,{keys:be,is:Ze}=Object,Je=(e,t)=>{const n=be(e);return n.length!==be(t).length?!1:n.every(s=>s in t?s==="text"||Ze(e[s],t[s]):!1)},Ke=e=>F(e)?e.text.length:1,Qe=e=>e.reduce((t,n)=>t+Ke(n),0),et=(e,t=0,n=e.length-1)=>{let s=t+1;for(;s<=n;){const r=e[s-1],i=e[s];F(r)&&F(i)&&Je(r,i)?(e[s-1]={...r,text:r.text+i.text},e.splice(s,1),n--):s++}},U=(...e)=>{const t=[];return e.forEach(n=>{if(n.length){const s=t.length;t.push(...n),s&&et(t,s-1,s)}}),t},A=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],r=Ke(s);if(r>t){const i=e.slice(0,n),a=e.slice(n+1);if(F(s)){const l=s.text.slice(0,t),f=s.text.slice(t);l&&i.push({...s,text:l}),f&&a.unshift({...s,text:f})}else a.unshift(s);return[i,a]}t-=r}return[e,[]]},ie=(e,t,n,s)=>{const[r]=n,[i]=s||n,[a,l]=A(e[n[0]],n[1]),f=s?A(e[s[0]],s[1])[1]:l;if(typeof t=="string"){const h=a.length;t=de(t,h?a[h-1]:void 0)}let E;t.length?(E=[...t],E[0]=U(a,E[0]),E[E.length-1]=U(E[E.length-1],f)):E=[U(a,f)];const u=e.slice();return u.splice(r,i-r+1,...E),u},tt=(e,t,n)=>W(t,n)===0?[A(A(e[t[0]],n[1])[0],t[1])[1]]:[A(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),A(e[n[0]],n[1])[0]],nt=e=>{switch(e._type){case 1:return m(e._start,e._end)===1;case 2:return!!e._text;case 3:return!!Ye(e._fragment)}return!0},st=(e,t)=>{switch(t._type){case 1:return ie(e,[],t._start,t._end);case 2:return ie(e,t._text,t._pos);case 3:return ie(e,t._fragment,t._pos)}return e},ae=(e,t)=>{switch(t._type){case 1:{const{_start:n,_end:s}=t;if(m(e,n)!==1)return m(s,e)===1?[e[0]+n[0]-s[0],e[1]+(W(s,e)===0?n[1]-s[1]:0)]:n;break}case 2:case 3:{const n=t._pos,s=t._type===2?de(t._text):t._fragment,r=s.length,i=r-1;if(m(e,n)!==1)return[e[0]+i,e[1]+(W(e,n)===0?Qe(s[r-1])-(i===0?0:n[1]):0)];break}}return e},rt=(e,t,n,s)=>{try{for(const r of n.ops)nt(r)&&(Ae(r)?(e=st(e,r),t=[ae(t[0],r),ae(t[1],r)]):(r._anchor||r._focus)&&(t=[r._anchor||t[0],r._focus||t[1]]));return[e,t]}catch(r){s&&s("rollback transaction: "+r);return}},ot=500,it=500,ct=e=>{let t=0,n=0;const s=Date.now,r=[e],i=()=>r[t],a=()=>t>0,l=()=>t<r.length-1;return{get:i,set:f=>{r[t]=f},undo:()=>{if(a())return t--,i()},redo:()=>{if(l())return t++,i()},push:f=>{const E=s();t!==0&&E-n<it&&t--,n=E,r[++t]=f,r.splice(t+1),t>ot&&(t--,r.shift())}}};let P,p,D,$,le=!1,ue=!1,He;const at=1,lt=4,Ee=1,j=2,Z=3,pe=4,ut=5,ft=6,dt=1,Et=3,pt=8,_t=e=>e.nodeType===Et,J=e=>e.nodeType===dt,ht=e=>e.nodeType===pt,Tt=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Ve=e=>e.contentEditable==="false"||Tt.has(e.tagName),fe=()=>p,Fe=()=>D===Ee?p.data.length:D===j?1:0,gt=e=>{P.currentNode=P.currentNode.parentNode.children[e]},Ce=e=>{const t=e.nextSibling;return!!t&&!ht(t)},Nt=()=>{for(;;){if(D===j){const e=p;for(;(p=P.nextNode())&&e.contains(p););}else p=P.nextNode();if(D=null,!p)break;if($){if($.contains(p)){if(le=!0,ue)break}else if(le)break}if(_t(p)){const e=p.data;if(e)return e===`
`?D=Ce(p)?Z:ft:D=Ee}else if(J(p)){if(p.tagName==="BR")return D=Ce(p)?Z:ut;if(Ve(p))return D=j;if(He(p))return D=pe}}},_e=(e,t,{_document:n,_isBlock:s},r)=>{try{return He=s,P=n.createTreeWalker(t,lt|at),r&&(r._startNode&&(P.currentNode=r._startNode,P.previousNode()),r._endNode&&($=r._endNode),ue=r._excludeEnd||!1),e(Nt)}finally{P=p=D=$=null,le=ue=!1}},vt=Math.min,yt=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},Dt=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),St=e=>Dt.has(e.tagName),Lt=2,Xe=e=>e.ownerDocument,ze=e=>Xe(e).getSelection(),xt=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},ke=(e,t,n)=>{const s=ze(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},Me=(e,t,[n,s],r)=>{const i=m(n,s),a=i===0,l=i===-1,f=l?s:n,E=l?n:s;if(f[0]===0&&f[1]===0&&a&&!t.hasChildNodes()){const w=e.createRange();return w.setStart(t,0),w.setEnd(t,0),ke(t,w),!0}const u=Be(t,f,r);if(!u)return!1;const h=a?u:Be(t,E,r);if(!h)return!1;const N=e.createRange(),[S,x]=u,[O,X]=h;return J(S)?x<1?N.setStartBefore(S):N.setStartAfter(S):N.setStart(S,x),J(O)?X<1?N.setEndBefore(O):N.setEndAfter(O):N.setEnd(O,X),ke(t,N,l),!0},Be=(e,[t,n],s)=>_e(r=>{let i,a=!1;for(;i=r();)if(i===pe)a||(a=!0,t!==0&&gt(t));else{const l=Fe();if(n<=l)return[fe(),n];n-=l}},e,s),Ot=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},Rt=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},Q=(e,t,n,s)=>{let r,i,a=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(J(t)&&!Ve(t)&&t.hasChildNodes()){const f=vt(n,t.childNodes.length-1);t=t.childNodes[f],a=f===n,n=0}const l=Ot(e,t);return s._isBlock(l)?(r=l,i=Rt(r)):(r=e,i=0),_e(f=>{let E,u=0;for(;E=f();)E===Z?(i++,u=0):u+=Fe();return[i,u+n]},r,s,{_endNode:t,_excludeEnd:a})},qe=(e,t,{startOffset:n,startContainer:s,endOffset:r,endContainer:i})=>{const a=Q(e,s,n,t);return[a,s===i&&n===r?a:Q(e,i,r,t)]},Ge=()=>[[0,0],[0,0]],Pt=(e,t)=>e.compareDocumentPosition(t),mt=(e,t)=>{const n=ze(e),s=xt(n,e);if(!s)return Ge();const r=qe(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(Pt(n.anchorNode,n.focusNode)&Lt)!==0)?[r[1],r[0]]:r},Mt=(e,t,n)=>_e(s=>{let r,i=null,a="",l=!1;const f=[],E=()=>{a&&(i||(i=[]),i.push({text:a}),a="")},u=()=>{E(),!i&&l&&(i=[]),i&&f.push(i),i=null,l=!1};for(;r=s();)if(r===pe)u();else if(l=!0,r===Ee)a+=fe().data;else if(r===j){E();const h=n(fe());h&&i.push(h)}else r===Z&&u();return u(),f.length||f.push([]),f},e,t),wt=(e,t,{clientX:n,clientY:s},r)=>{if(e.caretPositionFromPoint){const i=e.caretPositionFromPoint(n,s);if(i)return Q(t,i.offsetNode,i.offset,r)}else if(e.caretRangeFromPoint){const i=e.caretRangeFromPoint(n,s);if(i)return Q(t,i.startContainer,i.startOffset,r)}},It=(e,t)=>{let n=!1;const s=[],r=l=>{n&&s.push(...l)},i=new MutationObserver(l=>{r(l),n||t()}),a=()=>{r(i.takeRecords())};return i.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(l){!n&&l&&a(),n=l},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),i.disconnect()}}},bt=()=>({mount:e=>{e.ariaMultiLine=null},apply:(e,t)=>e(new V(t.ops.map(n=>n._type===2?{...n,_text:n._text.replaceAll(`
`,"")}:n._type===3?{...n,_fragment:[U(...n._fragment)]}:n)))}),Ct=e=>(t,n)=>{t.setData("text/plain",Ye(n,e))},kt=()=>e=>de(e.getData("text/plain")),ce=()=>{},Bt=({schema:{single:e,js:t,doc:n},doc:s,copy:r=[Ct()],paste:i=[kt()],isBlock:a=St,onChange:l,onKeyDown:f,onError:E=console.error})=>{let u=Ge(),h=!1,N=ce;const S=()=>x.get()[0],x=ct([n(s),u]),O=[];e&&O.push(bt());const X=O.reduceRight((o,{apply:T})=>T?(v,C,I)=>T(ne=>o(v,C,ne),I):o,(o,T,v)=>rt(o,T,v,E)),w=[],K=o=>{h||(w.unshift(o),Ue(We))},ee=new Set,Ue=o=>{ee.has(o)||(ee.add(o),yt(()=>{ee.delete(o),o()}))},We=()=>{if(w.length){let o=S(),T=u,v;for(;v=w.pop();){const I=X(o,T,v);I&&(o=I[0],T=I[1])}const C=S();je(o,C)||(x.set([C,u]),x.push([o,T]),l(t(o))),u=T}},te={get doc(){return S()},get selection(){return u},input:o=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return E("beforeinput event is not supported."),ce;const{contentEditable:T,role:v,ariaMultiLine:C,ariaReadOnly:I}=o,ne=o.style.whiteSpace;o.role="textbox",o.style.whiteSpace="pre-wrap",o.ariaMultiLine="true",O.forEach(({mount:c})=>{c&&c(o)});let he=!1,se=!1,k=null,R=!1,z=!1,q=!1;const M=Xe(o),B={_document:M,_isBlock:a};N=()=>{o.contentEditable=h?"false":"true",o.ariaReadOnly=h?"true":null},N();const $e=(c,d)=>{for(const _ of r)_(c,d,o)},Te=c=>{for(const d of i){const _=d(c,B);if(_)return _}E("failed to serialize pasted data")},Y=It(o,()=>{z&&Me(M,o,u,B)}),H=()=>{u=mt(o,B)},re=()=>{const c=Y._flush();if(Y._record(!1),c.length){let d;for(;d=c.pop();)if(d.type==="childList"){const{target:_,removedNodes:g,addedNodes:y,nextSibling:L}=d;for(let b=g.length-1;b>=0;b--)_.insertBefore(g[b],L);for(let b=y.length-1;b>=0;b--)_.removeChild(y[b])}else d.target.nodeValue=d.oldValue;Y._flush(),se=Me(M,o,u,B)}K(k),R=!1,k=null},ge=c=>{if(!R){if(f&&f(c)){c.preventDefault();return}if((c.metaKey||c.ctrlKey)&&!c.altKey&&c.code==="KeyZ"&&(c.preventDefault(),Y._record(!1),!h)){const d=c.shiftKey?x.redo():x.undo();d&&(l(t(d[0])),u=d[1])}}},Ne=()=>{R||re()},ve=c=>{c.preventDefault();const d=c.inputType;if(d.startsWith("format")||d==="historyUndo"||d==="historyRedo")return;R?Y._record(!0):H();const _=c.getTargetRanges()[0];if(_){const g=qe(o,B,_);let y=d==="insertParagraph"||d==="insertLineBreak"?`
`:c.data;if(y==null){const L=c.dataTransfer;L&&(y=L.getData("text/plain"))}k||(k=new V().select(...u)),m(...g)!==0&&k.delete(...g),y&&k.insert(g[0],y)}R||re()},ye=()=>{R||H(),R=!0},De=()=>{re()},Se=()=>{z=!0,H()},Le=()=>{z=!1},xe=()=>{if(se){se=!1;return}z&&!R&&!q&&H()},oe=c=>{H(),m(...u)!==0&&$e(c,tt(S(),...G(u)))},Oe=c=>{c.preventDefault(),oe(c.clipboardData)},Re=c=>{c.preventDefault(),h||(oe(c.clipboardData),K(new V().delete(...G(u))))},Pe=c=>{c.preventDefault();const d=Te(c.clipboardData);if(d){const[_,g]=G(u);K(new V().delete(_,g).insertFragment(_,d))}},me=c=>{c.preventDefault();const d=c.dataTransfer,_=wt(M,o,c,B);if(d&&_){const g=new V;q&&g.delete(...G(u));const y=Te(d);if(y){const L=g.transform(_);g.select(L,L).insertFragment(L,y).select(L)}K(g),o.focus({preventScroll:!0})}},we=c=>{q=!0,oe(c.dataTransfer)},Ie=()=>{q=!1};return M.addEventListener("selectionchange",xe),o.addEventListener("keydown",ge),o.addEventListener("input",Ne),o.addEventListener("beforeinput",ve),o.addEventListener("compositionstart",ye),o.addEventListener("compositionend",De),o.addEventListener("focus",Se),o.addEventListener("blur",Le),o.addEventListener("copy",Oe),o.addEventListener("cut",Re),o.addEventListener("paste",Pe),o.addEventListener("drop",me),o.addEventListener("dragstart",we),o.addEventListener("dragend",Ie),()=>{he||(he=!0,N=ce,o.contentEditable=T,o.role=v,o.ariaMultiLine=C,o.ariaReadOnly=I,o.style.whiteSpace=ne,Y._dispose(),M.removeEventListener("selectionchange",xe),o.removeEventListener("keydown",ge),o.removeEventListener("input",Ne),o.removeEventListener("beforeinput",ve),o.removeEventListener("compositionstart",ye),o.removeEventListener("compositionend",De),o.removeEventListener("focus",Se),o.removeEventListener("blur",Le),o.removeEventListener("copy",Oe),o.removeEventListener("cut",Re),o.removeEventListener("paste",Pe),o.removeEventListener("drop",me),o.removeEventListener("dragstart",we),o.removeEventListener("dragend",Ie))}},command:(o,...T)=>{const v=o.call(te,...T);return v&&K(v),te},readonly:o=>{h=o,N()}};return te};export{V as T,xt as a,ze as b,Bt as c,Ye as d,ht as e,kt as f,Qe as g,F as i,Ct as p,Mt as r,de as s,G as t};
