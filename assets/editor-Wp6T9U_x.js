const lt=Math.min,{keys:Ke,is:ut}=Object,he=e=>typeof e=="string",ft=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},$=([e],[t])=>e===t?0:e<t?1:-1,m=(e,t)=>{const n=$(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},U=([e,t])=>m(e,t)===-1?[t,e]:[e,t],Ge=(e,t=n=>M(n)?n.text:"")=>e.reduce((n,s,o)=>(o!==0&&(n+=`
`),n+s.reduce((i,a)=>i+t(a),"")),""),We=(e,t)=>e.split(`
`).map(n=>n?[{...t,text:n}]:[]),te=1,G=2,ne=3,ve=4,se=5,Ue=e=>e._type!==se;class q{constructor(t){this.unsafe=!1,this._ops=t?t.slice():[]}get ops(){return this._ops}insert(t,n){return this._ops.push({_type:G,_pos:t,_text:n}),this}insertFragment(t,n){return this.unsafe=!0,this._ops.push({_type:ne,_pos:t,_fragment:n}),this}delete(t,n){return this._ops.push({_type:te,_start:t,_end:n}),this}attr(t,n,s){return this._ops.push({_type:ve,_start:t,_end:n,_attr:s}),this}select(t,n){return this._ops.push({_type:se,_anchor:t,_focus:n}),this}transform(t){return this._ops.reduce((n,s)=>Ue(s)?_e(n,s):n,t)}}const dt=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),M=e=>"text"in e,pt=(e,t)=>{const n=Ke(e);return n.length!==Ke(t).length?!1:n.every(s=>s in t?s==="text"||ut(e[s],t[s]):!1)},Xe=e=>M(e)?e.text.length:1,$e=e=>e.reduce((t,n)=>t+Xe(n),0),ht=(e,t=0,n=e.length-1)=>{let s=t+1;for(;s<=n;){const o=e[s-1],i=e[s];M(o)&&M(i)&&pt(o,i)?(e[s-1]={...o,text:o.text+i.text},e.splice(s,1),n--):s++}},je=(e,t)=>{if(t.length){const n=e.length;e.push(...t),n&&ht(e,n-1,n)}},de=(...e)=>{const t=[];return e.forEach(n=>{je(t,n)}),t},F=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],o=Xe(s);if(o>t){const i=e.slice(0,n),a=e.slice(n+1);if(M(s)){const u=s.text.slice(0,t),f=s.text.slice(t);u&&i.push({...s,text:u}),f&&a.unshift({...s,text:f})}else a.unshift(s);return[i,a]}t-=o}return[e,[]]},X=(e,t,n,s)=>{const[o]=n,[i]=s||n,[a,u]=F(e[n[0]],n[1]),f=s?F(e[s[0]],s[1])[1]:u;if(he(t)){const y=a.length;let g;if(y){const L=a[y-1];M(L)&&(g=L)}t=We(t,g)}let c;t.length?(c=[...t],c[0]=de(a,c[0]),c[c.length-1]=de(c[c.length-1],f)):c=[de(a,f)];const p=e.slice();return p.splice(o,i-o+1,...c),p},Je=(e,t,n)=>$(t,n)===0?[F(F(e[t[0]],n[1])[0],t[1])[1]]:[F(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),F(e[n[0]],n[1])[0]],R=(e,[t,n])=>t>=0&&t<e.length&&n>=0&&n<=$e(e[t]),_t=(e,t)=>{switch(t._type){case te:{const{_start:n,_end:s}=t;return R(e,n)&&R(e,s)&&m(n,s)===1}case G:return R(e,t._pos)&&!!t._text;case ne:return R(e,t._pos)&&!!Ge(t._fragment);case ve:{const{_start:n,_end:s}=t;return R(e,n)&&R(e,s)&&m(n,s)===1}case se:return(!t._anchor||R(e,t._anchor))&&(!t._focus||R(e,t._focus))}},_e=(e,t)=>{switch(t._type){case te:{const{_start:n,_end:s}=t;if(m(e,n)!==1)return m(s,e)===1?[e[0]+n[0]-s[0],e[1]+($(s,e)===0?n[1]-s[1]:0)]:n;break}case G:case ne:{const n=t._pos,s=t._type===G?We(t._text):t._fragment,o=s.length,i=o-1;if(m(e,n)!==1)return[e[0]+i,e[1]+($(e,n)===0?$e(s[o-1])-(i===0?0:n[1]):0)];break}}return e},Et=(e,t,n,s)=>{try{for(const o of n.ops)if(_t(e,o)){switch(o._type){case te:{e=X(e,[],o._start,o._end);break}case G:{e=X(e,o._text,o._pos);break}case ne:{e=X(e,o._fragment,o._pos);break}case ve:{const{_start:i,_end:a,_attr:u}=o;e=X(e,Je(e,i,a).map(f=>f.map(c=>M(c)?{...c,...u}:c)),i,a);break}case se:{(o._anchor||o._focus)&&(t=[o._anchor||t[0],o._focus||t[1]]);break}default:}Ue(o)&&(t=[_e(t[0],o),_e(t[1],o)])}return[e,t]}catch(o){s&&s("rollback transaction: "+o);return}},gt=500,Tt=500,vt=e=>{let t=0,n=0;const s=Date.now,o=[e],i=()=>o[t],a=()=>t>0,u=()=>t<o.length-1;return{get:i,set:f=>{o[t]=f},undo:()=>{if(a())return t--,i()},redo:()=>{if(u())return t++,i()},push:f=>{const c=s();t!==0&&c-n<Tt&&t--,n=c,o[++t]=f,o.splice(t+1),t>gt&&(t--,o.shift())}}};let k,E,x,j,Ee=!1,ge=!1,Qe;const yt=1,Nt=4,ye=1,J=2,Q=3,Ne=4,Lt=5,St=6,Dt=1,xt=3,mt=8,Ot=e=>e.nodeType===xt,Z=e=>e.nodeType===Dt,wt=e=>e.nodeType===mt,bt=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Ze=e=>e.contentEditable==="false"||bt.has(e.tagName),Te=()=>E,et=()=>x===ye?E.data.length:x===J?1:0,Rt=e=>{k.currentNode=k.currentNode.parentNode.children[e]},Ve=e=>{const t=e.nextSibling;return!!t&&!wt(t)},kt=()=>{for(;;){if(x===J){const e=E;for(;(E=k.nextNode())&&e.contains(E););}else E=k.nextNode();if(x=null,!E)break;if(j){if(j.contains(E)){if(Ee=!0,ge)break}else if(Ee)break}if(Ot(E)){const e=E.data;if(e)return e===`
`?x=Ve(E)?Q:St:x=ye}else if(Z(E)){if(E.tagName==="BR")return x=Ve(E)?Q:Lt;if(Ze(E))return x=J;if(Qe(E))return x=Ne}}},Le=(e,t,{_document:n,_isBlock:s},o)=>{try{return Qe=s,k=n.createTreeWalker(t,Nt|yt),o&&(o._startNode&&(k.currentNode=o._startNode,k.previousNode()),o._endNode&&(j=o._endNode),ge=o._excludeEnd||!1),e(kt)}finally{k=E=x=j=null,Ee=ge=!1}},Ct=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),Pt=e=>Ct.has(e.tagName),It=2,tt=e=>e.ownerDocument,nt=e=>tt(e).getSelection(),Mt=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},Fe=(e,t,n)=>{const s=nt(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},ze=(e,t,[n,s],o)=>{const i=m(n,s),a=i===0,u=i===-1,f=u?s:n,c=u?n:s;if(f[0]===0&&f[1]===0&&a&&!t.hasChildNodes()){const A=e.createRange();return A.setStart(t,0),A.setEnd(t,0),Fe(t,A),!0}const p=Ye(t,f,o);if(!p)return!1;const y=a?p:Ye(t,c,o);if(!y)return!1;const g=e.createRange(),[L,C]=p,[S,B]=y;return Z(L)?C<1?g.setStartBefore(L):g.setStartAfter(L):g.setStart(L,C),Z(S)?B<1?g.setEndBefore(S):g.setEndAfter(S):g.setEnd(S,B),Fe(t,g,u),!0},Ye=(e,[t,n],s)=>Le(o=>{let i,a=!1;for(;i=o();)if(i===Ne)a||(a=!0,t!==0&&Rt(t));else{const u=et();if(n<=u)return[Te(),n];n-=u}},e,s),Bt=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},At=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},ee=(e,t,n,s)=>{let o,i,a=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(Z(t)&&!Ze(t)&&t.hasChildNodes()){const f=lt(n,t.childNodes.length-1);t=t.childNodes[f],a=f===n,n=0}const u=Bt(e,t);return s._isBlock(u)?(o=u,i=At(o)):(o=e,i=0),Le(f=>{let c,p=0;for(;c=f();)c===Q?(i++,p=0):p+=et();return[i,p+n]},o,s,{_endNode:t,_excludeEnd:a})},st=(e,t,{startOffset:n,startContainer:s,endOffset:o,endContainer:i})=>{const a=ee(e,s,n,t);return[a,s===i&&n===o?a:ee(e,i,o,t)]},rt=()=>[[0,0],[0,0]],Ht=(e,t)=>e.compareDocumentPosition(t),Kt=(e,t)=>{const n=nt(e),s=Mt(n,e);if(!s)return rt();const o=st(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(Ht(n.anchorNode,n.focusNode)&It)!==0)?[o[1],o[0]]:o},Gt=(e,t,n,s)=>Le(o=>{let i,a=null,u="",f=!1;const c=[],p=()=>{u&&(a||(a=[]),a.push(n(u)),u="")},y=()=>{p(),!a&&f&&(a=[]),a&&c.push(a),a=null,f=!1};for(;i=o();)if(i===Ne)y();else if(f=!0,i===ye)u+=Te().data;else if(i===J){p();const g=s(Te());g&&a.push(g)}else i===Q&&y();return y(),c.length||c.push([]),c},e,t),Vt=(e,t,{clientX:n,clientY:s},o)=>{if(e.caretPositionFromPoint){const i=e.caretPositionFromPoint(n,s);if(i)return ee(t,i.offsetNode,i.offset,o)}else if(e.caretRangeFromPoint){const i=e.caretRangeFromPoint(n,s);if(i)return ee(t,i.startContainer,i.startOffset,o)}},Ft=(e,t)=>{let n=!1;const s=[],o=u=>{n&&s.push(...u)},i=new MutationObserver(u=>{o(u),n||t()}),a=()=>{o(i.takeRecords())};return i.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(u){!n&&u&&a(),n=u},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),i.disconnect()}}},zt=()=>({mount:e=>{e.ariaMultiLine=null},apply:(e,t)=>e(new q(t.ops.map(n=>n._type===2?{...n,_text:n._text.replaceAll(`
`,"")}:n._type===3?{...n,_fragment:[n._fragment.reduce((s,o)=>(je(s,o),s),[])]}:n)))}),Yt=e=>(t,n)=>{t.setData("text/plain",Ge(n,e))},qt=()=>e=>e.getData("text/plain"),qe=(e,{mod:t,shift:n=!1,alt:s=!1},o)=>i=>{if(i.key===e&&(i.ctrlKey||i.metaKey)&&n===i.shiftKey&&s===i.altKey)return o(i)},pe=()=>{},Wt=({doc:e,schema:t,singleline:n,copy:s=[Yt()],paste:o=[qt()],isBlock:i=Pt,onChange:a,onKeyDown:u,onError:f=console.error})=>{let c=rt(),p=!1,y=pe;const g=(r,h)=>{if(!t)return h("An unsafe operation was detected. We recommend using schema option."),!0;const N=t["~standard"].validate(r);if(N instanceof Promise)h("async validate is not supported.");else if(N.issues)h(N.issues.map(O=>O.message).join(`
`));else return!0;return!1};let L;if(!g(e,r=>{L=r})&&L)throw new Error(L);const C=()=>S.get()[0],S=vt([e,c]),B=[];n&&B.push(zt());const A=[qe("z",{mod:!0},()=>{if(!p){const r=S.undo();return r&&(a(r[0]),c=r[1]),!0}}),qe("z",{mod:!0,shift:!0},()=>{if(!p){const r=S.redo();return r&&(a(r[0]),c=r[1]),!0}})];u&&A.push(u);const ot=B.reduceRight((r,{apply:h})=>h?(N,O,w)=>h(ae=>r(N,O,ae),w):r,(r,h,N)=>Et(r,h,N,f)),re=[],z=r=>{p||(re.unshift(r),it(at))},oe=new Set,it=r=>{oe.has(r)||(oe.add(r),ft(()=>{oe.delete(r),r()}))},at=()=>{if(re.length){let r=C(),h=c,N;for(;N=re.pop();){const w=ot(r,h,N);w&&(!N.unsafe||g(w[0],f))&&(r=w[0],h=w[1])}const O=C();dt(r,O)||(S.set([O,c]),S.push([r,h]),a(r)),c=h}},ie={get doc(){return C()},get selection(){return c},get readonly(){return p},set readonly(r){p=r,y()},apply:(r,...h)=>(typeof r=="function"?r.call(ie,...h):z(r),ie),input:r=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return f("beforeinput event is not supported."),pe;const{contentEditable:h,role:N,ariaMultiLine:O,ariaReadOnly:w}=r,ae=r.style.whiteSpace;r.role="textbox",r.style.whiteSpace="pre-wrap",r.ariaMultiLine="true",B.forEach(({mount:l})=>{l&&l(r)});let Se=!1,ce=!1,P=null,b=!1,le=!1,W=!1;const H=tt(r),K={_document:H,_isBlock:i};y=()=>{r.contentEditable=p?"false":"true",r.ariaReadOnly=p?"true":null},y();const ct=(l,d)=>{for(const _ of s)_(l,d,r)},De=l=>{for(const d of o){const _=d(l,K);if(_)return _}f("failed to serialize pasted data")},V=Ft(r,()=>{ze(H,r,c,K)}),Y=()=>{c=Kt(r,K)},ue=()=>{const l=V._flush();if(V._record(!1),l.length){let d;for(;d=l.pop();)if(d.type==="childList"){const{target:_,removedNodes:T,addedNodes:v,nextSibling:D}=d;for(let I=T.length-1;I>=0;I--)_.insertBefore(T[I],D);for(let I=v.length-1;I>=0;I--)_.removeChild(v[I])}else d.target.nodeValue=d.oldValue;V._flush(),ce=ze(H,r,c,K)}P&&z(P),b=!1,P=null},xe=l=>{if(!b){for(const d of A)if(d(l)){l.preventDefault(),V._record(!1);return}}},me=()=>{b||ue()},Oe=l=>{l.preventDefault();const d=l.inputType;if(d.startsWith("format")||d==="historyUndo"||d==="historyRedo")return;b?V._record(!0):Y();const _=l.getTargetRanges()[0];if(_){const T=st(r,K,_);let v=d==="insertParagraph"||d==="insertLineBreak"?`
`:l.data;if(v==null){const D=l.dataTransfer;D&&(v=D.getData("text/plain"))}P||(P=new q().select(...c)),m(...T)!==0&&P.delete(...T),v&&P.insert(T[0],v)}b||ue()},we=()=>{b||Y(),b=!0},be=()=>{ue()},Re=()=>{le=!0,Y()},ke=()=>{le=!1},Ce=()=>{if(ce){ce=!1;return}le&&!b&&!W&&Y()},fe=l=>{Y(),m(...c)!==0&&ct(l,Je(C(),...U(c)))},Pe=l=>{l.preventDefault(),fe(l.clipboardData)},Ie=l=>{l.preventDefault(),p||(fe(l.clipboardData),z(new q().delete(...U(c))))},Me=l=>{l.preventDefault();const d=De(l.clipboardData);if(d){const[_,T]=U(c),v=new q().delete(_,T);he(d)?v.insert(_,d):v.insertFragment(_,d),z(v)}},Be=l=>{l.preventDefault();const d=l.dataTransfer,_=Vt(H,r,l,K);if(d&&_){const T=new q;W&&T.delete(...U(c));const v=De(d);if(v){const D=T.transform(_);T.select(D,D),he(v)?T.insert(D,v):T.insertFragment(D,v),T.select(D)}z(T),r.focus({preventScroll:!0})}},Ae=l=>{W=!0,fe(l.dataTransfer)},He=()=>{W=!1};return H.addEventListener("selectionchange",Ce),r.addEventListener("keydown",xe),r.addEventListener("input",me),r.addEventListener("beforeinput",Oe),r.addEventListener("compositionstart",we),r.addEventListener("compositionend",be),r.addEventListener("focus",Re),r.addEventListener("blur",ke),r.addEventListener("copy",Pe),r.addEventListener("cut",Ie),r.addEventListener("paste",Me),r.addEventListener("drop",Be),r.addEventListener("dragstart",Ae),r.addEventListener("dragend",He),()=>{Se||(Se=!0,y=pe,r.contentEditable=h,r.role=N,r.ariaMultiLine=O,r.ariaReadOnly=w,r.style.whiteSpace=ae,V._dispose(),H.removeEventListener("selectionchange",Ce),r.removeEventListener("keydown",xe),r.removeEventListener("input",me),r.removeEventListener("beforeinput",Oe),r.removeEventListener("compositionstart",we),r.removeEventListener("compositionend",be),r.removeEventListener("focus",Re),r.removeEventListener("blur",ke),r.removeEventListener("copy",Pe),r.removeEventListener("cut",Ie),r.removeEventListener("paste",Me),r.removeEventListener("drop",Be),r.removeEventListener("dragstart",Ae),r.removeEventListener("dragend",He))}}};return ie};export{q as T,nt as a,qt as b,Wt as c,Ge as d,Je as e,M as f,Mt as g,$e as h,wt as i,Yt as p,Gt as r,We as s,U as t};
