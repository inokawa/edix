const $=([e],[t])=>e===t?0:e<t?1:-1,m=(e,t)=>{const n=$(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},U=([e,t])=>m(e,t)===-1?[t,e]:[e,t],ct=Math.min,{keys:He,is:lt}=Object,he=e=>typeof e=="string",ut=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},qe=(e,t=n=>I(n)?n.text:"")=>e.reduce((n,s,o)=>(o!==0&&(n+=`
`),n+s.reduce((i,a)=>i+t(a),"")),""),Ge=(e,t)=>e.split(`
`).map(n=>n?[{...t,text:n}]:[]),te=1,G=2,ne=3,ve=4,se=5,We=e=>e._type!==se;class q{constructor(t){this.unsafe=!1,this._ops=t?t.slice():[]}get ops(){return this._ops}insert(t,n){return this._ops.push({_type:G,_pos:t,_text:n}),this}insertFragment(t,n){return this.unsafe=!0,this._ops.push({_type:ne,_pos:t,_fragment:n}),this}delete(t,n){return this._ops.push({_type:te,_start:t,_end:n}),this}attr(t,n,s){return this._ops.push({_type:ve,_start:t,_end:n,_attr:s}),this}select(t,n){return this._ops.push({_type:se,_anchor:t,_focus:n}),this}transform(t){return this._ops.reduce((n,s)=>We(s)?_e(n,s):n,t)}}const ft=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),I=e=>"text"in e,dt=(e,t)=>{const n=He(e);return n.length!==He(t).length?!1:n.every(s=>s in t?s==="text"||lt(e[s],t[s]):!1)},Ue=e=>I(e)?e.text.length:1,Xe=e=>e.reduce((t,n)=>t+Ue(n),0),pt=(e,t=0,n=e.length-1)=>{let s=t+1;for(;s<=n;){const o=e[s-1],i=e[s];I(o)&&I(i)&&dt(o,i)?(e[s-1]={...o,text:o.text+i.text},e.splice(s,1),n--):s++}},$e=(e,t)=>{if(t.length){const n=e.length;e.push(...t),n&&pt(e,n-1,n)}},de=(...e)=>{const t=[];return e.forEach(n=>{$e(t,n)}),t},F=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],o=Ue(s);if(o>t){const i=e.slice(0,n),a=e.slice(n+1);if(I(s)){const u=s.text.slice(0,t),f=s.text.slice(t);u&&i.push({...s,text:u}),f&&a.unshift({...s,text:f})}else a.unshift(s);return[i,a]}t-=o}return[e,[]]},X=(e,t,n,s)=>{const[o]=n,[i]=s||n,[a,u]=F(e[n[0]],n[1]),f=s?F(e[s[0]],s[1])[1]:u;if(he(t)){const y=a.length;let g;if(y){const L=a[y-1];I(L)&&(g=L)}t=Ge(t,g)}let c;t.length?(c=[...t],c[0]=de(a,c[0]),c[c.length-1]=de(c[c.length-1],f)):c=[de(a,f)];const p=e.slice();return p.splice(o,i-o+1,...c),p},je=(e,t,n)=>$(t,n)===0?[F(F(e[t[0]],n[1])[0],t[1])[1]]:[F(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),F(e[n[0]],n[1])[0]],R=(e,[t,n])=>t>=0&&t<e.length&&n>=0&&n<=Xe(e[t]),ht=(e,t)=>{switch(t._type){case te:{const{_start:n,_end:s}=t;return R(e,n)&&R(e,s)&&m(n,s)===1}case G:return R(e,t._pos)&&!!t._text;case ne:return R(e,t._pos)&&!!qe(t._fragment);case ve:{const{_start:n,_end:s}=t;return R(e,n)&&R(e,s)&&m(n,s)===1}case se:return(!t._anchor||R(e,t._anchor))&&(!t._focus||R(e,t._focus))}},_e=(e,t)=>{switch(t._type){case te:{const{_start:n,_end:s}=t;if(m(e,n)!==1)return m(s,e)===1?[e[0]+n[0]-s[0],e[1]+($(s,e)===0?n[1]-s[1]:0)]:n;break}case G:case ne:{const n=t._pos,s=t._type===G?Ge(t._text):t._fragment,o=s.length,i=o-1;if(m(e,n)!==1)return[e[0]+i,e[1]+($(e,n)===0?Xe(s[o-1])-(i===0?0:n[1]):0)];break}}return e},_t=(e,t,n,s)=>{try{for(const o of n.ops)if(ht(e,o)){switch(o._type){case te:{e=X(e,[],o._start,o._end);break}case G:{e=X(e,o._text,o._pos);break}case ne:{e=X(e,o._fragment,o._pos);break}case ve:{const{_start:i,_end:a,_attr:u}=o;e=X(e,je(e,i,a).map(f=>f.map(c=>I(c)?{...c,...u}:c)),i,a);break}case se:{(o._anchor||o._focus)&&(t=[o._anchor||t[0],o._focus||t[1]]);break}default:}We(o)&&(t=[_e(t[0],o),_e(t[1],o)])}return[e,t]}catch(o){s&&s("rollback transaction: "+o);return}},Et=500,gt=500,Tt=e=>{let t=0,n=0;const s=Date.now,o=[e],i=()=>o[t],a=()=>t>0,u=()=>t<o.length-1;return{get:i,set:f=>{o[t]=f},undo:()=>{if(a())return t--,i()},redo:()=>{if(u())return t++,i()},push:f=>{const c=s();t!==0&&c-n<gt&&t--,n=c,o[++t]=f,o.splice(t+1),t>Et&&(t--,o.shift())}}};let k,E,x,j,Ee=!1,ge=!1,Je;const vt=1,yt=4,ye=1,J=2,Z=3,Ne=4,Nt=5,Lt=6,St=1,Dt=3,xt=8,mt=e=>e.nodeType===Dt,Q=e=>e.nodeType===St,Ot=e=>e.nodeType===xt,wt=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Ze=e=>e.contentEditable==="false"||wt.has(e.tagName),Te=()=>E,Qe=()=>x===ye?E.data.length:x===J?1:0,bt=e=>{k.currentNode=k.currentNode.parentNode.children[e]},Ve=e=>{const t=e.nextSibling;return!!t&&!Ot(t)},Rt=()=>{for(;;){if(x===J){const e=E;for(;(E=k.nextNode())&&e.contains(E););}else E=k.nextNode();if(x=null,!E)break;if(j){if(j.contains(E)){if(Ee=!0,ge)break}else if(Ee)break}if(mt(E)){const e=E.data;if(e)return e===`
`?x=Ve(E)?Z:Lt:x=ye}else if(Q(E)){if(E.tagName==="BR")return x=Ve(E)?Z:Nt;if(Ze(E))return x=J;if(Je(E))return x=Ne}}},Le=(e,t,{_document:n,_isBlock:s},o)=>{try{return Je=s,k=n.createTreeWalker(t,yt|vt),o&&(o._startNode&&(k.currentNode=o._startNode,k.previousNode()),o._endNode&&(j=o._endNode),ge=o._excludeEnd||!1),e(Rt)}finally{k=E=x=j=null,Ee=ge=!1}},kt=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),Ct=e=>kt.has(e.tagName),Pt=2,et=e=>e.ownerDocument,tt=e=>et(e).getSelection(),It=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},Fe=(e,t,n)=>{const s=tt(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},ze=(e,t,[n,s],o)=>{const i=m(n,s),a=i===0,u=i===-1,f=u?s:n,c=u?n:s;if(f[0]===0&&f[1]===0&&a&&!t.hasChildNodes()){const B=e.createRange();return B.setStart(t,0),B.setEnd(t,0),Fe(t,B),!0}const p=Ye(t,f,o);if(!p)return!1;const y=a?p:Ye(t,c,o);if(!y)return!1;const g=e.createRange(),[L,C]=p,[S,M]=y;return Q(L)?C<1?g.setStartBefore(L):g.setStartAfter(L):g.setStart(L,C),Q(S)?M<1?g.setEndBefore(S):g.setEndAfter(S):g.setEnd(S,M),Fe(t,g,u),!0},Ye=(e,[t,n],s)=>Le(o=>{let i,a=!1;for(;i=o();)if(i===Ne)a||(a=!0,t!==0&&bt(t));else{const u=Qe();if(n<=u)return[Te(),n];n-=u}},e,s),Mt=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},Bt=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},ee=(e,t,n,s)=>{let o,i,a=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(Q(t)&&!Ze(t)&&t.hasChildNodes()){const f=ct(n,t.childNodes.length-1);t=t.childNodes[f],a=f===n,n=0}const u=Mt(e,t);return s._isBlock(u)?(o=u,i=Bt(o)):(o=e,i=0),Le(f=>{let c,p=0;for(;c=f();)c===Z?(i++,p=0):p+=Qe();return[i,p+n]},o,s,{_endNode:t,_excludeEnd:a})},nt=(e,t,{startOffset:n,startContainer:s,endOffset:o,endContainer:i})=>{const a=ee(e,s,n,t);return[a,s===i&&n===o?a:ee(e,i,o,t)]},st=()=>[[0,0],[0,0]],At=(e,t)=>e.compareDocumentPosition(t),Kt=(e,t)=>{const n=tt(e),s=It(n,e);if(!s)return st();const o=nt(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(At(n.anchorNode,n.focusNode)&Pt)!==0)?[o[1],o[0]]:o},qt=(e,t,n,s)=>Le(o=>{let i,a=null,u="",f=!1;const c=[],p=()=>{u&&(a||(a=[]),a.push(n(u)),u="")},y=()=>{p(),!a&&f&&(a=[]),a&&c.push(a),a=null,f=!1};for(;i=o();)if(i===Ne)y();else if(f=!0,i===ye)u+=Te().data;else if(i===J){p();const g=s(Te());g&&a.push(g)}else i===Z&&y();return y(),c.length||c.push([]),c},e,t),Ht=(e,t,{clientX:n,clientY:s},o)=>{if(e.caretPositionFromPoint){const i=e.caretPositionFromPoint(n,s);if(i)return ee(t,i.offsetNode,i.offset,o)}else if(e.caretRangeFromPoint){const i=e.caretRangeFromPoint(n,s);if(i)return ee(t,i.startContainer,i.startOffset,o)}},Vt=(e,t)=>{let n=!1;const s=[],o=u=>{n&&s.push(...u)},i=new MutationObserver(u=>{o(u),n||t()}),a=()=>{o(i.takeRecords())};return i.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(u){!n&&u&&a(),n=u},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),i.disconnect()}}},Ft=()=>({mount:e=>{e.ariaMultiLine=null},apply:(e,t)=>e(new q(t.ops.map(n=>n._type===2?{...n,_text:n._text.replaceAll(`
`,"")}:n._type===3?{...n,_fragment:[n._fragment.reduce((s,o)=>($e(s,o),s),[])]}:n)))}),zt=e=>(t,n)=>{t.setData("text/plain",qe(n,e))},Yt=()=>e=>e.getData("text/plain"),pe=()=>{},Gt=({doc:e,schema:t,singleline:n,copy:s=[zt()],paste:o=[Yt()],isBlock:i=Ct,onChange:a,onKeyDown:u,onError:f=console.error})=>{let c=st(),p=!1,y=pe;const g=(r,h)=>{if(!t)return h("An unsafe operation was detected. We recommend using schema option."),!0;const N=t["~standard"].validate(r);if(N instanceof Promise)h("async validate is not supported.");else if(N.issues)h(N.issues.map(O=>O.message).join(`
`));else return!0;return!1};let L;if(!g(e,r=>{L=r})&&L)throw new Error(L);const C=()=>S.get()[0],S=Tt([e,c]),M=[];n&&M.push(Ft());const B=[r=>{if((r.metaKey||r.ctrlKey)&&!r.altKey&&r.code==="KeyZ"&&!p){const h=r.shiftKey?S.redo():S.undo();return h&&(a(h[0]),c=h[1]),!0}}];u&&B.push(u);const rt=M.reduceRight((r,{apply:h})=>h?(N,O,w)=>h(ae=>r(N,O,ae),w):r,(r,h,N)=>_t(r,h,N,f)),re=[],z=r=>{p||(re.unshift(r),ot(it))},oe=new Set,ot=r=>{oe.has(r)||(oe.add(r),ut(()=>{oe.delete(r),r()}))},it=()=>{if(re.length){let r=C(),h=c,N;for(;N=re.pop();){const w=rt(r,h,N);w&&(!N.unsafe||g(w[0],f))&&(r=w[0],h=w[1])}const O=C();ft(r,O)||(S.set([O,c]),S.push([r,h]),a(r)),c=h}},ie={get doc(){return C()},get selection(){return c},get readonly(){return p},set readonly(r){p=r,y()},apply:(r,...h)=>(typeof r=="function"?r.call(ie,...h):z(r),ie),input:r=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return f("beforeinput event is not supported."),pe;const{contentEditable:h,role:N,ariaMultiLine:O,ariaReadOnly:w}=r,ae=r.style.whiteSpace;r.role="textbox",r.style.whiteSpace="pre-wrap",r.ariaMultiLine="true",M.forEach(({mount:l})=>{l&&l(r)});let Se=!1,ce=!1,A=null,b=!1,le=!1,W=!1;const K=et(r),H={_document:K,_isBlock:i};y=()=>{r.contentEditable=p?"false":"true",r.ariaReadOnly=p?"true":null},y();const at=(l,d)=>{for(const _ of s)_(l,d,r)},De=l=>{for(const d of o){const _=d(l,H);if(_)return _}f("failed to serialize pasted data")},V=Vt(r,()=>{ze(K,r,c,H)}),Y=()=>{c=Kt(r,H)},ue=()=>{const l=V._flush();if(V._record(!1),l.length){let d;for(;d=l.pop();)if(d.type==="childList"){const{target:_,removedNodes:T,addedNodes:v,nextSibling:D}=d;for(let P=T.length-1;P>=0;P--)_.insertBefore(T[P],D);for(let P=v.length-1;P>=0;P--)_.removeChild(v[P])}else d.target.nodeValue=d.oldValue;V._flush(),ce=ze(K,r,c,H)}z(A),b=!1,A=null},xe=l=>{if(!b){for(const d of B)if(d(l)){l.preventDefault(),V._record(!1);return}}},me=()=>{b||ue()},Oe=l=>{l.preventDefault();const d=l.inputType;if(d.startsWith("format")||d==="historyUndo"||d==="historyRedo")return;b?V._record(!0):Y();const _=l.getTargetRanges()[0];if(_){const T=nt(r,H,_);let v=d==="insertParagraph"||d==="insertLineBreak"?`
`:l.data;if(v==null){const D=l.dataTransfer;D&&(v=D.getData("text/plain"))}A||(A=new q().select(...c)),m(...T)!==0&&A.delete(...T),v&&A.insert(T[0],v)}b||ue()},we=()=>{b||Y(),b=!0},be=()=>{ue()},Re=()=>{le=!0,Y()},ke=()=>{le=!1},Ce=()=>{if(ce){ce=!1;return}le&&!b&&!W&&Y()},fe=l=>{Y(),m(...c)!==0&&at(l,je(C(),...U(c)))},Pe=l=>{l.preventDefault(),fe(l.clipboardData)},Ie=l=>{l.preventDefault(),p||(fe(l.clipboardData),z(new q().delete(...U(c))))},Me=l=>{l.preventDefault();const d=De(l.clipboardData);if(d){const[_,T]=U(c),v=new q().delete(_,T);he(d)?v.insert(_,d):v.insertFragment(_,d),z(v)}},Be=l=>{l.preventDefault();const d=l.dataTransfer,_=Ht(K,r,l,H);if(d&&_){const T=new q;W&&T.delete(...U(c));const v=De(d);if(v){const D=T.transform(_);T.select(D,D),he(v)?T.insert(D,v):T.insertFragment(D,v),T.select(D)}z(T),r.focus({preventScroll:!0})}},Ae=l=>{W=!0,fe(l.dataTransfer)},Ke=()=>{W=!1};return K.addEventListener("selectionchange",Ce),r.addEventListener("keydown",xe),r.addEventListener("input",me),r.addEventListener("beforeinput",Oe),r.addEventListener("compositionstart",we),r.addEventListener("compositionend",be),r.addEventListener("focus",Re),r.addEventListener("blur",ke),r.addEventListener("copy",Pe),r.addEventListener("cut",Ie),r.addEventListener("paste",Me),r.addEventListener("drop",Be),r.addEventListener("dragstart",Ae),r.addEventListener("dragend",Ke),()=>{Se||(Se=!0,y=pe,r.contentEditable=h,r.role=N,r.ariaMultiLine=O,r.ariaReadOnly=w,r.style.whiteSpace=ae,V._dispose(),K.removeEventListener("selectionchange",Ce),r.removeEventListener("keydown",xe),r.removeEventListener("input",me),r.removeEventListener("beforeinput",Oe),r.removeEventListener("compositionstart",we),r.removeEventListener("compositionend",be),r.removeEventListener("focus",Re),r.removeEventListener("blur",ke),r.removeEventListener("copy",Pe),r.removeEventListener("cut",Ie),r.removeEventListener("paste",Me),r.removeEventListener("drop",Be),r.removeEventListener("dragstart",Ae),r.removeEventListener("dragend",Ke))}}};return ie};export{q as T,tt as a,Yt as b,Gt as c,qe as d,je as e,I as f,It as g,Xe as h,Ot as i,zt as p,qt as r,Ge as s,U as t};
