const U=([e],[t])=>e===t?0:e<t?1:-1,m=(e,t)=>{const n=U(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},G=([e,t])=>m(e,t)===-1?[t,e]:[e,t],Ae=(e,t=n=>X(n)?n.text:"")=>e.reduce((n,s,o)=>(o!==0&&(n+=`
`),n+s.reduce((i,a)=>i+t(a),"")),""),Ee=(e,t)=>e.split(`
`).map(n=>n?[{...t,text:n}]:[]);const Ke=e=>e._type!==4;class F{constructor(t){this._ops=t?t.slice():[]}get ops(){return this._ops}insert(t,n){return this._ops.push({_type:2,_pos:t,_text:n}),this}insertFragment(t,n){return this._ops.push({_type:3,_pos:t,_fragment:n}),this}delete(t,n){return this._ops.push({_type:1,_start:t,_end:n}),this}select(t,n){return this._ops.push({_type:4,_anchor:t,_focus:n}),this}transform(t){return this._ops.reduce((n,s)=>Ke(s)?le(n,s):n,t)}}const Je=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),X=e=>"text"in e,{keys:Ce,is:Qe}=Object,et=(e,t)=>{const n=Ce(e);return n.length!==Ce(t).length?!1:n.every(s=>s in t?s==="text"||Qe(e[s],t[s]):!1)},He=e=>X(e)?e.text.length:1,tt=e=>e.reduce((t,n)=>t+He(n),0),nt=(e,t=0,n=e.length-1)=>{let s=t+1;for(;s<=n;){const o=e[s-1],i=e[s];X(o)&&X(i)&&et(o,i)?(e[s-1]={...o,text:o.text+i.text},e.splice(s,1),n--):s++}},Ve=(e,t)=>{if(t.length){const n=e.length;e.push(...t),n&&nt(e,n-1,n)}},ie=(...e)=>{const t=[];return e.forEach(n=>{Ve(t,n)}),t},Y=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],o=He(s);if(o>t){const i=e.slice(0,n),a=e.slice(n+1);if(X(s)){const l=s.text.slice(0,t),f=s.text.slice(t);l&&i.push({...s,text:l}),f&&a.unshift({...s,text:f})}else a.unshift(s);return[i,a]}t-=o}return[e,[]]},ce=(e,t,n,s)=>{const[o]=n,[i]=s||n,[a,l]=Y(e[n[0]],n[1]),f=s?Y(e[s[0]],s[1])[1]:l;if(typeof t=="string"){const h=a.length;t=Ee(t,h?a[h-1]:void 0)}let d;t.length?(d=[...t],d[0]=ie(a,d[0]),d[d.length-1]=ie(d[d.length-1],f)):d=[ie(a,f)];const u=e.slice();return u.splice(o,i-o+1,...d),u},st=(e,t,n)=>U(t,n)===0?[Y(Y(e[t[0]],n[1])[0],t[1])[1]]:[Y(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),Y(e[n[0]],n[1])[0]],rt=e=>{switch(e._type){case 1:return m(e._start,e._end)===1;case 2:return!!e._text;case 3:return!!Ae(e._fragment)}return!0},ot=(e,t)=>{switch(t._type){case 1:return ce(e,[],t._start,t._end);case 2:return ce(e,t._text,t._pos);case 3:return ce(e,t._fragment,t._pos)}return e},le=(e,t)=>{switch(t._type){case 1:{const{_start:n,_end:s}=t;if(m(e,n)!==1)return m(s,e)===1?[e[0]+n[0]-s[0],e[1]+(U(s,e)===0?n[1]-s[1]:0)]:n;break}case 2:case 3:{const n=t._pos,s=t._type===2?Ee(t._text):t._fragment,o=s.length,i=o-1;if(m(e,n)!==1)return[e[0]+i,e[1]+(U(e,n)===0?tt(s[o-1])-(i===0?0:n[1]):0)];break}}return e},it=(e,t,n,s)=>{try{for(const o of n.ops)rt(o)&&(Ke(o)?(e=ot(e,o),t=[le(t[0],o),le(t[1],o)]):(o._anchor||o._focus)&&(t=[o._anchor||t[0],o._focus||t[1]]));return[e,t]}catch(o){s&&s("rollback transaction: "+o);return}},ct=500,at=500,lt=e=>{let t=0,n=0;const s=Date.now,o=[e],i=()=>o[t],a=()=>t>0,l=()=>t<o.length-1;return{get:i,set:f=>{o[t]=f},undo:()=>{if(a())return t--,i()},redo:()=>{if(l())return t++,i()},push:f=>{const d=s();t!==0&&d-n<at&&t--,n=d,o[++t]=f,o.splice(t+1),t>ct&&(t--,o.shift())}}};let P,_,D,W,ue=!1,fe=!1,Fe;const ut=1,ft=4,pe=1,$=2,j=3,_e=4,dt=5,Et=6,pt=1,_t=3,ht=8,Tt=e=>e.nodeType===_t,Z=e=>e.nodeType===pt,gt=e=>e.nodeType===ht,Nt=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Xe=e=>e.contentEditable==="false"||Nt.has(e.tagName),de=()=>_,ze=()=>D===pe?_.data.length:D===$?1:0,vt=e=>{P.currentNode=P.currentNode.parentNode.children[e]},ke=e=>{const t=e.nextSibling;return!!t&&!gt(t)},yt=()=>{for(;;){if(D===$){const e=_;for(;(_=P.nextNode())&&e.contains(_););}else _=P.nextNode();if(D=null,!_)break;if(W){if(W.contains(_)){if(ue=!0,fe)break}else if(ue)break}if(Tt(_)){const e=_.data;if(e)return e===`
`?D=ke(_)?j:Et:D=pe}else if(Z(_)){if(_.tagName==="BR")return D=ke(_)?j:dt;if(Xe(_))return D=$;if(Fe(_))return D=_e}}},he=(e,t,{_document:n,_isBlock:s},o)=>{try{return Fe=s,P=n.createTreeWalker(t,ft|ut),o&&(o._startNode&&(P.currentNode=o._startNode,P.previousNode()),o._endNode&&(W=o._endNode),fe=o._excludeEnd||!1),e(yt)}finally{P=_=D=W=null,ue=fe=!1}},Dt=Math.min,St=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},Lt=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),xt=e=>Lt.has(e.tagName),Ot=2,qe=e=>e.ownerDocument,Ge=e=>qe(e).getSelection(),Rt=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},Me=(e,t,n)=>{const s=Ge(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},Be=(e,t,[n,s],o)=>{const i=m(n,s),a=i===0,l=i===-1,f=l?s:n,d=l?n:s;if(f[0]===0&&f[1]===0&&a&&!t.hasChildNodes()){const K=e.createRange();return K.setStart(t,0),K.setEnd(t,0),Me(t,K),!0}const u=Ye(t,f,o);if(!u)return!1;const h=a?u:Ye(t,d,o);if(!h)return!1;const N=e.createRange(),[S,x]=u,[O,A]=h;return Z(S)?x<1?N.setStartBefore(S):N.setStartAfter(S):N.setStart(S,x),Z(O)?A<1?N.setEndBefore(O):N.setEndAfter(O):N.setEnd(O,A),Me(t,N,l),!0},Ye=(e,[t,n],s)=>he(o=>{let i,a=!1;for(;i=o();)if(i===_e)a||(a=!0,t!==0&&vt(t));else{const l=ze();if(n<=l)return[de(),n];n-=l}},e,s),Pt=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},mt=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},J=(e,t,n,s)=>{let o,i,a=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(Z(t)&&!Xe(t)&&t.hasChildNodes()){const f=Dt(n,t.childNodes.length-1);t=t.childNodes[f],a=f===n,n=0}const l=Pt(e,t);return s._isBlock(l)?(o=l,i=mt(o)):(o=e,i=0),he(f=>{let d,u=0;for(;d=f();)d===j?(i++,u=0):u+=ze();return[i,u+n]},o,s,{_endNode:t,_excludeEnd:a})},Ue=(e,t,{startOffset:n,startContainer:s,endOffset:o,endContainer:i})=>{const a=J(e,s,n,t);return[a,s===i&&n===o?a:J(e,i,o,t)]},We=()=>[[0,0],[0,0]],wt=(e,t)=>e.compareDocumentPosition(t),It=(e,t)=>{const n=Ge(e),s=Rt(n,e);if(!s)return We();const o=Ue(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(wt(n.anchorNode,n.focusNode)&Ot)!==0)?[o[1],o[0]]:o},Yt=(e,t,n)=>he(s=>{let o,i=null,a="",l=!1;const f=[],d=()=>{a&&(i||(i=[]),i.push({text:a}),a="")},u=()=>{d(),!i&&l&&(i=[]),i&&f.push(i),i=null,l=!1};for(;o=s();)if(o===_e)u();else if(l=!0,o===pe)a+=de().data;else if(o===$){d();const h=n(de());h&&i.push(h)}else o===j&&u();return u(),f.length||f.push([]),f},e,t),bt=(e,t,{clientX:n,clientY:s},o)=>{if(e.caretPositionFromPoint){const i=e.caretPositionFromPoint(n,s);if(i)return J(t,i.offsetNode,i.offset,o)}else if(e.caretRangeFromPoint){const i=e.caretRangeFromPoint(n,s);if(i)return J(t,i.startContainer,i.startOffset,o)}},Ct=(e,t)=>{let n=!1;const s=[],o=l=>{n&&s.push(...l)},i=new MutationObserver(l=>{o(l),n||t()}),a=()=>{o(i.takeRecords())};return i.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(l){!n&&l&&a(),n=l},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),i.disconnect()}}},kt=()=>({mount:e=>{e.ariaMultiLine=null},apply:(e,t)=>e(new F(t.ops.map(n=>n._type===2?{...n,_text:n._text.replaceAll(`
`,"")}:n._type===3?{...n,_fragment:[n._fragment.reduce((s,o)=>(Ve(s,o),s),[])]}:n)))}),Mt=e=>(t,n)=>{t.setData("text/plain",Ae(n,e))},Bt=()=>e=>Ee(e.getData("text/plain")),ae=()=>{},At=({schema:{single:e,js:t,doc:n},doc:s,copy:o=[Mt()],paste:i=[Bt()],isBlock:a=xt,onChange:l,onKeyDown:f,onError:d=console.error})=>{let u=We(),h=!1,N=ae;const S=()=>x.get()[0],x=lt([n(s),u]),O=[];e&&O.push(kt());const A=[r=>{if((r.metaKey||r.ctrlKey)&&!r.altKey&&r.code==="KeyZ"&&!h){const p=r.shiftKey?x.redo():x.undo();return p&&(l(t(p[0])),u=p[1]),!0}}];f&&A.push(f);const K=O.reduceRight((r,{apply:p})=>p?(v,b,w)=>p(ne=>r(v,b,ne),w):r,(r,p,v)=>it(r,p,v,d)),Q=[],H=r=>{h||(Q.unshift(r),$e(je))},ee=new Set,$e=r=>{ee.has(r)||(ee.add(r),St(()=>{ee.delete(r),r()}))},je=()=>{if(Q.length){let r=S(),p=u,v;for(;v=Q.pop();){const w=K(r,p,v);w&&(r=w[0],p=w[1])}const b=S();Je(r,b)||(x.set([b,u]),x.push([r,p]),l(t(r))),u=p}},te={get doc(){return S()},get selection(){return u},get readonly(){return h},set readonly(r){h=r,N()},input:r=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return d("beforeinput event is not supported."),ae;const{contentEditable:p,role:v,ariaMultiLine:b,ariaReadOnly:w}=r,ne=r.style.whiteSpace;r.role="textbox",r.style.whiteSpace="pre-wrap",r.ariaMultiLine="true",O.forEach(({mount:c})=>{c&&c(r)});let Te=!1,se=!1,C=null,R=!1,z=!1,q=!1;const k=qe(r),M={_document:k,_isBlock:a};N=()=>{r.contentEditable=h?"false":"true",r.ariaReadOnly=h?"true":null},N();const Ze=(c,E)=>{for(const T of o)T(c,E,r)},ge=c=>{for(const E of i){const T=E(c,M);if(T)return T}d("failed to serialize pasted data")},B=Ct(r,()=>{z&&Be(k,r,u,M)}),V=()=>{u=It(r,M)},re=()=>{const c=B._flush();if(B._record(!1),c.length){let E;for(;E=c.pop();)if(E.type==="childList"){const{target:T,removedNodes:g,addedNodes:y,nextSibling:L}=E;for(let I=g.length-1;I>=0;I--)T.insertBefore(g[I],L);for(let I=y.length-1;I>=0;I--)T.removeChild(y[I])}else E.target.nodeValue=E.oldValue;B._flush(),se=Be(k,r,u,M)}H(C),R=!1,C=null},Ne=c=>{if(!R){for(const E of A)if(E(c)){c.preventDefault(),B._record(!1);return}}},ve=()=>{R||re()},ye=c=>{c.preventDefault();const E=c.inputType;if(E.startsWith("format")||E==="historyUndo"||E==="historyRedo")return;R?B._record(!0):V();const T=c.getTargetRanges()[0];if(T){const g=Ue(r,M,T);let y=E==="insertParagraph"||E==="insertLineBreak"?`
`:c.data;if(y==null){const L=c.dataTransfer;L&&(y=L.getData("text/plain"))}C||(C=new F().select(...u)),m(...g)!==0&&C.delete(...g),y&&C.insert(g[0],y)}R||re()},De=()=>{R||V(),R=!0},Se=()=>{re()},Le=()=>{z=!0,V()},xe=()=>{z=!1},Oe=()=>{if(se){se=!1;return}z&&!R&&!q&&V()},oe=c=>{V(),m(...u)!==0&&Ze(c,st(S(),...G(u)))},Re=c=>{c.preventDefault(),oe(c.clipboardData)},Pe=c=>{c.preventDefault(),h||(oe(c.clipboardData),H(new F().delete(...G(u))))},me=c=>{c.preventDefault();const E=ge(c.clipboardData);if(E){const[T,g]=G(u);H(new F().delete(T,g).insertFragment(T,E))}},we=c=>{c.preventDefault();const E=c.dataTransfer,T=bt(k,r,c,M);if(E&&T){const g=new F;q&&g.delete(...G(u));const y=ge(E);if(y){const L=g.transform(T);g.select(L,L).insertFragment(L,y).select(L)}H(g),r.focus({preventScroll:!0})}},Ie=c=>{q=!0,oe(c.dataTransfer)},be=()=>{q=!1};return k.addEventListener("selectionchange",Oe),r.addEventListener("keydown",Ne),r.addEventListener("input",ve),r.addEventListener("beforeinput",ye),r.addEventListener("compositionstart",De),r.addEventListener("compositionend",Se),r.addEventListener("focus",Le),r.addEventListener("blur",xe),r.addEventListener("copy",Re),r.addEventListener("cut",Pe),r.addEventListener("paste",me),r.addEventListener("drop",we),r.addEventListener("dragstart",Ie),r.addEventListener("dragend",be),()=>{Te||(Te=!0,N=ae,r.contentEditable=p,r.role=v,r.ariaMultiLine=b,r.ariaReadOnly=w,r.style.whiteSpace=ne,B._dispose(),k.removeEventListener("selectionchange",Oe),r.removeEventListener("keydown",Ne),r.removeEventListener("input",ve),r.removeEventListener("beforeinput",ye),r.removeEventListener("compositionstart",De),r.removeEventListener("compositionend",Se),r.removeEventListener("focus",Le),r.removeEventListener("blur",xe),r.removeEventListener("copy",Re),r.removeEventListener("cut",Pe),r.removeEventListener("paste",me),r.removeEventListener("drop",we),r.removeEventListener("dragstart",Ie),r.removeEventListener("dragend",be))}},command:(r,...p)=>{const v=r.call(te,...p);return v&&H(v),te}};return te};export{F as T,Rt as a,Ge as b,At as c,Ae as d,gt as e,Bt as f,tt as g,X as i,Mt as p,Yt as r,Ee as s,G as t};
