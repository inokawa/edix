const U=([e],[t])=>e===t?0:e<t?1:-1,m=(e,t)=>{const n=U(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},G=([e,t])=>m(e,t)===-1?[t,e]:[e,t],Ye=(e,t=n=>F(n)?n.text:"")=>e.reduce((n,s,r)=>(r!==0&&(n+=`
`),n+s.reduce((i,a)=>i+t(a),"")),""),de=(e,t)=>e.split(`
`).map(n=>n?[{...t,text:n}]:[]);const Ae=e=>e._type!==4;class V{constructor(t){this._ops=t?t.slice():[]}get ops(){return this._ops}insert(t,n){return this._ops.push({_type:2,_pos:t,_text:n}),this}insertFragment(t,n){return this._ops.push({_type:3,_pos:t,_fragment:n}),this}delete(t,n){return this._ops.push({_type:1,_start:t,_end:n}),this}select(t,n){return this._ops.push({_type:4,_anchor:t,_focus:n}),this}transform(t){return this._ops.reduce((n,s)=>Ae(s)?ae(n,s):n,t)}}const Ze=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),F=e=>"text"in e,{keys:be,is:Je}=Object,Qe=(e,t)=>{const n=be(e);return n.length!==be(t).length?!1:n.every(s=>s in t?s==="text"||Je(e[s],t[s]):!1)},Ke=e=>F(e)?e.text.length:1,et=e=>e.reduce((t,n)=>t+Ke(n),0),tt=(e,t=0,n=e.length-1)=>{let s=t+1;for(;s<=n;){const r=e[s-1],i=e[s];F(r)&&F(i)&&Qe(r,i)?(e[s-1]={...r,text:r.text+i.text},e.splice(s,1),n--):s++}},He=(e,t)=>{if(t.length){const n=e.length;e.push(...t),n&&tt(e,n-1,n)}},oe=(...e)=>{const t=[];return e.forEach(n=>{He(t,n)}),t},A=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],r=Ke(s);if(r>t){const i=e.slice(0,n),a=e.slice(n+1);if(F(s)){const l=s.text.slice(0,t),f=s.text.slice(t);l&&i.push({...s,text:l}),f&&a.unshift({...s,text:f})}else a.unshift(s);return[i,a]}t-=r}return[e,[]]},ie=(e,t,n,s)=>{const[r]=n,[i]=s||n,[a,l]=A(e[n[0]],n[1]),f=s?A(e[s[0]],s[1])[1]:l;if(typeof t=="string"){const h=a.length;t=de(t,h?a[h-1]:void 0)}let E;t.length?(E=[...t],E[0]=oe(a,E[0]),E[E.length-1]=oe(E[E.length-1],f)):E=[oe(a,f)];const u=e.slice();return u.splice(r,i-r+1,...E),u},nt=(e,t,n)=>U(t,n)===0?[A(A(e[t[0]],n[1])[0],t[1])[1]]:[A(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),A(e[n[0]],n[1])[0]],st=e=>{switch(e._type){case 1:return m(e._start,e._end)===1;case 2:return!!e._text;case 3:return!!Ye(e._fragment)}return!0},rt=(e,t)=>{switch(t._type){case 1:return ie(e,[],t._start,t._end);case 2:return ie(e,t._text,t._pos);case 3:return ie(e,t._fragment,t._pos)}return e},ae=(e,t)=>{switch(t._type){case 1:{const{_start:n,_end:s}=t;if(m(e,n)!==1)return m(s,e)===1?[e[0]+n[0]-s[0],e[1]+(U(s,e)===0?n[1]-s[1]:0)]:n;break}case 2:case 3:{const n=t._pos,s=t._type===2?de(t._text):t._fragment,r=s.length,i=r-1;if(m(e,n)!==1)return[e[0]+i,e[1]+(U(e,n)===0?et(s[r-1])-(i===0?0:n[1]):0)];break}}return e},ot=(e,t,n,s)=>{try{for(const r of n.ops)st(r)&&(Ae(r)?(e=rt(e,r),t=[ae(t[0],r),ae(t[1],r)]):(r._anchor||r._focus)&&(t=[r._anchor||t[0],r._focus||t[1]]));return[e,t]}catch(r){s&&s("rollback transaction: "+r);return}},it=500,ct=500,at=e=>{let t=0,n=0;const s=Date.now,r=[e],i=()=>r[t],a=()=>t>0,l=()=>t<r.length-1;return{get:i,set:f=>{r[t]=f},undo:()=>{if(a())return t--,i()},redo:()=>{if(l())return t++,i()},push:f=>{const E=s();t!==0&&E-n<ct&&t--,n=E,r[++t]=f,r.splice(t+1),t>it&&(t--,r.shift())}}};let P,p,D,W,le=!1,ue=!1,Ve;const lt=1,ut=4,Ee=1,$=2,j=3,pe=4,ft=5,dt=6,Et=1,pt=3,_t=8,ht=e=>e.nodeType===pt,Z=e=>e.nodeType===Et,Tt=e=>e.nodeType===_t,gt=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Fe=e=>e.contentEditable==="false"||gt.has(e.tagName),fe=()=>p,Xe=()=>D===Ee?p.data.length:D===$?1:0,Nt=e=>{P.currentNode=P.currentNode.parentNode.children[e]},Ce=e=>{const t=e.nextSibling;return!!t&&!Tt(t)},vt=()=>{for(;;){if(D===$){const e=p;for(;(p=P.nextNode())&&e.contains(p););}else p=P.nextNode();if(D=null,!p)break;if(W){if(W.contains(p)){if(le=!0,ue)break}else if(le)break}if(ht(p)){const e=p.data;if(e)return e===`
`?D=Ce(p)?j:dt:D=Ee}else if(Z(p)){if(p.tagName==="BR")return D=Ce(p)?j:ft;if(Fe(p))return D=$;if(Ve(p))return D=pe}}},_e=(e,t,{_document:n,_isBlock:s},r)=>{try{return Ve=s,P=n.createTreeWalker(t,ut|lt),r&&(r._startNode&&(P.currentNode=r._startNode,P.previousNode()),r._endNode&&(W=r._endNode),ue=r._excludeEnd||!1),e(vt)}finally{P=p=D=W=null,le=ue=!1}},yt=Math.min,Dt=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},St=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),Lt=e=>St.has(e.tagName),xt=2,ze=e=>e.ownerDocument,qe=e=>ze(e).getSelection(),Ot=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},ke=(e,t,n)=>{const s=qe(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},Me=(e,t,[n,s],r)=>{const i=m(n,s),a=i===0,l=i===-1,f=l?s:n,E=l?n:s;if(f[0]===0&&f[1]===0&&a&&!t.hasChildNodes()){const w=e.createRange();return w.setStart(t,0),w.setEnd(t,0),ke(t,w),!0}const u=Be(t,f,r);if(!u)return!1;const h=a?u:Be(t,E,r);if(!h)return!1;const N=e.createRange(),[S,x]=u,[O,X]=h;return Z(S)?x<1?N.setStartBefore(S):N.setStartAfter(S):N.setStart(S,x),Z(O)?X<1?N.setEndBefore(O):N.setEndAfter(O):N.setEnd(O,X),ke(t,N,l),!0},Be=(e,[t,n],s)=>_e(r=>{let i,a=!1;for(;i=r();)if(i===pe)a||(a=!0,t!==0&&Nt(t));else{const l=Xe();if(n<=l)return[fe(),n];n-=l}},e,s),Rt=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},Pt=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},J=(e,t,n,s)=>{let r,i,a=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(Z(t)&&!Fe(t)&&t.hasChildNodes()){const f=yt(n,t.childNodes.length-1);t=t.childNodes[f],a=f===n,n=0}const l=Rt(e,t);return s._isBlock(l)?(r=l,i=Pt(r)):(r=e,i=0),_e(f=>{let E,u=0;for(;E=f();)E===j?(i++,u=0):u+=Xe();return[i,u+n]},r,s,{_endNode:t,_excludeEnd:a})},Ge=(e,t,{startOffset:n,startContainer:s,endOffset:r,endContainer:i})=>{const a=J(e,s,n,t);return[a,s===i&&n===r?a:J(e,i,r,t)]},Ue=()=>[[0,0],[0,0]],mt=(e,t)=>e.compareDocumentPosition(t),wt=(e,t)=>{const n=qe(e),s=Ot(n,e);if(!s)return Ue();const r=Ge(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(mt(n.anchorNode,n.focusNode)&xt)!==0)?[r[1],r[0]]:r},Bt=(e,t,n)=>_e(s=>{let r,i=null,a="",l=!1;const f=[],E=()=>{a&&(i||(i=[]),i.push({text:a}),a="")},u=()=>{E(),!i&&l&&(i=[]),i&&f.push(i),i=null,l=!1};for(;r=s();)if(r===pe)u();else if(l=!0,r===Ee)a+=fe().data;else if(r===$){E();const h=n(fe());h&&i.push(h)}else r===j&&u();return u(),f.length||f.push([]),f},e,t),It=(e,t,{clientX:n,clientY:s},r)=>{if(e.caretPositionFromPoint){const i=e.caretPositionFromPoint(n,s);if(i)return J(t,i.offsetNode,i.offset,r)}else if(e.caretRangeFromPoint){const i=e.caretRangeFromPoint(n,s);if(i)return J(t,i.startContainer,i.startOffset,r)}},bt=(e,t)=>{let n=!1;const s=[],r=l=>{n&&s.push(...l)},i=new MutationObserver(l=>{r(l),n||t()}),a=()=>{r(i.takeRecords())};return i.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(l){!n&&l&&a(),n=l},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),i.disconnect()}}},Ct=()=>({mount:e=>{e.ariaMultiLine=null},apply:(e,t)=>e(new V(t.ops.map(n=>n._type===2?{...n,_text:n._text.replaceAll(`
`,"")}:n._type===3?{...n,_fragment:[n._fragment.reduce((s,r)=>(He(s,r),s),[])]}:n)))}),kt=e=>(t,n)=>{t.setData("text/plain",Ye(n,e))},Mt=()=>e=>de(e.getData("text/plain")),ce=()=>{},Yt=({schema:{single:e,js:t,doc:n},doc:s,copy:r=[kt()],paste:i=[Mt()],isBlock:a=Lt,onChange:l,onKeyDown:f,onError:E=console.error})=>{let u=Ue(),h=!1,N=ce;const S=()=>x.get()[0],x=at([n(s),u]),O=[];e&&O.push(Ct());const X=O.reduceRight((o,{apply:T})=>T?(v,C,I)=>T(te=>o(v,C,te),I):o,(o,T,v)=>ot(o,T,v,E)),w=[],K=o=>{h||(w.unshift(o),We($e))},Q=new Set,We=o=>{Q.has(o)||(Q.add(o),Dt(()=>{Q.delete(o),o()}))},$e=()=>{if(w.length){let o=S(),T=u,v;for(;v=w.pop();){const I=X(o,T,v);I&&(o=I[0],T=I[1])}const C=S();Ze(o,C)||(x.set([C,u]),x.push([o,T]),l(t(o))),u=T}},ee={get doc(){return S()},get selection(){return u},input:o=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return E("beforeinput event is not supported."),ce;const{contentEditable:T,role:v,ariaMultiLine:C,ariaReadOnly:I}=o,te=o.style.whiteSpace;o.role="textbox",o.style.whiteSpace="pre-wrap",o.ariaMultiLine="true",O.forEach(({mount:c})=>{c&&c(o)});let he=!1,ne=!1,k=null,R=!1,z=!1,q=!1;const M=ze(o),B={_document:M,_isBlock:a};N=()=>{o.contentEditable=h?"false":"true",o.ariaReadOnly=h?"true":null},N();const je=(c,d)=>{for(const _ of r)_(c,d,o)},Te=c=>{for(const d of i){const _=d(c,B);if(_)return _}E("failed to serialize pasted data")},Y=bt(o,()=>{z&&Me(M,o,u,B)}),H=()=>{u=wt(o,B)},se=()=>{const c=Y._flush();if(Y._record(!1),c.length){let d;for(;d=c.pop();)if(d.type==="childList"){const{target:_,removedNodes:g,addedNodes:y,nextSibling:L}=d;for(let b=g.length-1;b>=0;b--)_.insertBefore(g[b],L);for(let b=y.length-1;b>=0;b--)_.removeChild(y[b])}else d.target.nodeValue=d.oldValue;Y._flush(),ne=Me(M,o,u,B)}K(k),R=!1,k=null},ge=c=>{if(!R){if(f&&f(c)){c.preventDefault();return}if((c.metaKey||c.ctrlKey)&&!c.altKey&&c.code==="KeyZ"&&(c.preventDefault(),Y._record(!1),!h)){const d=c.shiftKey?x.redo():x.undo();d&&(l(t(d[0])),u=d[1])}}},Ne=()=>{R||se()},ve=c=>{c.preventDefault();const d=c.inputType;if(d.startsWith("format")||d==="historyUndo"||d==="historyRedo")return;R?Y._record(!0):H();const _=c.getTargetRanges()[0];if(_){const g=Ge(o,B,_);let y=d==="insertParagraph"||d==="insertLineBreak"?`
`:c.data;if(y==null){const L=c.dataTransfer;L&&(y=L.getData("text/plain"))}k||(k=new V().select(...u)),m(...g)!==0&&k.delete(...g),y&&k.insert(g[0],y)}R||se()},ye=()=>{R||H(),R=!0},De=()=>{se()},Se=()=>{z=!0,H()},Le=()=>{z=!1},xe=()=>{if(ne){ne=!1;return}z&&!R&&!q&&H()},re=c=>{H(),m(...u)!==0&&je(c,nt(S(),...G(u)))},Oe=c=>{c.preventDefault(),re(c.clipboardData)},Re=c=>{c.preventDefault(),h||(re(c.clipboardData),K(new V().delete(...G(u))))},Pe=c=>{c.preventDefault();const d=Te(c.clipboardData);if(d){const[_,g]=G(u);K(new V().delete(_,g).insertFragment(_,d))}},me=c=>{c.preventDefault();const d=c.dataTransfer,_=It(M,o,c,B);if(d&&_){const g=new V;q&&g.delete(...G(u));const y=Te(d);if(y){const L=g.transform(_);g.select(L,L).insertFragment(L,y).select(L)}K(g),o.focus({preventScroll:!0})}},we=c=>{q=!0,re(c.dataTransfer)},Ie=()=>{q=!1};return M.addEventListener("selectionchange",xe),o.addEventListener("keydown",ge),o.addEventListener("input",Ne),o.addEventListener("beforeinput",ve),o.addEventListener("compositionstart",ye),o.addEventListener("compositionend",De),o.addEventListener("focus",Se),o.addEventListener("blur",Le),o.addEventListener("copy",Oe),o.addEventListener("cut",Re),o.addEventListener("paste",Pe),o.addEventListener("drop",me),o.addEventListener("dragstart",we),o.addEventListener("dragend",Ie),()=>{he||(he=!0,N=ce,o.contentEditable=T,o.role=v,o.ariaMultiLine=C,o.ariaReadOnly=I,o.style.whiteSpace=te,Y._dispose(),M.removeEventListener("selectionchange",xe),o.removeEventListener("keydown",ge),o.removeEventListener("input",Ne),o.removeEventListener("beforeinput",ve),o.removeEventListener("compositionstart",ye),o.removeEventListener("compositionend",De),o.removeEventListener("focus",Se),o.removeEventListener("blur",Le),o.removeEventListener("copy",Oe),o.removeEventListener("cut",Re),o.removeEventListener("paste",Pe),o.removeEventListener("drop",me),o.removeEventListener("dragstart",we),o.removeEventListener("dragend",Ie))}},command:(o,...T)=>{const v=o.call(ee,...T);return v&&K(v),ee},readonly:o=>{h=o,N()}};return ee};export{V as T,Ot as a,qe as b,Yt as c,Ye as d,Tt as e,Mt as f,et as g,F as i,kt as p,Bt as r,de as s,G as t};
