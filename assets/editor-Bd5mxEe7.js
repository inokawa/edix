const W=([e],[t])=>e===t?0:e<t?1:-1,w=(e,t)=>{const n=W(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},U=([e,t])=>w(e,t)===-1?[t,e]:[e,t],Ke=(e,t=n=>X(n)?n.text:"")=>e.reduce((n,s,r)=>(r!==0&&(n+=`
`),n+s.reduce((i,c)=>i+t(c),"")),""),pe=(e,t)=>e.split(`
`).map(n=>n?[{...t,text:n}]:[]);const He=e=>e._type!==4;class z{constructor(t){this._ops=t?t.slice():[]}get ops(){return this._ops}insert(t,n){return this._ops.push({_type:2,_pos:t,_text:n}),this}insertFragment(t,n){return this._ops.push({_type:3,_pos:t,_fragment:n}),this}delete(t,n){return this._ops.push({_type:1,_start:t,_end:n}),this}select(t,n){return this._ops.push({_type:4,_anchor:t,_focus:n}),this}transform(t){return this._ops.reduce((n,s)=>He(s)?ue(n,s):n,t)}}const et=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),X=e=>"text"in e,{keys:ke,is:tt}=Object,nt=(e,t)=>{const n=ke(e);return n.length!==ke(t).length?!1:n.every(s=>s in t?s==="text"||tt(e[s],t[s]):!1)},Ve=e=>X(e)?e.text.length:1,Fe=e=>e.reduce((t,n)=>t+Ve(n),0),st=(e,t=0,n=e.length-1)=>{let s=t+1;for(;s<=n;){const r=e[s-1],i=e[s];X(r)&&X(i)&&nt(r,i)?(e[s-1]={...r,text:r.text+i.text},e.splice(s,1),n--):s++}},ze=(e,t)=>{if(t.length){const n=e.length;e.push(...t),n&&st(e,n-1,n)}},ae=(...e)=>{const t=[];return e.forEach(n=>{ze(t,n)}),t},A=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],r=Ve(s);if(r>t){const i=e.slice(0,n),c=e.slice(n+1);if(X(s)){const l=s.text.slice(0,t),f=s.text.slice(t);l&&i.push({...s,text:l}),f&&c.unshift({...s,text:f})}else c.unshift(s);return[i,c]}t-=r}return[e,[]]},ce=(e,t,n,s)=>{const[r]=n,[i]=s||n,[c,l]=A(e[n[0]],n[1]),f=s?A(e[s[0]],s[1])[1]:l;if(typeof t=="string"){const h=c.length;t=pe(t,h?c[h-1]:void 0)}let d;t.length?(d=[...t],d[0]=ae(c,d[0]),d[d.length-1]=ae(d[d.length-1],f)):d=[ae(c,f)];const u=e.slice();return u.splice(r,i-r+1,...d),u},rt=(e,t,n)=>W(t,n)===0?[A(A(e[t[0]],n[1])[0],t[1])[1]]:[A(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),A(e[n[0]],n[1])[0]],B=(e,[t,n])=>{if(t>=0&&t<e.length){const s=e[t],r=Fe(s);if(n>=0&&n<=r)return!0}return!1},ot=(e,t)=>{switch(t._type){case 1:{const{_start:n,_end:s}=t;return B(e,n)&&B(e,s)&&w(n,s)===1}case 2:return B(e,t._pos)&&!!t._text;case 3:return B(e,t._pos)&&!!Ke(t._fragment);case 4:return(!t._anchor||B(e,t._anchor))&&(!t._focus||B(e,t._focus))}},ue=(e,t)=>{switch(t._type){case 1:{const{_start:n,_end:s}=t;if(w(e,n)!==1)return w(s,e)===1?[e[0]+n[0]-s[0],e[1]+(W(s,e)===0?n[1]-s[1]:0)]:n;break}case 2:case 3:{const n=t._pos,s=t._type===2?pe(t._text):t._fragment,r=s.length,i=r-1;if(w(e,n)!==1)return[e[0]+i,e[1]+(W(e,n)===0?Fe(s[r-1])-(i===0?0:n[1]):0)];break}}return e},it=(e,t,n,s)=>{try{for(const r of n.ops)if(ot(e,r)){switch(r._type){case 1:{e=ce(e,[],r._start,r._end);break}case 2:{e=ce(e,r._text,r._pos);break}case 3:{e=ce(e,r._fragment,r._pos);break}case 4:{(r._anchor||r._focus)&&(t=[r._anchor||t[0],r._focus||t[1]]);break}default:}He(r)&&(t=[ue(t[0],r),ue(t[1],r)])}return[e,t]}catch(r){s&&s("rollback transaction: "+r);return}},at=500,ct=500,lt=e=>{let t=0,n=0;const s=Date.now,r=[e],i=()=>r[t],c=()=>t>0,l=()=>t<r.length-1;return{get:i,set:f=>{r[t]=f},undo:()=>{if(c())return t--,i()},redo:()=>{if(l())return t++,i()},push:f=>{const d=s();t!==0&&d-n<ct&&t--,n=d,r[++t]=f,r.splice(t+1),t>at&&(t--,r.shift())}}};let P,_,y,$,fe=!1,de=!1,Xe;const ut=1,ft=4,_e=1,j=2,Z=3,he=4,dt=5,Et=6,pt=1,_t=3,ht=8,Tt=e=>e.nodeType===_t,J=e=>e.nodeType===pt,gt=e=>e.nodeType===ht,Nt=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),qe=e=>e.contentEditable==="false"||Nt.has(e.tagName),Ee=()=>_,Ge=()=>y===_e?_.data.length:y===j?1:0,vt=e=>{P.currentNode=P.currentNode.parentNode.children[e]},Me=e=>{const t=e.nextSibling;return!!t&&!gt(t)},yt=()=>{for(;;){if(y===j){const e=_;for(;(_=P.nextNode())&&e.contains(_););}else _=P.nextNode();if(y=null,!_)break;if($){if($.contains(_)){if(fe=!0,de)break}else if(fe)break}if(Tt(_)){const e=_.data;if(e)return e===`
`?y=Me(_)?Z:Et:y=_e}else if(J(_)){if(_.tagName==="BR")return y=Me(_)?Z:dt;if(qe(_))return y=j;if(Xe(_))return y=he}}},Te=(e,t,{_document:n,_isBlock:s},r)=>{try{return Xe=s,P=n.createTreeWalker(t,ft|ut),r&&(r._startNode&&(P.currentNode=r._startNode,P.previousNode()),r._endNode&&($=r._endNode),de=r._excludeEnd||!1),e(yt)}finally{P=_=y=$=null,fe=de=!1}},St=Math.min,Dt=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},Lt=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),xt=e=>Lt.has(e.tagName),Ot=2,Ue=e=>e.ownerDocument,We=e=>Ue(e).getSelection(),Rt=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},Ye=(e,t,n)=>{const s=We(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},Be=(e,t,[n,s],r)=>{const i=w(n,s),c=i===0,l=i===-1,f=l?s:n,d=l?n:s;if(f[0]===0&&f[1]===0&&c&&!t.hasChildNodes()){const H=e.createRange();return H.setStart(t,0),H.setEnd(t,0),Ye(t,H),!0}const u=Ae(t,f,r);if(!u)return!1;const h=c?u:Ae(t,d,r);if(!h)return!1;const N=e.createRange(),[S,L]=u,[x,K]=h;return J(S)?L<1?N.setStartBefore(S):N.setStartAfter(S):N.setStart(S,L),J(x)?K<1?N.setEndBefore(x):N.setEndAfter(x):N.setEnd(x,K),Ye(t,N,l),!0},Ae=(e,[t,n],s)=>Te(r=>{let i,c=!1;for(;i=r();)if(i===he)c||(c=!0,t!==0&&vt(t));else{const l=Ge();if(n<=l)return[Ee(),n];n-=l}},e,s),Pt=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},wt=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},Q=(e,t,n,s)=>{let r,i,c=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(J(t)&&!qe(t)&&t.hasChildNodes()){const f=St(n,t.childNodes.length-1);t=t.childNodes[f],c=f===n,n=0}const l=Pt(e,t);return s._isBlock(l)?(r=l,i=wt(r)):(r=e,i=0),Te(f=>{let d,u=0;for(;d=f();)d===Z?(i++,u=0):u+=Ge();return[i,u+n]},r,s,{_endNode:t,_excludeEnd:c})},$e=(e,t,{startOffset:n,startContainer:s,endOffset:r,endContainer:i})=>{const c=Q(e,s,n,t);return[c,s===i&&n===r?c:Q(e,i,r,t)]},je=()=>[[0,0],[0,0]],bt=(e,t)=>e.compareDocumentPosition(t),mt=(e,t)=>{const n=We(e),s=Rt(n,e);if(!s)return je();const r=$e(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(bt(n.anchorNode,n.focusNode)&Ot)!==0)?[r[1],r[0]]:r},Bt=(e,t,n)=>Te(s=>{let r,i=null,c="",l=!1;const f=[],d=()=>{c&&(i||(i=[]),i.push({text:c}),c="")},u=()=>{d(),!i&&l&&(i=[]),i&&f.push(i),i=null,l=!1};for(;r=s();)if(r===he)u();else if(l=!0,r===_e)c+=Ee().data;else if(r===j){d();const h=n(Ee());h&&i.push(h)}else r===Z&&u();return u(),f.length||f.push([]),f},e,t),It=(e,t,{clientX:n,clientY:s},r)=>{if(e.caretPositionFromPoint){const i=e.caretPositionFromPoint(n,s);if(i)return Q(t,i.offsetNode,i.offset,r)}else if(e.caretRangeFromPoint){const i=e.caretRangeFromPoint(n,s);if(i)return Q(t,i.startContainer,i.startOffset,r)}},Ct=(e,t)=>{let n=!1;const s=[],r=l=>{n&&s.push(...l)},i=new MutationObserver(l=>{r(l),n||t()}),c=()=>{r(i.takeRecords())};return i.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(l){!n&&l&&c(),n=l},_flush:()=>(c(),s.splice(0)),_dispose(){s.splice(0),i.disconnect()}}},kt=()=>({mount:e=>{e.ariaMultiLine=null},apply:(e,t)=>e(new z(t.ops.map(n=>n._type===2?{...n,_text:n._text.replaceAll(`
`,"")}:n._type===3?{...n,_fragment:[n._fragment.reduce((s,r)=>(ze(s,r),s),[])]}:n)))}),Mt=e=>(t,n)=>{t.setData("text/plain",Ke(n,e))},Yt=()=>e=>pe(e.getData("text/plain")),le=()=>{},At=({schema:{single:e,js:t,doc:n},doc:s,copy:r=[Mt()],paste:i=[Yt()],isBlock:c=xt,onChange:l,onKeyDown:f,onError:d=console.error})=>{let u=je(),h=!1,N=le;const S=()=>L.get()[0],L=lt([n(s),u]),x=[];e&&x.push(kt());const K=[o=>{if((o.metaKey||o.ctrlKey)&&!o.altKey&&o.code==="KeyZ"&&!h){const p=o.shiftKey?L.redo():L.undo();return p&&(l(t(p[0])),u=p[1]),!0}}];f&&K.push(f);const H=x.reduceRight((o,{apply:p})=>p?(O,I,b)=>p(se=>o(O,I,se),b):o,(o,p,O)=>it(o,p,O,d)),ee=[],V=o=>{h||(ee.unshift(o),Ze(Je))},te=new Set,Ze=o=>{te.has(o)||(te.add(o),Dt(()=>{te.delete(o),o()}))},Je=()=>{if(ee.length){let o=S(),p=u,O;for(;O=ee.pop();){const b=H(o,p,O);b&&(o=b[0],p=b[1])}const I=S();et(o,I)||(L.set([I,u]),L.push([o,p]),l(t(o))),u=p}},ne={get doc(){return S()},get selection(){return u},get readonly(){return h},set readonly(o){h=o,N()},apply:(o,...p)=>(typeof o=="function"?o.call(ne,...p):V(o),ne),input:o=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return d("beforeinput event is not supported."),le;const{contentEditable:p,role:O,ariaMultiLine:I,ariaReadOnly:b}=o,se=o.style.whiteSpace;o.role="textbox",o.style.whiteSpace="pre-wrap",o.ariaMultiLine="true",x.forEach(({mount:a})=>{a&&a(o)});let ge=!1,re=!1,C=null,R=!1,q=!1,G=!1;const k=Ue(o),M={_document:k,_isBlock:c};N=()=>{o.contentEditable=h?"false":"true",o.ariaReadOnly=h?"true":null},N();const Qe=(a,E)=>{for(const T of r)T(a,E,o)},Ne=a=>{for(const E of i){const T=E(a,M);if(T)return T}d("failed to serialize pasted data")},Y=Ct(o,()=>{q&&Be(k,o,u,M)}),F=()=>{u=mt(o,M)},oe=()=>{const a=Y._flush();if(Y._record(!1),a.length){let E;for(;E=a.pop();)if(E.type==="childList"){const{target:T,removedNodes:g,addedNodes:v,nextSibling:D}=E;for(let m=g.length-1;m>=0;m--)T.insertBefore(g[m],D);for(let m=v.length-1;m>=0;m--)T.removeChild(v[m])}else E.target.nodeValue=E.oldValue;Y._flush(),re=Be(k,o,u,M)}V(C),R=!1,C=null},ve=a=>{if(!R){for(const E of K)if(E(a)){a.preventDefault(),Y._record(!1);return}}},ye=()=>{R||oe()},Se=a=>{a.preventDefault();const E=a.inputType;if(E.startsWith("format")||E==="historyUndo"||E==="historyRedo")return;R?Y._record(!0):F();const T=a.getTargetRanges()[0];if(T){const g=$e(o,M,T);let v=E==="insertParagraph"||E==="insertLineBreak"?`
`:a.data;if(v==null){const D=a.dataTransfer;D&&(v=D.getData("text/plain"))}C||(C=new z().select(...u)),w(...g)!==0&&C.delete(...g),v&&C.insert(g[0],v)}R||oe()},De=()=>{R||F(),R=!0},Le=()=>{oe()},xe=()=>{q=!0,F()},Oe=()=>{q=!1},Re=()=>{if(re){re=!1;return}q&&!R&&!G&&F()},ie=a=>{F(),w(...u)!==0&&Qe(a,rt(S(),...U(u)))},Pe=a=>{a.preventDefault(),ie(a.clipboardData)},we=a=>{a.preventDefault(),h||(ie(a.clipboardData),V(new z().delete(...U(u))))},be=a=>{a.preventDefault();const E=Ne(a.clipboardData);if(E){const[T,g]=U(u);V(new z().delete(T,g).insertFragment(T,E))}},me=a=>{a.preventDefault();const E=a.dataTransfer,T=It(k,o,a,M);if(E&&T){const g=new z;G&&g.delete(...U(u));const v=Ne(E);if(v){const D=g.transform(T);g.select(D,D).insertFragment(D,v).select(D)}V(g),o.focus({preventScroll:!0})}},Ie=a=>{G=!0,ie(a.dataTransfer)},Ce=()=>{G=!1};return k.addEventListener("selectionchange",Re),o.addEventListener("keydown",ve),o.addEventListener("input",ye),o.addEventListener("beforeinput",Se),o.addEventListener("compositionstart",De),o.addEventListener("compositionend",Le),o.addEventListener("focus",xe),o.addEventListener("blur",Oe),o.addEventListener("copy",Pe),o.addEventListener("cut",we),o.addEventListener("paste",be),o.addEventListener("drop",me),o.addEventListener("dragstart",Ie),o.addEventListener("dragend",Ce),()=>{ge||(ge=!0,N=le,o.contentEditable=p,o.role=O,o.ariaMultiLine=I,o.ariaReadOnly=b,o.style.whiteSpace=se,Y._dispose(),k.removeEventListener("selectionchange",Re),o.removeEventListener("keydown",ve),o.removeEventListener("input",ye),o.removeEventListener("beforeinput",Se),o.removeEventListener("compositionstart",De),o.removeEventListener("compositionend",Le),o.removeEventListener("focus",xe),o.removeEventListener("blur",Oe),o.removeEventListener("copy",Pe),o.removeEventListener("cut",we),o.removeEventListener("paste",be),o.removeEventListener("drop",me),o.removeEventListener("dragstart",Ie),o.removeEventListener("dragend",Ce))}}};return ne};export{z as T,Rt as a,We as b,At as c,Ke as d,gt as e,Yt as f,Fe as g,X as i,Mt as p,Bt as r,pe as s,U as t};
