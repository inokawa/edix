const $=([e],[t])=>e===t?0:e<t?1:-1,R=(e,t)=>{const n=$(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},X=([e,t])=>R(e,t)===-1?[t,e]:[e,t],it=Math.min,{keys:Ke,is:at}=Object,he=e=>typeof e=="string",ct=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},qe=(e,t=n=>F(n)?n.text:"")=>e.reduce((n,s,o)=>(o!==0&&(n+=`
`),n+s.reduce((i,a)=>i+t(a),"")),""),Ge=(e,t)=>e.split(`
`).map(n=>n?[{...t,text:n}]:[]),te=1,W=2,ne=3,se=4,We=e=>e._type!==se;class G{constructor(t){this.unsafe=!1,this._ops=t?t.slice():[]}get ops(){return this._ops}insert(t,n){return this._ops.push({_type:W,_pos:t,_text:n}),this}insertFragment(t,n){return this.unsafe=!0,this._ops.push({_type:ne,_pos:t,_fragment:n}),this}delete(t,n){return this._ops.push({_type:te,_start:t,_end:n}),this}select(t,n){return this._ops.push({_type:se,_anchor:t,_focus:n}),this}transform(t){return this._ops.reduce((n,s)=>We(s)?ge(n,s):n,t)}}const lt=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),F=e=>"text"in e,ut=(e,t)=>{const n=Ke(e);return n.length!==Ke(t).length?!1:n.every(s=>s in t?s==="text"||at(e[s],t[s]):!1)},Ye=e=>F(e)?e.text.length:1,Ue=e=>e.reduce((t,n)=>t+Ye(n),0),ft=(e,t=0,n=e.length-1)=>{let s=t+1;for(;s<=n;){const o=e[s-1],i=e[s];F(o)&&F(i)&&ut(o,i)?(e[s-1]={...o,text:o.text+i.text},e.splice(s,1),n--):s++}},Xe=(e,t)=>{if(t.length){const n=e.length;e.push(...t),n&&ft(e,n-1,n)}},fe=(...e)=>{const t=[];return e.forEach(n=>{Xe(t,n)}),t},V=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],o=Ye(s);if(o>t){const i=e.slice(0,n),a=e.slice(n+1);if(F(s)){const u=s.text.slice(0,t),f=s.text.slice(t);u&&i.push({...s,text:u}),f&&a.unshift({...s,text:f})}else a.unshift(s);return[i,a]}t-=o}return[e,[]]},de=(e,t,n,s)=>{const[o]=n,[i]=s||n,[a,u]=V(e[n[0]],n[1]),f=s?V(e[s[0]],s[1])[1]:u;if(he(t)){const N=a.length;let _;if(N){const L=a[N-1];F(L)&&(_=L)}t=Ge(t,_)}let c;t.length?(c=[...t],c[0]=fe(a,c[0]),c[c.length-1]=fe(c[c.length-1],f)):c=[fe(a,f)];const p=e.slice();return p.splice(o,i-o+1,...c),p},dt=(e,t,n)=>$(t,n)===0?[V(V(e[t[0]],n[1])[0],t[1])[1]]:[V(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),V(e[n[0]],n[1])[0]],H=(e,[t,n])=>t>=0&&t<e.length&&n>=0&&n<=Ue(e[t]),pt=(e,t)=>{switch(t._type){case te:{const{_start:n,_end:s}=t;return H(e,n)&&H(e,s)&&R(n,s)===1}case W:return H(e,t._pos)&&!!t._text;case ne:return H(e,t._pos)&&!!qe(t._fragment);case se:return(!t._anchor||H(e,t._anchor))&&(!t._focus||H(e,t._focus))}},ge=(e,t)=>{switch(t._type){case te:{const{_start:n,_end:s}=t;if(R(e,n)!==1)return R(s,e)===1?[e[0]+n[0]-s[0],e[1]+($(s,e)===0?n[1]-s[1]:0)]:n;break}case W:case ne:{const n=t._pos,s=t._type===W?Ge(t._text):t._fragment,o=s.length,i=o-1;if(R(e,n)!==1)return[e[0]+i,e[1]+($(e,n)===0?Ue(s[o-1])-(i===0?0:n[1]):0)];break}}return e},ht=(e,t,n,s)=>{try{for(const o of n.ops)if(pt(e,o)){switch(o._type){case te:{e=de(e,[],o._start,o._end);break}case W:{e=de(e,o._text,o._pos);break}case ne:{e=de(e,o._fragment,o._pos);break}case se:{(o._anchor||o._focus)&&(t=[o._anchor||t[0],o._focus||t[1]]);break}default:}We(o)&&(t=[ge(t[0],o),ge(t[1],o)])}return[e,t]}catch(o){s&&s("rollback transaction: "+o);return}},gt=500,Et=500,_t=e=>{let t=0,n=0;const s=Date.now,o=[e],i=()=>o[t],a=()=>t>0,u=()=>t<o.length-1;return{get:i,set:f=>{o[t]=f},undo:()=>{if(a())return t--,i()},redo:()=>{if(u())return t++,i()},push:f=>{const c=s();t!==0&&c-n<Et&&t--,n=c,o[++t]=f,o.splice(t+1),t>gt&&(t--,o.shift())}}};let b,E,x,j,Ee=!1,_e=!1,$e;const vt=1,Tt=4,Te=1,J=2,Z=3,Ne=4,Nt=5,yt=6,Lt=1,Dt=3,St=8,xt=e=>e.nodeType===Dt,Q=e=>e.nodeType===Lt,mt=e=>e.nodeType===St,Ot=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),je=e=>e.contentEditable==="false"||Ot.has(e.tagName),ve=()=>E,Je=()=>x===Te?E.data.length:x===J?1:0,wt=e=>{b.currentNode=b.currentNode.parentNode.children[e]},He=e=>{const t=e.nextSibling;return!!t&&!mt(t)},bt=()=>{for(;;){if(x===J){const e=E;for(;(E=b.nextNode())&&e.contains(E););}else E=b.nextNode();if(x=null,!E)break;if(j){if(j.contains(E)){if(Ee=!0,_e)break}else if(Ee)break}if(xt(E)){const e=E.data;if(e)return e===`
`?x=He(E)?Z:yt:x=Te}else if(Q(E)){if(E.tagName==="BR")return x=He(E)?Z:Nt;if(je(E))return x=J;if($e(E))return x=Ne}}},ye=(e,t,{_document:n,_isBlock:s},o)=>{try{return $e=s,b=n.createTreeWalker(t,Tt|vt),o&&(o._startNode&&(b.currentNode=o._startNode,b.previousNode()),o._endNode&&(j=o._endNode),_e=o._excludeEnd||!1),e(bt)}finally{b=E=x=j=null,Ee=_e=!1}},Rt=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),kt=e=>Rt.has(e.tagName),Ct=2,Ze=e=>e.ownerDocument,Qe=e=>Ze(e).getSelection(),Pt=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},Ve=(e,t,n)=>{const s=Qe(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},Fe=(e,t,[n,s],o)=>{const i=R(n,s),a=i===0,u=i===-1,f=u?s:n,c=u?n:s;if(f[0]===0&&f[1]===0&&a&&!t.hasChildNodes()){const I=e.createRange();return I.setStart(t,0),I.setEnd(t,0),Ve(t,I),!0}const p=ze(t,f,o);if(!p)return!1;const N=a?p:ze(t,c,o);if(!N)return!1;const _=e.createRange(),[L,k]=p,[D,P]=N;return Q(L)?k<1?_.setStartBefore(L):_.setStartAfter(L):_.setStart(L,k),Q(D)?P<1?_.setEndBefore(D):_.setEndAfter(D):_.setEnd(D,P),Ve(t,_,u),!0},ze=(e,[t,n],s)=>ye(o=>{let i,a=!1;for(;i=o();)if(i===Ne)a||(a=!0,t!==0&&wt(t));else{const u=Je();if(n<=u)return[ve(),n];n-=u}},e,s),It=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},Mt=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},ee=(e,t,n,s)=>{let o,i,a=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(Q(t)&&!je(t)&&t.hasChildNodes()){const f=it(n,t.childNodes.length-1);t=t.childNodes[f],a=f===n,n=0}const u=It(e,t);return s._isBlock(u)?(o=u,i=Mt(o)):(o=e,i=0),ye(f=>{let c,p=0;for(;c=f();)c===Z?(i++,p=0):p+=Je();return[i,p+n]},o,s,{_endNode:t,_excludeEnd:a})},et=(e,t,{startOffset:n,startContainer:s,endOffset:o,endContainer:i})=>{const a=ee(e,s,n,t);return[a,s===i&&n===o?a:ee(e,i,o,t)]},tt=()=>[[0,0],[0,0]],Bt=(e,t)=>e.compareDocumentPosition(t),At=(e,t)=>{const n=Qe(e),s=Pt(n,e);if(!s)return tt();const o=et(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(Bt(n.anchorNode,n.focusNode)&Ct)!==0)?[o[1],o[0]]:o},qt=(e,t,n,s)=>ye(o=>{let i,a=null,u="",f=!1;const c=[],p=()=>{u&&(a||(a=[]),a.push(n(u)),u="")},N=()=>{p(),!a&&f&&(a=[]),a&&c.push(a),a=null,f=!1};for(;i=o();)if(i===Ne)N();else if(f=!0,i===Te)u+=ve().data;else if(i===J){p();const _=s(ve());_&&a.push(_)}else i===Z&&N();return N(),c.length||c.push([]),c},e,t),Kt=(e,t,{clientX:n,clientY:s},o)=>{if(e.caretPositionFromPoint){const i=e.caretPositionFromPoint(n,s);if(i)return ee(t,i.offsetNode,i.offset,o)}else if(e.caretRangeFromPoint){const i=e.caretRangeFromPoint(n,s);if(i)return ee(t,i.startContainer,i.startOffset,o)}},Ht=(e,t)=>{let n=!1;const s=[],o=u=>{n&&s.push(...u)},i=new MutationObserver(u=>{o(u),n||t()}),a=()=>{o(i.takeRecords())};return i.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(u){!n&&u&&a(),n=u},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),i.disconnect()}}},Vt=()=>({mount:e=>{e.ariaMultiLine=null},apply:(e,t)=>e(new G(t.ops.map(n=>n._type===2?{...n,_text:n._text.replaceAll(`
`,"")}:n._type===3?{...n,_fragment:[n._fragment.reduce((s,o)=>(Xe(s,o),s),[])]}:n)))}),Ft=e=>(t,n)=>{t.setData("text/plain",qe(n,e))},zt=()=>e=>e.getData("text/plain"),pe=()=>{},Gt=({doc:e,schema:t,singleline:n,copy:s=[Ft()],paste:o=[zt()],isBlock:i=kt,onChange:a,onKeyDown:u,onError:f=console.error})=>{let c=tt(),p=!1,N=pe;const _=(r,h)=>{if(!t)return h("An unsafe operation was detected. We recommened using schema option."),!0;const y=t["~standard"].validate(r);if(y instanceof Promise)h("async validate is not supported.");else if(y.issues)h(y.issues.map(m=>m.message).join(`
`));else return!0;return!1};let L;if(!_(e,r=>{L=r})&&L)throw new Error(L);const k=()=>D.get()[0],D=_t([e,c]),P=[];n&&P.push(Vt());const I=[r=>{if((r.metaKey||r.ctrlKey)&&!r.altKey&&r.code==="KeyZ"&&!p){const h=r.shiftKey?D.redo():D.undo();return h&&(a(h[0]),c=h[1]),!0}}];u&&I.push(u);const nt=P.reduceRight((r,{apply:h})=>h?(y,m,O)=>h(ae=>r(y,m,ae),O):r,(r,h,y)=>ht(r,h,y,f)),re=[],z=r=>{p||(re.unshift(r),st(rt))},oe=new Set,st=r=>{oe.has(r)||(oe.add(r),ct(()=>{oe.delete(r),r()}))},rt=()=>{if(re.length){let r=k(),h=c,y;for(;y=re.pop();){const O=nt(r,h,y);O&&(!y.unsafe||_(O[0],f))&&(r=O[0],h=O[1])}const m=k();lt(r,m)||(D.set([m,c]),D.push([r,h]),a(r)),c=h}},ie={get doc(){return k()},get selection(){return c},get readonly(){return p},set readonly(r){p=r,N()},apply:(r,...h)=>(typeof r=="function"?r.call(ie,...h):z(r),ie),input:r=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return f("beforeinput event is not supported."),pe;const{contentEditable:h,role:y,ariaMultiLine:m,ariaReadOnly:O}=r,ae=r.style.whiteSpace;r.role="textbox",r.style.whiteSpace="pre-wrap",r.ariaMultiLine="true",P.forEach(({mount:l})=>{l&&l(r)});let Le=!1,ce=!1,M=null,w=!1,Y=!1,U=!1;const B=Ze(r),A={_document:B,_isBlock:i};N=()=>{r.contentEditable=p?"false":"true",r.ariaReadOnly=p?"true":null},N();const ot=(l,d)=>{for(const g of s)g(l,d,r)},De=l=>{for(const d of o){const g=d(l,A);if(g)return g}f("failed to serialize pasted data")},K=Ht(r,()=>{Y&&Fe(B,r,c,A)}),q=()=>{c=At(r,A)},le=()=>{const l=K._flush();if(K._record(!1),l.length){let d;for(;d=l.pop();)if(d.type==="childList"){const{target:g,removedNodes:v,addedNodes:T,nextSibling:S}=d;for(let C=v.length-1;C>=0;C--)g.insertBefore(v[C],S);for(let C=T.length-1;C>=0;C--)g.removeChild(T[C])}else d.target.nodeValue=d.oldValue;K._flush(),ce=Fe(B,r,c,A)}z(M),w=!1,M=null},Se=l=>{if(!w){for(const d of I)if(d(l)){l.preventDefault(),K._record(!1);return}}},xe=()=>{w||le()},me=l=>{l.preventDefault();const d=l.inputType;if(d.startsWith("format")||d==="historyUndo"||d==="historyRedo")return;w?K._record(!0):q();const g=l.getTargetRanges()[0];if(g){const v=et(r,A,g);let T=d==="insertParagraph"||d==="insertLineBreak"?`
`:l.data;if(T==null){const S=l.dataTransfer;S&&(T=S.getData("text/plain"))}M||(M=new G().select(...c)),R(...v)!==0&&M.delete(...v),T&&M.insert(v[0],T)}w||le()},Oe=()=>{w||q(),w=!0},we=()=>{le()},be=()=>{Y=!0,q()},Re=()=>{Y=!1},ke=()=>{if(ce){ce=!1;return}Y&&!w&&!U&&q()},ue=l=>{q(),R(...c)!==0&&ot(l,dt(k(),...X(c)))},Ce=l=>{l.preventDefault(),ue(l.clipboardData)},Pe=l=>{l.preventDefault(),p||(ue(l.clipboardData),z(new G().delete(...X(c))))},Ie=l=>{l.preventDefault();const d=De(l.clipboardData);if(d){const[g,v]=X(c),T=new G().delete(g,v);he(d)?T.insert(g,d):T.insertFragment(g,d),z(T)}},Me=l=>{l.preventDefault();const d=l.dataTransfer,g=Kt(B,r,l,A);if(d&&g){const v=new G;U&&v.delete(...X(c));const T=De(d);if(T){const S=v.transform(g);v.select(S,S),he(T)?v.insert(S,T):v.insertFragment(S,T),v.select(S)}z(v),r.focus({preventScroll:!0})}},Be=l=>{U=!0,ue(l.dataTransfer)},Ae=()=>{U=!1};return B.addEventListener("selectionchange",ke),r.addEventListener("keydown",Se),r.addEventListener("input",xe),r.addEventListener("beforeinput",me),r.addEventListener("compositionstart",Oe),r.addEventListener("compositionend",we),r.addEventListener("focus",be),r.addEventListener("blur",Re),r.addEventListener("copy",Ce),r.addEventListener("cut",Pe),r.addEventListener("paste",Ie),r.addEventListener("drop",Me),r.addEventListener("dragstart",Be),r.addEventListener("dragend",Ae),()=>{Le||(Le=!0,N=pe,r.contentEditable=h,r.role=y,r.ariaMultiLine=m,r.ariaReadOnly=O,r.style.whiteSpace=ae,K._dispose(),B.removeEventListener("selectionchange",ke),r.removeEventListener("keydown",Se),r.removeEventListener("input",xe),r.removeEventListener("beforeinput",me),r.removeEventListener("compositionstart",Oe),r.removeEventListener("compositionend",we),r.removeEventListener("focus",be),r.removeEventListener("blur",Re),r.removeEventListener("copy",Ce),r.removeEventListener("cut",Pe),r.removeEventListener("paste",Ie),r.removeEventListener("drop",Me),r.removeEventListener("dragstart",Be),r.removeEventListener("dragend",Ae))}}};return ie};export{G as T,Pt as a,Qe as b,Gt as c,qe as d,zt as e,Ue as g,mt as i,Ft as p,qt as r,Ge as s,X as t};
