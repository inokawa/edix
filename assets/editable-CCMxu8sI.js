const U=([e],[t])=>e===t?0:e<t?1:-1,m=(e,t)=>{const n=U(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},z=([e,t])=>m(e,t)===-1?[t,e]:[e,t],ze=(e,t)=>e.reduce((n,s,i)=>(i!==0&&(n+=`
`),n+s.reduce((r,c)=>r+(H(c)?c.text:t?t(c):""),"")),""),Ge=e=>e.split(`
`).map(t=>t?[{text:t}]:[]);const ke=e=>e._type!==3;class w extends Array{static from(t){return new w(...t)}insert(t,n){return this.push({_type:2,_pos:t,_fragment:n}),this}delete(t,n){return this.push({_type:1,_start:t,_end:n}),this}select(t,n){return this.push({_type:3,_anchor:t,_focus:n}),this}rebasePos(t){return this.reduce((n,s)=>ke(s)?se(n,s):n,t)}}const Ue=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),H=e=>"text"in e,Ie=e=>H(e)?e.text.length:1,We=e=>e.reduce((t,n)=>t+Ie(n),0),G=(e,t)=>{const n=[...e];if(!n.length)n.push(...t);else for(const s of t){const i=n.length-1,r=n[i];H(s)&&H(r)?n[i]={text:r.text+s.text}:n.push(s)}return n},I=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],i=Ie(s);if(i>t){const r=e.slice(0,n),c=e.slice(n+1);if(H(s)){const a=s.text.slice(0,t),u=s.text.slice(t);a&&r.push({text:a}),u&&c.unshift({text:u})}else c.unshift(s);return[r,c]}t-=i}return[e,[]]},be=(e,t,n,s)=>{const[i]=n,[r]=s||n,c=I(e[n[0]],n[1]),a=c[0],u=s?I(e[s[0]],s[1])[1]:c[1],d=[...t];d.length?(d[0]=G(a,d[0]),d[d.length-1]=G(d[d.length-1],u)):d.push(G(a,u)),e.splice(i,r-i+1,...d)},Xe=(e,t,n)=>U(t,n)===0?[I(I(e[t[0]],n[1])[0],t[1])[1]]:[I(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),I(e[n[0]],n[1])[0]],$e=e=>{switch(e._type){case 1:return m(e._start,e._end)===1;case 2:return!!ze(e._fragment)}return!0},je=(e,t)=>{switch(t._type){case 1:{be(e,[],t._start,t._end);break}case 2:{be(e,t._fragment,t._pos);break}}},se=(e,t)=>{switch(t._type){case 1:{const{_start:n,_end:s}=t;if(m(e,n)!==1)return m(s,e)===1?[e[0]+n[0]-s[0],e[1]+(U(s,e)===0?n[1]-s[1]:0)]:n;break}case 2:{const{_pos:n,_fragment:s}=t,i=s.length,r=i-1;if(m(e,n)!==1)return[e[0]+r,e[1]+(U(e,n)===0?We(s[i-1])-(r===0?0:n[1]):0)];break}}return e},Qe=(e,t,n)=>{const s=[...e],i=[...t];try{for(const r of n)$e(r)&&(ke(r)?(je(e,r),t[0]=se(t[0],r),t[1]=se(t[1],r)):(r._anchor&&(t[0]=r._anchor),r._focus&&(t[1]=r._focus)))}catch(r){console.error("rollback transaction:",r),e.length=0,e.push(...s),t[0]=i[0],t[1]=i[1]}},Ze=500,Je=500,et=e=>{let t=0,n=0;const s=Date.now,i=[e],r=()=>i[t],c=h=>{i[t]=h},a=h=>{const T=s();t!==0&&T-n<Je&&t--,n=T,i[++t]=h,i.splice(t+1),t>Ze&&(t--,i.shift())},u=()=>t>0,d=()=>t<i.length-1;return{get:r,set:c,undo:()=>{if(u())return t--,r()},redo:()=>{if(d())return t++,r()},push:a}};let O,p,v,W,re=!1,oe=!1,Me;const tt=1,nt=4,ce=1,X=2,$=3,ae=4,st=5,rt=6,ot=1,it=3,ct=8,at=e=>e.nodeType===it,j=e=>e.nodeType===ot,lt=e=>e.nodeType===ct,ut=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Be=e=>e.contentEditable==="false"||ut.has(e.tagName),ie=()=>p,Ae=()=>v===ce?p.data.length:v===X?1:0,dt=e=>{O.currentNode=O.currentNode.parentNode.children[e]},we=e=>{const t=e.nextSibling;return!!t&&!lt(t)},ft=()=>{for(;;){if(v===X){const e=p;for(;(p=O.nextNode())&&e.contains(p););}else p=O.nextNode();if(v=null,!p)break;if(W){if(W.contains(p)){if(re=!0,oe)break}else if(re)break}if(at(p)){const e=p.data;if(e)return e===`
`?v=we(p)?$:rt:v=ce}else if(j(p)){if(p.tagName==="BR")return v=we(p)?$:st;if(Be(p))return v=X;if(Me(p))return v=ae}}},le=(e,t,{_document:n,_isBlock:s},i)=>{try{return Me=s,O=n.createTreeWalker(t,nt|tt),i&&(i._startNode&&(O.currentNode=i._startNode,O.previousNode()),i._endNode&&(W=i._endNode),oe=i._excludeEnd||!1),e(ft)}finally{O=p=v=W=null,re=oe=!1}},Et=Math.min,pt=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},ht=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),Tt=e=>ht.has(e.tagName),gt=2,He=e=>e.ownerDocument,ue=e=>He(e).getSelection(),Ke=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},Pe=(e,t,n)=>{const s=ue(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},ne=(e,t,[n,s],i)=>{const r=m(n,s),c=r===0,a=r===-1,u=a?s:n,d=a?n:s;if(u[0]===0&&u[1]===0&&c&&!t.hasChildNodes()){const f=e.createRange();return f.setStart(t,0),f.setEnd(t,0),Pe(t,f),!0}const _=Ce(t,u,i);if(!_)return!1;const y=c?_:Ce(t,d,i);if(!y)return!1;const h=e.createRange(),[T,D]=_,[x,P]=y;return j(T)?D<1?h.setStartBefore(T):h.setStartAfter(T):h.setStart(T,D),j(x)?P<1?h.setEndBefore(x):h.setEndAfter(x):h.setEnd(x,P),Pe(t,h,a),!0},Ce=(e,[t,n],s)=>le(i=>{let r,c=!1;for(;r=i();)if(r===ae)c||(c=!0,t!==0&&dt(t));else{const a=Ae();if(n<=a)return[ie(),n];n-=a}},e,s),_t=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},Nt=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},Q=(e,t,n,s)=>{let i,r,c=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(j(t)&&!Be(t)&&t.hasChildNodes()){const u=Et(n,t.childNodes.length-1);t=t.childNodes[u],c=u===n,n=0}const a=_t(e,t);return s._isBlock(a)?(i=a,r=Nt(i)):(i=e,r=0),le(u=>{let d,_=0;for(;d=u();)d===$?(r++,_=0):_+=Ae();return[r,_+n]},i,s,{_endNode:t,_excludeEnd:c})},Ye=(e,t,{startOffset:n,startContainer:s,endOffset:i,endContainer:r})=>{const c=Q(e,s,n,t);return[c,s===r&&n===i?c:Q(e,r,i,t)]},Ve=()=>[[0,0],[0,0]],vt=(e,t)=>e.compareDocumentPosition(t),yt=(e,t)=>{const n=ue(e),s=Ke(n,e);if(!s)return Ve();const i=Ye(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(vt(n.anchorNode,n.focusNode)&gt)!==0)?[i[1],i[0]]:i},Dt=(e,t,n,s)=>le(i=>{let r,c=null,a="",u=!1;const d=[],_=()=>{a&&(c||(c=[]),c.push({text:a}),a="")},y=()=>{_(),!c&&u&&(c=[]),c&&d.push(c),c=null,u=!1};for(;r=i();)if(r===ae)y();else if(u=!0,r===ce){let T=ie().data;a+=T}else if(r===X){_();const h=ie(),T=n(h);T&&c.push({data:T})}else r===$&&y();return y(),d.length||d.push([]),d},e,t,s),Lt=(e,t,{clientX:n,clientY:s},i)=>{if(e.caretPositionFromPoint){const r=e.caretPositionFromPoint(n,s);if(r)return Q(t,r.offsetNode,r.offset,i)}else if(e.caretRangeFromPoint){const r=e.caretRangeFromPoint(n,s);if(r)return Q(t,r.startContainer,r.startOffset,i)}},St=(e,t)=>{let n=!1;const s=[],i=a=>{n&&s.push(...a)},r=new MutationObserver(a=>{i(a),n||t()}),c=()=>{i(r.takeRecords())};return r.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(a){!n&&a&&c(),n=a},_flush:()=>(c(),s.splice(0)),_dispose(){s.splice(0),r.disconnect()}}},Ot=e=>w.from(e.map(t=>t._type===2?{...t,_fragment:[t._fragment.reduce((n,s)=>G(n,s),[])]}:t)),mt=(e,{schema:{single:t,js:n,void:s,copy:i,paste:r},isBlock:c=Tt,onChange:a,onKeyDown:u})=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function")){console.error("beforeinput event is not supported.");const o=()=>{};return{dispose:o,command:o,readonly:o}}const{contentEditable:d,role:_,ariaMultiLine:y,ariaReadOnly:h}=e,T=e.style.whiteSpace;e.role="textbox",e.style.whiteSpace="pre-wrap",t||(e.ariaMultiLine="true");let D=!1,x=!1,P=!1,f=Ve(),C=null,K=null,L=!1,Y=!1,V=!1;const R=He(e),S={_document:R,_isBlock:c},de=()=>{e.contentEditable=D?"false":"true",e.ariaReadOnly=D?"true":null};de();const fe=(o,l)=>Dt(o,l,s),F=()=>B.get()[0],Z=[],M=o=>{D||(Z.unshift(o),Fe(qe))},B=et([fe(e,S),f]),k=St(e,()=>{Y&&(ne(R,e,f,S),K!=null&&(clearTimeout(K),K=null))}),J=new Set,Fe=o=>{J.has(o)||(J.add(o),pt(()=>{J.delete(o),o()}))},Ee=o=>{f=o,K=setTimeout(()=>{ne(R,e,o,S)})},A=()=>{f=yt(e,S)},ee=()=>{const o=k._flush();if(k._record(!1),o.length){let l;for(;l=o.pop();)if(l.type==="childList"){const{target:E,removedNodes:g,addedNodes:N,nextSibling:q}=l;for(let b=g.length-1;b>=0;b--)E.insertBefore(g[b],q);for(let b=N.length-1;b>=0;b--)E.removeChild(N[b])}else l.target.nodeValue=l.oldValue;k._flush()}M(C),L=!1,C=null,P=ne(R,e,f,S)},qe=()=>{if(Z.length){let o=[...F()],l=[...f],E;for(;E=Z.pop();)t&&(E=Ot(E)),Qe(o,l,E);const g=F();Ue(o,g)||(B.set([g,f]),B.push([o,l]),a(n(o))),Ee(l)}},pe=o=>{if(!L){if(u&&u(o)){o.preventDefault();return}if((o.metaKey||o.ctrlKey)&&!o.altKey&&o.code==="KeyZ"&&(o.preventDefault(),k._record(!1),!D)){const l=o.shiftKey?B.redo():B.undo();l&&(a(n(l[0])),Ee(l[1]))}}},he=()=>{L||ee()},Te=o=>{o.preventDefault();const l=o.inputType;if(l.startsWith("format")||l==="historyUndo"||l==="historyRedo")return;L?k._record(!0):A();const E=o.getTargetRanges()[0];if(E){const g=Ye(e,S,E);let N=l==="insertParagraph"||l==="insertLineBreak"?`
`:o.data;if(N==null){const q=o.dataTransfer;q&&(N=q.getData("text/plain"))}C||(C=new w().select(...f)),m(...g)!==0&&C.delete(...g),N&&C.insert(g[0],Ge(N))}L||ee()},ge=()=>{L||A(),L=!0},_e=()=>{ee()},Ne=()=>{Y=!0,A()},ve=()=>{Y=!1},ye=()=>{if(P){P=!1;return}Y&&!L&&!V&&A()},te=o=>{A(),m(...f)!==0&&i(o,Xe(F(),...z(f)),()=>Ke(ue(e),e).cloneContents())},De=o=>r(o,l=>fe(l,S)),Le=o=>{o.preventDefault(),te(o.clipboardData)},Se=o=>{o.preventDefault(),D||(te(o.clipboardData),M(new w().delete(...z(f))))},Oe=o=>{o.preventDefault();const[l,E]=z(f);M(new w().delete(l,E).insert(l,De(o.clipboardData)))},me=o=>{o.preventDefault();const l=o.dataTransfer,E=Lt(R,e,o,S);if(l&&E){const g=new w;V&&g.delete(...z(f));const N=g.rebasePos(E);g.select(N,N).insert(N,De(l)).select(N),M(g),e.focus({preventScroll:!0})}},xe=o=>{V=!0,te(o.dataTransfer)},Re=()=>{V=!1};return R.addEventListener("selectionchange",ye),e.addEventListener("keydown",pe),e.addEventListener("input",he),e.addEventListener("beforeinput",Te),e.addEventListener("compositionstart",ge),e.addEventListener("compositionend",_e),e.addEventListener("focus",Ne),e.addEventListener("blur",ve),e.addEventListener("copy",Le),e.addEventListener("cut",Se),e.addEventListener("paste",Oe),e.addEventListener("drop",me),e.addEventListener("dragstart",xe),e.addEventListener("dragend",Re),{dispose:()=>{x||(x=!0,e.contentEditable=d,e.role=_,e.ariaMultiLine=y,e.ariaReadOnly=h,e.style.whiteSpace=T,k._dispose(),R.removeEventListener("selectionchange",ye),e.removeEventListener("keydown",pe),e.removeEventListener("input",he),e.removeEventListener("beforeinput",Te),e.removeEventListener("compositionstart",ge),e.removeEventListener("compositionend",_e),e.removeEventListener("focus",Ne),e.removeEventListener("blur",ve),e.removeEventListener("copy",Le),e.removeEventListener("cut",Se),e.removeEventListener("paste",Oe),e.removeEventListener("drop",me),e.removeEventListener("dragstart",xe),e.removeEventListener("dragend",Re))},command:(o,...l)=>{const E=o(F(),f,...l);E&&M(E)},readonly:o=>{D=o,de()}}};export{w as T,H as a,ze as d,mt as e,We as g,lt as i,z as r,Ge as s};
