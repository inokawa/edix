const U=([e],[t])=>e===t?0:e<t?1:-1,x=(e,t)=>{const n=U(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},z=([e,t])=>x(e,t)===-1?[t,e]:[e,t],Ve=(e,t=n=>K(n)?n.text:"")=>e.reduce((n,s,i)=>(i!==0&&(n+=`
`),n+s.reduce((r,l)=>r+t(l),"")),""),Fe=e=>e.split(`
`).map(t=>t?[{text:t}]:[]);const we=e=>e._type!==3;class b extends Array{static from(t){return new b(...t)}insert(t,n){return this.push({_type:2,_pos:t,_fragment:n}),this}delete(t,n){return this.push({_type:1,_start:t,_end:n}),this}select(t,n){return this.push({_type:3,_anchor:t,_focus:n}),this}transform(t){return this.reduce((n,s)=>we(s)?ne(n,s):n,t)}}const qe=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),K=e=>"text"in e,be=e=>K(e)?e.text.length:1,ze=e=>e.reduce((t,n)=>t+be(n),0),G=(e,t)=>{const n=[...e];if(!n.length)n.push(...t);else for(const s of t){const i=n.length-1,r=n[i];K(s)&&K(r)?n[i]={text:r.text+s.text}:n.push(s)}return n},B=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],i=be(s);if(i>t){const r=e.slice(0,n),l=e.slice(n+1);if(K(s)){const u=s.text.slice(0,t),f=s.text.slice(t);u&&r.push({text:u}),f&&l.unshift({text:f})}else l.unshift(s);return[r,l]}t-=i}return[e,[]]},Se=(e,t,n,s)=>{const[i]=n,[r]=s||n,l=B(e[n[0]],n[1]),u=l[0],f=s?B(e[s[0]],s[1])[1]:l[1],a=[...t];a.length?(a[0]=G(u,a[0]),a[a.length-1]=G(a[a.length-1],f)):a.push(G(u,f)),e.splice(i,r-i+1,...a)},Ge=(e,t,n)=>U(t,n)===0?[B(B(e[t[0]],n[1])[0],t[1])[1]]:[B(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),B(e[n[0]],n[1])[0]],Ue=e=>{switch(e._type){case 1:return x(e._start,e._end)===1;case 2:return!!Ve(e._fragment)}return!0},We=(e,t)=>{switch(t._type){case 1:{Se(e,[],t._start,t._end);break}case 2:{Se(e,t._fragment,t._pos);break}}},ne=(e,t)=>{switch(t._type){case 1:{const{_start:n,_end:s}=t;if(x(e,n)!==1)return x(s,e)===1?[e[0]+n[0]-s[0],e[1]+(U(s,e)===0?n[1]-s[1]:0)]:n;break}case 2:{const{_pos:n,_fragment:s}=t,i=s.length,r=i-1;if(x(e,n)!==1)return[e[0]+r,e[1]+(U(e,n)===0?ze(s[i-1])-(r===0?0:n[1]):0)];break}}return e},Xe=(e,t,n)=>{const s=[...e],i=[...t];try{for(const r of n)Ue(r)&&(we(r)?(We(e,r),t[0]=ne(t[0],r),t[1]=ne(t[1],r)):(r._anchor&&(t[0]=r._anchor),r._focus&&(t[1]=r._focus)))}catch(r){console.error("rollback transaction:",r),e.length=0,e.push(...s),t[0]=i[0],t[1]=i[1]}},$e=500,je=500,Ze=e=>{let t=0,n=0;const s=Date.now,i=[e],r=()=>i[t],l=()=>t>0,u=()=>t<i.length-1;return{get:r,set:f=>{i[t]=f},undo:()=>{if(l())return t--,r()},redo:()=>{if(u())return t++,r()},push:f=>{const a=s();t!==0&&a-n<je&&t--,n=a,i[++t]=f,i.splice(t+1),t>$e&&(t--,i.shift())}}};let O,p,D,W,se=!1,re=!1,Pe;const Je=1,Qe=4,ie=1,X=2,$=3,ae=4,et=5,tt=6,nt=1,st=3,rt=8,ot=e=>e.nodeType===st,j=e=>e.nodeType===nt,it=e=>e.nodeType===rt,at=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Ce=e=>e.contentEditable==="false"||at.has(e.tagName),oe=()=>p,ke=()=>D===ie?p.data.length:D===X?1:0,ct=e=>{O.currentNode=O.currentNode.parentNode.children[e]},Oe=e=>{const t=e.nextSibling;return!!t&&!it(t)},lt=()=>{for(;;){if(D===X){const e=p;for(;(p=O.nextNode())&&e.contains(p););}else p=O.nextNode();if(D=null,!p)break;if(W){if(W.contains(p)){if(se=!0,re)break}else if(se)break}if(ot(p)){const e=p.data;if(e)return e===`
`?D=Oe(p)?$:tt:D=ie}else if(j(p)){if(p.tagName==="BR")return D=Oe(p)?$:et;if(Ce(p))return D=X;if(Pe(p))return D=ae}}},ce=(e,t,{_document:n,_isBlock:s},i)=>{try{return Pe=s,O=n.createTreeWalker(t,Qe|Je),i&&(i._startNode&&(O.currentNode=i._startNode,O.previousNode()),i._endNode&&(W=i._endNode),re=i._excludeEnd||!1),e(lt)}finally{O=p=D=W=null,se=re=!1}},ut=Math.min,ft=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},dt=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),Et=e=>dt.has(e.tagName),pt=2,Ie=e=>e.ownerDocument,Me=e=>Ie(e).getSelection(),ht=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},xe=(e,t,n)=>{const s=Me(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},Re=(e,t,[n,s],i)=>{const r=x(n,s),l=r===0,u=r===-1,f=u?s:n,a=u?n:s;if(f[0]===0&&f[1]===0&&l&&!t.hasChildNodes()){const A=e.createRange();return A.setStart(t,0),A.setEnd(t,0),xe(t,A),!0}const E=me(t,f,i);if(!E)return!1;const _=l?E:me(t,a,i);if(!_)return!1;const h=e.createRange(),[N,P]=E,[v,C]=_;return j(N)?P<1?h.setStartBefore(N):h.setStartAfter(N):h.setStart(N,P),j(v)?C<1?h.setEndBefore(v):h.setEndAfter(v):h.setEnd(v,C),xe(t,h,u),!0},me=(e,[t,n],s)=>ce(i=>{let r,l=!1;for(;r=i();)if(r===ae)l||(l=!0,t!==0&&ct(t));else{const u=ke();if(n<=u)return[oe(),n];n-=u}},e,s),gt=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},_t=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},Z=(e,t,n,s)=>{let i,r,l=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(j(t)&&!Ce(t)&&t.hasChildNodes()){const f=ut(n,t.childNodes.length-1);t=t.childNodes[f],l=f===n,n=0}const u=gt(e,t);return s._isBlock(u)?(i=u,r=_t(i)):(i=e,r=0),ce(f=>{let a,E=0;for(;a=f();)a===$?(r++,E=0):E+=ke();return[r,E+n]},i,s,{_endNode:t,_excludeEnd:l})},Be=(e,t,{startOffset:n,startContainer:s,endOffset:i,endContainer:r})=>{const l=Z(e,s,n,t);return[l,s===r&&n===i?l:Z(e,r,i,t)]},Ae=()=>[[0,0],[0,0]],Tt=(e,t)=>e.compareDocumentPosition(t),Nt=(e,t)=>{const n=Me(e),s=ht(n,e);if(!s)return Ae();const i=Be(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(Tt(n.anchorNode,n.focusNode)&pt)!==0)?[i[1],i[0]]:i},Lt=(e,t,n)=>ce(s=>{let i,r=null,l="",u=!1;const f=[],a=()=>{l&&(r||(r=[]),r.push({text:l}),l="")},E=()=>{a(),!r&&u&&(r=[]),r&&f.push(r),r=null,u=!1};for(;i=s();)if(i===ae)E();else if(u=!0,i===ie){const _=oe();l+=_.data}else if(i===X){a();const _=oe(),h=n(_);h&&r.push({data:h})}else i===$&&E();return E(),f.length||f.push([]),f},e,t),vt=(e,t,{clientX:n,clientY:s},i)=>{if(e.caretPositionFromPoint){const r=e.caretPositionFromPoint(n,s);if(r)return Z(t,r.offsetNode,r.offset,i)}else if(e.caretRangeFromPoint){const r=e.caretRangeFromPoint(n,s);if(r)return Z(t,r.startContainer,r.startOffset,i)}},yt=(e,t)=>{let n=!1;const s=[],i=u=>{n&&s.push(...u)},r=new MutationObserver(u=>{i(u),n||t()}),l=()=>{i(r.takeRecords())};return r.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(u){!n&&u&&l(),n=u},_flush:()=>(l(),s.splice(0)),_dispose(){s.splice(0),r.disconnect()}}},Dt=e=>b.from(e.map(t=>t._type===2?{...t,_fragment:[t._fragment.reduce((n,s)=>G(n,s),[])]}:t)),te=()=>{},St=({schema:{single:e,js:t,doc:n,copy:s,paste:i},doc:r,isBlock:l=Et,onChange:u,onKeyDown:f})=>{let a=Ae(),E=!1,_=te;const h=()=>N.get()[0],N=Ze([n(r),a]),P=[],v=o=>{E||(P.unshift(o),A(He))},C=new Set,A=o=>{C.has(o)||(C.add(o),ft(()=>{C.delete(o),o()}))},He=()=>{if(P.length){let o=[...h()],R=[...a],L;for(;L=P.pop();)e&&(L=Dt(L)),Xe(o,R,L);const Y=h();qe(o,Y)||(N.set([Y,a]),N.push([o,R]),u(t(o))),a=R}};return{input:o=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return console.error("beforeinput event is not supported."),te;const{contentEditable:R,role:L,ariaMultiLine:Y,ariaReadOnly:Ke}=o,Ye=o.style.whiteSpace;o.role="textbox",o.style.whiteSpace="pre-wrap",e||(o.ariaMultiLine="true");let le=!1,J=!1,k=null,S=!1,V=!1,F=!1;const I=Ie(o),m={_document:I,_isBlock:l};_=()=>{o.contentEditable=E?"false":"true",o.ariaReadOnly=E?"true":null},_();const M=yt(o,()=>{V&&Re(I,o,a,m)}),H=()=>{a=Nt(o,m)},Q=()=>{const c=M._flush();if(M._record(!1),c.length){let d;for(;d=c.pop();)if(d.type==="childList"){const{target:y,removedNodes:T,addedNodes:g,nextSibling:q}=d;for(let w=T.length-1;w>=0;w--)y.insertBefore(T[w],q);for(let w=g.length-1;w>=0;w--)y.removeChild(g[w])}else d.target.nodeValue=d.oldValue;M._flush(),J=Re(I,o,a,m)}v(k),S=!1,k=null},ue=c=>{if(!S){if(f&&f(c)){c.preventDefault();return}if((c.metaKey||c.ctrlKey)&&!c.altKey&&c.code==="KeyZ"&&(c.preventDefault(),M._record(!1),!E)){const d=c.shiftKey?N.redo():N.undo();d&&(u(t(d[0])),a=d[1])}}},fe=()=>{S||Q()},de=c=>{c.preventDefault();const d=c.inputType;if(d.startsWith("format")||d==="historyUndo"||d==="historyRedo")return;S?M._record(!0):H();const y=c.getTargetRanges()[0];if(y){const T=Be(o,m,y);let g=d==="insertParagraph"||d==="insertLineBreak"?`
`:c.data;if(g==null){const q=c.dataTransfer;q&&(g=q.getData("text/plain"))}k||(k=new b().select(...a)),x(...T)!==0&&k.delete(...T),g&&k.insert(T[0],Fe(g))}S||Q()},Ee=()=>{S||H(),S=!0},pe=()=>{Q()},he=()=>{V=!0,H()},ge=()=>{V=!1},_e=()=>{if(J){J=!1;return}V&&!S&&!F&&H()},ee=c=>{H(),x(...a)!==0&&s(c,Ge(h(),...z(a)),o)},Te=c=>{c.preventDefault(),ee(c.clipboardData)},Ne=c=>{c.preventDefault(),E||(ee(c.clipboardData),v(new b().delete(...z(a))))},ve=c=>{c.preventDefault();const[d,y]=z(a);v(new b().delete(d,y).insert(d,i(c.clipboardData,m)))},ye=c=>{c.preventDefault();const d=c.dataTransfer,y=vt(I,o,c,m);if(d&&y){const T=new b;F&&T.delete(...z(a));const g=T.transform(y);T.select(g,g).insert(g,i(d,m)).select(g),v(T),o.focus({preventScroll:!0})}},De=c=>{F=!0,ee(c.dataTransfer)},Le=()=>{F=!1};return I.addEventListener("selectionchange",_e),o.addEventListener("keydown",ue),o.addEventListener("input",fe),o.addEventListener("beforeinput",de),o.addEventListener("compositionstart",Ee),o.addEventListener("compositionend",pe),o.addEventListener("focus",he),o.addEventListener("blur",ge),o.addEventListener("copy",Te),o.addEventListener("cut",Ne),o.addEventListener("paste",ve),o.addEventListener("drop",ye),o.addEventListener("dragstart",De),o.addEventListener("dragend",Le),()=>{le||(le=!0,_=te,o.contentEditable=R,o.role=L,o.ariaMultiLine=Y,o.ariaReadOnly=Ke,o.style.whiteSpace=Ye,M._dispose(),I.removeEventListener("selectionchange",_e),o.removeEventListener("keydown",ue),o.removeEventListener("input",fe),o.removeEventListener("beforeinput",de),o.removeEventListener("compositionstart",Ee),o.removeEventListener("compositionend",pe),o.removeEventListener("focus",he),o.removeEventListener("blur",ge),o.removeEventListener("copy",Te),o.removeEventListener("cut",Ne),o.removeEventListener("paste",ve),o.removeEventListener("drop",ye),o.removeEventListener("dragstart",De),o.removeEventListener("dragend",Le))}},command:(o,...R)=>{const L=o(h(),a,...R);L&&v(L)},readonly:o=>{E=o,_()}}};export{b as T,Lt as a,ht as b,St as c,Ve as d,Me as e,K as f,ze as g,it as i,z as r,Fe as s};
