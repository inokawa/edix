const U=([t],[e])=>t===e?0:t<e?1:-1,x=(t,e)=>{const n=U(t,e);return n===0?t[1]===e[1]?0:t[1]<e[1]?1:-1:n},z=([t,e])=>x(t,e)===-1?[e,t]:[t,e],Ve=(t,e)=>t.reduce((n,s,i)=>(i!==0&&(n+=`
`),n+s.reduce((o,a)=>o+(K(a)?a.text:e?e(a):""),"")),""),Fe=t=>t.split(`
`).map(e=>e?[{text:e}]:[]);const we=t=>t._type!==3;class b extends Array{static from(e){return new b(...e)}insert(e,n){return this.push({_type:2,_pos:e,_fragment:n}),this}delete(e,n){return this.push({_type:1,_start:e,_end:n}),this}select(e,n){return this.push({_type:3,_anchor:e,_focus:n}),this}transform(e){return this.reduce((n,s)=>we(s)?ne(n,s):n,e)}}const qe=(t,e)=>t.length===e.length&&t.every((n,s)=>n===e[s]),K=t=>"text"in t,be=t=>K(t)?t.text.length:1,ze=t=>t.reduce((e,n)=>e+be(n),0),G=(t,e)=>{const n=[...t];if(!n.length)n.push(...e);else for(const s of e){const i=n.length-1,o=n[i];K(s)&&K(o)?n[i]={text:o.text+s.text}:n.push(s)}return n},B=(t,e)=>{for(let n=0;n<t.length;n++){const s=t[n],i=be(s);if(i>e){const o=t.slice(0,n),a=t.slice(n+1);if(K(s)){const u=s.text.slice(0,e),f=s.text.slice(e);u&&o.push({text:u}),f&&a.unshift({text:f})}else a.unshift(s);return[o,a]}e-=i}return[t,[]]},Se=(t,e,n,s)=>{const[i]=n,[o]=s||n,a=B(t[n[0]],n[1]),u=a[0],f=s?B(t[s[0]],s[1])[1]:a[1],c=[...e];c.length?(c[0]=G(u,c[0]),c[c.length-1]=G(c[c.length-1],f)):c.push(G(u,f)),t.splice(i,o-i+1,...c)},Ge=(t,e,n)=>U(e,n)===0?[B(B(t[e[0]],n[1])[0],e[1])[1]]:[B(t[e[0]],e[1])[1],...t.slice(e[0]+1,n[0]),B(t[n[0]],n[1])[0]],Ue=t=>{switch(t._type){case 1:return x(t._start,t._end)===1;case 2:return!!Ve(t._fragment)}return!0},We=(t,e)=>{switch(e._type){case 1:{Se(t,[],e._start,e._end);break}case 2:{Se(t,e._fragment,e._pos);break}}},ne=(t,e)=>{switch(e._type){case 1:{const{_start:n,_end:s}=e;if(x(t,n)!==1)return x(s,t)===1?[t[0]+n[0]-s[0],t[1]+(U(s,t)===0?n[1]-s[1]:0)]:n;break}case 2:{const{_pos:n,_fragment:s}=e,i=s.length,o=i-1;if(x(t,n)!==1)return[t[0]+o,t[1]+(U(t,n)===0?ze(s[i-1])-(o===0?0:n[1]):0)];break}}return t},Xe=(t,e,n)=>{const s=[...t],i=[...e];try{for(const o of n)Ue(o)&&(we(o)?(We(t,o),e[0]=ne(e[0],o),e[1]=ne(e[1],o)):(o._anchor&&(e[0]=o._anchor),o._focus&&(e[1]=o._focus)))}catch(o){console.error("rollback transaction:",o),t.length=0,t.push(...s),e[0]=i[0],e[1]=i[1]}},$e=500,je=500,Ze=t=>{let e=0,n=0;const s=Date.now,i=[t],o=()=>i[e],a=()=>e>0,u=()=>e<i.length-1;return{get:o,set:f=>{i[e]=f},undo:()=>{if(a())return e--,o()},redo:()=>{if(u())return e++,o()},push:f=>{const c=s();e!==0&&c-n<je&&e--,n=c,i[++e]=f,i.splice(e+1),e>$e&&(e--,i.shift())}}};let O,p,D,W,se=!1,re=!1,Pe;const Je=1,Qe=4,ie=1,X=2,$=3,ae=4,et=5,tt=6,nt=1,st=3,rt=8,ot=t=>t.nodeType===st,j=t=>t.nodeType===nt,it=t=>t.nodeType===rt,at=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Ce=t=>t.contentEditable==="false"||at.has(t.tagName),oe=()=>p,ke=()=>D===ie?p.data.length:D===X?1:0,ct=t=>{O.currentNode=O.currentNode.parentNode.children[t]},Oe=t=>{const e=t.nextSibling;return!!e&&!it(e)},lt=()=>{for(;;){if(D===X){const t=p;for(;(p=O.nextNode())&&t.contains(p););}else p=O.nextNode();if(D=null,!p)break;if(W){if(W.contains(p)){if(se=!0,re)break}else if(se)break}if(ot(p)){const t=p.data;if(t)return t===`
`?D=Oe(p)?$:tt:D=ie}else if(j(p)){if(p.tagName==="BR")return D=Oe(p)?$:et;if(Ce(p))return D=X;if(Pe(p))return D=ae}}},ce=(t,e,{_document:n,_isBlock:s},i)=>{try{return Pe=s,O=n.createTreeWalker(e,Qe|Je),i&&(i._startNode&&(O.currentNode=i._startNode,O.previousNode()),i._endNode&&(W=i._endNode),re=i._excludeEnd||!1),t(lt)}finally{O=p=D=W=null,se=re=!1}},ut=Math.min,ft=typeof queueMicrotask=="function"?queueMicrotask:t=>{Promise.resolve().then(t)},dt=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),Et=t=>dt.has(t.tagName),pt=2,Ie=t=>t.ownerDocument,Me=t=>Ie(t).getSelection(),ht=(t,e)=>{if(t.rangeCount){const n=t.getRangeAt(0);if(e.contains(n.commonAncestorContainer))return n}},xe=(t,e,n)=>{const s=Me(t);s.removeAllRanges(),s.addRange(e),n&&(s.collapseToEnd(),s.extend(e.startContainer,e.startOffset))},Re=(t,e,[n,s],i)=>{const o=x(n,s),a=o===0,u=o===-1,f=u?s:n,c=u?n:s;if(f[0]===0&&f[1]===0&&a&&!e.hasChildNodes()){const A=t.createRange();return A.setStart(e,0),A.setEnd(e,0),xe(e,A),!0}const E=me(e,f,i);if(!E)return!1;const T=a?E:me(e,c,i);if(!T)return!1;const h=t.createRange(),[g,P]=E,[v,C]=T;return j(g)?P<1?h.setStartBefore(g):h.setStartAfter(g):h.setStart(g,P),j(v)?C<1?h.setEndBefore(v):h.setEndAfter(v):h.setEnd(v,C),xe(e,h,u),!0},me=(t,[e,n],s)=>ce(i=>{let o,a=!1;for(;o=i();)if(o===ae)a||(a=!0,e!==0&&ct(e));else{const u=ke();if(n<=u)return[oe(),n];n-=u}},t,s),gt=(t,e)=>{let n=e;for(;;){const s=n.parentElement;if(s===t)break;n=s}return n},_t=t=>{let e=0;for(;t=t.previousElementSibling;)e++;return e},Z=(t,e,n,s)=>{let i,o,a=!0;if(t===e&&!e.hasChildNodes())return[0,0];if(j(e)&&!Ce(e)&&e.hasChildNodes()){const f=ut(n,e.childNodes.length-1);e=e.childNodes[f],a=f===n,n=0}const u=gt(t,e);return s._isBlock(u)?(i=u,o=_t(i)):(i=t,o=0),ce(f=>{let c,E=0;for(;c=f();)c===$?(o++,E=0):E+=ke();return[o,E+n]},i,s,{_endNode:e,_excludeEnd:a})},Be=(t,e,{startOffset:n,startContainer:s,endOffset:i,endContainer:o})=>{const a=Z(t,s,n,e);return[a,s===o&&n===i?a:Z(t,o,i,e)]},Ae=()=>[[0,0],[0,0]],Tt=(t,e)=>t.compareDocumentPosition(e),Nt=(t,e)=>{const n=Me(t),s=ht(n,t);if(!s)return Ae();const i=Be(t,e,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(Tt(n.anchorNode,n.focusNode)&pt)!==0)?[i[1],i[0]]:i},Lt=(t,e,n,s)=>ce(i=>{let o,a=null,u="",f=!1;const c=[],E=()=>{u&&(a||(a=[]),a.push({text:u}),u="")},T=()=>{E(),!a&&f&&(a=[]),a&&c.push(a),a=null,f=!1};for(;o=i();)if(o===ae)T();else if(f=!0,o===ie){let g=oe().data;u+=g}else if(o===X){E();const h=oe(),g=n(h);g&&a.push({data:g})}else o===$&&T();return T(),c.length||c.push([]),c},t,e,s),vt=(t,e,{clientX:n,clientY:s},i)=>{if(t.caretPositionFromPoint){const o=t.caretPositionFromPoint(n,s);if(o)return Z(e,o.offsetNode,o.offset,i)}else if(t.caretRangeFromPoint){const o=t.caretRangeFromPoint(n,s);if(o)return Z(e,o.startContainer,o.startOffset,i)}},yt=(t,e)=>{let n=!1;const s=[],i=u=>{n&&s.push(...u)},o=new MutationObserver(u=>{i(u),n||e()}),a=()=>{i(o.takeRecords())};return o.observe(t,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(u){!n&&u&&a(),n=u},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),o.disconnect()}}},Dt=t=>b.from(t.map(e=>e._type===2?{...e,_fragment:[e._fragment.reduce((n,s)=>G(n,s),[])]}:e)),te=()=>{},St=({schema:{single:t,js:e,doc:n,copy:s,paste:i},doc:o,isBlock:a=Et,onChange:u,onKeyDown:f})=>{let c=Ae(),E=!1,T=te;const h=()=>g.get()[0],g=Ze([n(o),c]),P=[],v=r=>{E||(P.unshift(r),A(He))},C=new Set,A=r=>{C.has(r)||(C.add(r),ft(()=>{C.delete(r),r()}))},He=()=>{if(P.length){let r=[...h()],R=[...c],L;for(;L=P.pop();)t&&(L=Dt(L)),Xe(r,R,L);const Y=h();qe(r,Y)||(g.set([Y,c]),g.push([r,R]),u(e(r))),c=R}};return{input:r=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return console.error("beforeinput event is not supported."),te;const{contentEditable:R,role:L,ariaMultiLine:Y,ariaReadOnly:Ke}=r,Ye=r.style.whiteSpace;r.role="textbox",r.style.whiteSpace="pre-wrap",t||(r.ariaMultiLine="true");let le=!1,J=!1,k=null,S=!1,V=!1,F=!1;const I=Ie(r),m={_document:I,_isBlock:a};T=()=>{r.contentEditable=E?"false":"true",r.ariaReadOnly=E?"true":null},T();const M=yt(r,()=>{V&&Re(I,r,c,m)}),H=()=>{c=Nt(r,m)},Q=()=>{const l=M._flush();if(M._record(!1),l.length){let d;for(;d=l.pop();)if(d.type==="childList"){const{target:y,removedNodes:N,addedNodes:_,nextSibling:q}=d;for(let w=N.length-1;w>=0;w--)y.insertBefore(N[w],q);for(let w=_.length-1;w>=0;w--)y.removeChild(_[w])}else d.target.nodeValue=d.oldValue;M._flush(),J=Re(I,r,c,m)}v(k),S=!1,k=null},ue=l=>{if(!S){if(f&&f(l)){l.preventDefault();return}if((l.metaKey||l.ctrlKey)&&!l.altKey&&l.code==="KeyZ"&&(l.preventDefault(),M._record(!1),!E)){const d=l.shiftKey?g.redo():g.undo();d&&(u(e(d[0])),c=d[1])}}},fe=()=>{S||Q()},de=l=>{l.preventDefault();const d=l.inputType;if(d.startsWith("format")||d==="historyUndo"||d==="historyRedo")return;S?M._record(!0):H();const y=l.getTargetRanges()[0];if(y){const N=Be(r,m,y);let _=d==="insertParagraph"||d==="insertLineBreak"?`
`:l.data;if(_==null){const q=l.dataTransfer;q&&(_=q.getData("text/plain"))}k||(k=new b().select(...c)),x(...N)!==0&&k.delete(...N),_&&k.insert(N[0],Fe(_))}S||Q()},Ee=()=>{S||H(),S=!0},pe=()=>{Q()},he=()=>{V=!0,H()},ge=()=>{V=!1},_e=()=>{if(J){J=!1;return}V&&!S&&!F&&H()},ee=l=>{H(),x(...c)!==0&&s(l,Ge(h(),...z(c)),r)},Te=l=>{l.preventDefault(),ee(l.clipboardData)},Ne=l=>{l.preventDefault(),E||(ee(l.clipboardData),v(new b().delete(...z(c))))},ve=l=>{l.preventDefault();const[d,y]=z(c);v(new b().delete(d,y).insert(d,i(l.clipboardData,m)))},ye=l=>{l.preventDefault();const d=l.dataTransfer,y=vt(I,r,l,m);if(d&&y){const N=new b;F&&N.delete(...z(c));const _=N.transform(y);N.select(_,_).insert(_,i(d,m)).select(_),v(N),r.focus({preventScroll:!0})}},De=l=>{F=!0,ee(l.dataTransfer)},Le=()=>{F=!1};return I.addEventListener("selectionchange",_e),r.addEventListener("keydown",ue),r.addEventListener("input",fe),r.addEventListener("beforeinput",de),r.addEventListener("compositionstart",Ee),r.addEventListener("compositionend",pe),r.addEventListener("focus",he),r.addEventListener("blur",ge),r.addEventListener("copy",Te),r.addEventListener("cut",Ne),r.addEventListener("paste",ve),r.addEventListener("drop",ye),r.addEventListener("dragstart",De),r.addEventListener("dragend",Le),()=>{le||(le=!0,T=te,r.contentEditable=R,r.role=L,r.ariaMultiLine=Y,r.ariaReadOnly=Ke,r.style.whiteSpace=Ye,M._dispose(),I.removeEventListener("selectionchange",_e),r.removeEventListener("keydown",ue),r.removeEventListener("input",fe),r.removeEventListener("beforeinput",de),r.removeEventListener("compositionstart",Ee),r.removeEventListener("compositionend",pe),r.removeEventListener("focus",he),r.removeEventListener("blur",ge),r.removeEventListener("copy",Te),r.removeEventListener("cut",Ne),r.removeEventListener("paste",ve),r.removeEventListener("drop",ye),r.removeEventListener("dragstart",De),r.removeEventListener("dragend",Le))}},command:(r,...R)=>{const L=r(h(),c,...R);L&&v(L)},readonly:r=>{E=r,T()}}};export{b as T,Lt as a,ht as b,St as c,Ve as d,Me as e,K as f,ze as g,it as i,z as r,Fe as s};
