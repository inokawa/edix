const X=([t],[e])=>t===e?0:t<e?1:-1,m=(t,e)=>{const n=X(t,e);return n===0?t[1]===e[1]?0:t[1]<e[1]?1:-1:n},G=([t,e])=>m(t,e)===-1?[e,t]:[t,e],qe=(t,e)=>t.reduce((n,s,i)=>(i!==0&&(n+=`
`),n+s.reduce((o,a)=>o+(K(a)?a.text:e?e(a):""),"")),""),ze=t=>t.split(`
`).map(e=>e?[{text:e}]:[]);const we=t=>t._type!==3;class I extends Array{static from(e){return new I(...e)}insert(e,n){return this.push({_type:2,_pos:e,_fragment:n}),this}delete(e,n){return this.push({_type:1,_start:e,_end:n}),this}select(e,n){return this.push({_type:3,_anchor:e,_focus:n}),this}rebasePos(e){return this.reduce((n,s)=>we(s)?re(n,s):n,e)}}const Ge=(t,e)=>t.length===e.length&&t.every((n,s)=>n===e[s]),K=t=>"text"in t,Pe=t=>K(t)?t.text.length:1,Ue=t=>t.reduce((e,n)=>e+Pe(n),0),W=(t,e)=>{const n=[...t];if(!n.length)n.push(...e);else for(const s of e){const i=n.length-1,o=n[i];K(s)&&K(o)?n[i]={text:o.text+s.text}:n.push(s)}return n},A=(t,e)=>{for(let n=0;n<t.length;n++){const s=t[n],i=Pe(s);if(i>e){const o=t.slice(0,n),a=t.slice(n+1);if(K(s)){const u=s.text.slice(0,e),f=s.text.slice(e);u&&o.push({text:u}),f&&a.unshift({text:f})}else a.unshift(s);return[o,a]}e-=i}return[t,[]]},xe=(t,e,n,s)=>{const[i]=n,[o]=s||n,a=A(t[n[0]],n[1]),u=a[0],f=s?A(t[s[0]],s[1])[1]:a[1],c=[...e];c.length?(c[0]=W(u,c[0]),c[c.length-1]=W(c[c.length-1],f)):c.push(W(u,f)),t.splice(i,o-i+1,...c)},We=(t,e,n)=>X(e,n)===0?[A(A(t[e[0]],n[1])[0],e[1])[1]]:[A(t[e[0]],e[1])[1],...t.slice(e[0]+1,n[0]),A(t[n[0]],n[1])[0]],Xe=t=>{switch(t._type){case 1:return m(t._start,t._end)===1;case 2:return!!qe(t._fragment)}return!0},$e=(t,e)=>{switch(e._type){case 1:{xe(t,[],e._start,e._end);break}case 2:{xe(t,e._fragment,e._pos);break}}},re=(t,e)=>{switch(e._type){case 1:{const{_start:n,_end:s}=e;if(m(t,n)!==1)return m(s,t)===1?[t[0]+n[0]-s[0],t[1]+(X(s,t)===0?n[1]-s[1]:0)]:n;break}case 2:{const{_pos:n,_fragment:s}=e,i=s.length,o=i-1;if(m(t,n)!==1)return[t[0]+o,t[1]+(X(t,n)===0?Ue(s[i-1])-(o===0?0:n[1]):0)];break}}return t},je=(t,e,n)=>{const s=[...t],i=[...e];try{for(const o of n)Xe(o)&&(we(o)?($e(t,o),e[0]=re(e[0],o),e[1]=re(e[1],o)):(o._anchor&&(e[0]=o._anchor),o._focus&&(e[1]=o._focus)))}catch(o){console.error("rollback transaction:",o),t.length=0,t.push(...s),e[0]=i[0],e[1]=i[1]}},Qe=500,Ze=500,Je=t=>{let e=0,n=0;const s=Date.now,i=[t],o=()=>i[e],a=()=>e>0,u=()=>e<i.length-1;return{get:o,set:f=>{i[e]=f},undo:()=>{if(a())return e--,o()},redo:()=>{if(u())return e++,o()},push:f=>{const c=s();e!==0&&c-n<Ze&&e--,n=c,i[++e]=f,i.splice(e+1),e>Qe&&(e--,i.shift())}}};let b,p,y,$,oe=!1,ie=!1,Ce;const et=1,tt=4,ce=1,j=2,Q=3,le=4,nt=5,st=6,rt=1,ot=3,it=8,at=t=>t.nodeType===ot,Z=t=>t.nodeType===rt,ct=t=>t.nodeType===it,lt=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),ke=t=>t.contentEditable==="false"||lt.has(t.tagName),ae=()=>p,Ie=()=>y===ce?p.data.length:y===j?1:0,ut=t=>{b.currentNode=b.currentNode.parentNode.children[t]},Re=t=>{const e=t.nextSibling;return!!e&&!ct(e)},ft=()=>{for(;;){if(y===j){const t=p;for(;(p=b.nextNode())&&t.contains(p););}else p=b.nextNode();if(y=null,!p)break;if($){if($.contains(p)){if(oe=!0,ie)break}else if(oe)break}if(at(p)){const t=p.data;if(t)return t===`
`?y=Re(p)?Q:st:y=ce}else if(Z(p)){if(p.tagName==="BR")return y=Re(p)?Q:nt;if(ke(p))return y=j;if(Ce(p))return y=le}}},ue=(t,e,{_document:n,_isBlock:s},i)=>{try{return Ce=s,b=n.createTreeWalker(e,tt|et),i&&(i._startNode&&(b.currentNode=i._startNode,b.previousNode()),i._endNode&&($=i._endNode),ie=i._excludeEnd||!1),t(ft)}finally{b=p=y=$=null,oe=ie=!1}},dt=Math.min,Et=typeof queueMicrotask=="function"?queueMicrotask:t=>{Promise.resolve().then(t)},pt=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),ht=t=>pt.has(t.tagName),gt=2,Me=t=>t.ownerDocument,Be=t=>Me(t).getSelection(),Tt=(t,e)=>{if(t.rangeCount){const n=t.getRangeAt(0);if(e.contains(n.commonAncestorContainer))return n}},be=(t,e,n)=>{const s=Be(t);s.removeAllRanges(),s.addRange(e),n&&(s.collapseToEnd(),s.extend(e.startContainer,e.startOffset))},se=(t,e,[n,s],i)=>{const o=m(n,s),a=o===0,u=o===-1,f=u?s:n,c=u?n:s;if(f[0]===0&&f[1]===0&&a&&!e.hasChildNodes()){const w=t.createRange();return w.setStart(e,0),w.setEnd(e,0),be(e,w),!0}const E=me(e,f,i);if(!E)return!1;const _=a?E:me(e,c,i);if(!_)return!1;const h=t.createRange(),[g,L]=E,[S,O]=_;return Z(g)?L<1?h.setStartBefore(g):h.setStartAfter(g):h.setStart(g,L),Z(S)?O<1?h.setEndBefore(S):h.setEndAfter(S):h.setEnd(S,O),be(e,h,u),!0},me=(t,[e,n],s)=>ue(i=>{let o,a=!1;for(;o=i();)if(o===le)a||(a=!0,e!==0&&ut(e));else{const u=Ie();if(n<=u)return[ae(),n];n-=u}},t,s),_t=(t,e)=>{let n=e;for(;;){const s=n.parentElement;if(s===t)break;n=s}return n},Nt=t=>{let e=0;for(;t=t.previousElementSibling;)e++;return e},J=(t,e,n,s)=>{let i,o,a=!0;if(t===e&&!e.hasChildNodes())return[0,0];if(Z(e)&&!ke(e)&&e.hasChildNodes()){const f=dt(n,e.childNodes.length-1);e=e.childNodes[f],a=f===n,n=0}const u=_t(t,e);return s._isBlock(u)?(i=u,o=Nt(i)):(i=t,o=0),ue(f=>{let c,E=0;for(;c=f();)c===Q?(o++,E=0):E+=Ie();return[o,E+n]},i,s,{_endNode:e,_excludeEnd:a})},Ae=(t,e,{startOffset:n,startContainer:s,endOffset:i,endContainer:o})=>{const a=J(t,s,n,e);return[a,s===o&&n===i?a:J(t,o,i,e)]},He=()=>[[0,0],[0,0]],vt=(t,e)=>t.compareDocumentPosition(e),yt=(t,e)=>{const n=Be(t),s=Tt(n,t);if(!s)return He();const i=Ae(t,e,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(vt(n.anchorNode,n.focusNode)&gt)!==0)?[i[1],i[0]]:i},Ot=(t,e,n,s)=>ue(i=>{let o,a=null,u="",f=!1;const c=[],E=()=>{u&&(a||(a=[]),a.push({text:u}),u="")},_=()=>{E(),!a&&f&&(a=[]),a&&c.push(a),a=null,f=!1};for(;o=i();)if(o===le)_();else if(f=!0,o===ce){let g=ae().data;u+=g}else if(o===j){E();const h=ae(),g=n(h);g&&a.push({data:g})}else o===Q&&_();return _(),c.length||c.push([]),c},t,e,s),Dt=(t,e,{clientX:n,clientY:s},i)=>{if(t.caretPositionFromPoint){const o=t.caretPositionFromPoint(n,s);if(o)return J(e,o.offsetNode,o.offset,i)}else if(t.caretRangeFromPoint){const o=t.caretRangeFromPoint(n,s);if(o)return J(e,o.startContainer,o.startOffset,i)}},Lt=(t,e)=>{let n=!1;const s=[],i=u=>{n&&s.push(...u)},o=new MutationObserver(u=>{i(u),n||e()}),a=()=>{i(o.takeRecords())};return o.observe(t,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(u){!n&&u&&a(),n=u},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),o.disconnect()}}},St=t=>I.from(t.map(e=>e._type===2?{...e,_fragment:[e._fragment.reduce((n,s)=>W(n,s),[])]}:e)),U=()=>{},xt=({schema:{single:t,js:e,doc:n,copy:s,paste:i},doc:o,isBlock:a=ht,onChange:u,onKeyDown:f})=>{let c=He(),E=!1,_=U,h=U;const g=()=>L.get()[0],L=Je([n(o),c]),S=[],O=r=>{E||(S.unshift(r),Ke(Ye))},w=new Set,Ke=r=>{w.has(r)||(w.add(r),Et(()=>{w.delete(r),r()}))},Ye=()=>{if(S.length){let r=[...g()],P=[...c],D;for(;D=S.pop();)t&&(D=St(D)),je(r,P,D);const Y=g();Ge(r,Y)||(L.set([Y,c]),L.push([r,P]),u(e(r))),h(P)}};return{input:r=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return console.error("beforeinput event is not supported."),U;const{contentEditable:P,role:D,ariaMultiLine:Y,ariaReadOnly:Ve}=r,Fe=r.style.whiteSpace;r.role="textbox",r.style.whiteSpace="pre-wrap",t||(r.ariaMultiLine="true");let fe=!1,ee=!1,M=null,V=null,x=!1,F=!1,q=!1;const C=Me(r),R={_document:C,_isBlock:a};_=()=>{r.contentEditable=E?"false":"true",r.ariaReadOnly=E?"true":null},_();const B=Lt(r,()=>{F&&(se(C,r,c,R),V!=null&&(clearTimeout(V),V=null))});h=l=>{c=l,V=setTimeout(()=>{se(C,r,l,R)})};const H=()=>{c=yt(r,R)},te=()=>{const l=B._flush();if(B._record(!1),l.length){let d;for(;d=l.pop();)if(d.type==="childList"){const{target:v,removedNodes:N,addedNodes:T,nextSibling:z}=d;for(let k=N.length-1;k>=0;k--)v.insertBefore(N[k],z);for(let k=T.length-1;k>=0;k--)v.removeChild(T[k])}else d.target.nodeValue=d.oldValue;B._flush()}O(M),x=!1,M=null,ee=se(C,r,c,R)},de=l=>{if(!x){if(f&&f(l)){l.preventDefault();return}if((l.metaKey||l.ctrlKey)&&!l.altKey&&l.code==="KeyZ"&&(l.preventDefault(),B._record(!1),!E)){const d=l.shiftKey?L.redo():L.undo();d&&(u(e(d[0])),h(d[1]))}}},Ee=()=>{x||te()},pe=l=>{l.preventDefault();const d=l.inputType;if(d.startsWith("format")||d==="historyUndo"||d==="historyRedo")return;x?B._record(!0):H();const v=l.getTargetRanges()[0];if(v){const N=Ae(r,R,v);let T=d==="insertParagraph"||d==="insertLineBreak"?`
`:l.data;if(T==null){const z=l.dataTransfer;z&&(T=z.getData("text/plain"))}M||(M=new I().select(...c)),m(...N)!==0&&M.delete(...N),T&&M.insert(N[0],ze(T))}x||te()},he=()=>{x||H(),x=!0},ge=()=>{te()},Te=()=>{F=!0,H()},_e=()=>{F=!1},Ne=()=>{if(ee){ee=!1;return}F&&!x&&!q&&H()},ne=l=>{H(),m(...c)!==0&&s(l,We(g(),...G(c)),r)},ve=l=>{l.preventDefault(),ne(l.clipboardData)},ye=l=>{l.preventDefault(),E||(ne(l.clipboardData),O(new I().delete(...G(c))))},De=l=>{l.preventDefault();const[d,v]=G(c);O(new I().delete(d,v).insert(d,i(l.clipboardData,R)))},Le=l=>{l.preventDefault();const d=l.dataTransfer,v=Dt(C,r,l,R);if(d&&v){const N=new I;q&&N.delete(...G(c));const T=N.rebasePos(v);N.select(T,T).insert(T,i(d,R)).select(T),O(N),r.focus({preventScroll:!0})}},Se=l=>{q=!0,ne(l.dataTransfer)},Oe=()=>{q=!1};return C.addEventListener("selectionchange",Ne),r.addEventListener("keydown",de),r.addEventListener("input",Ee),r.addEventListener("beforeinput",pe),r.addEventListener("compositionstart",he),r.addEventListener("compositionend",ge),r.addEventListener("focus",Te),r.addEventListener("blur",_e),r.addEventListener("copy",ve),r.addEventListener("cut",ye),r.addEventListener("paste",De),r.addEventListener("drop",Le),r.addEventListener("dragstart",Se),r.addEventListener("dragend",Oe),()=>{fe||(fe=!0,_=h=U,r.contentEditable=P,r.role=D,r.ariaMultiLine=Y,r.ariaReadOnly=Ve,r.style.whiteSpace=Fe,B._dispose(),C.removeEventListener("selectionchange",Ne),r.removeEventListener("keydown",de),r.removeEventListener("input",Ee),r.removeEventListener("beforeinput",pe),r.removeEventListener("compositionstart",he),r.removeEventListener("compositionend",ge),r.removeEventListener("focus",Te),r.removeEventListener("blur",_e),r.removeEventListener("copy",ve),r.removeEventListener("cut",ye),r.removeEventListener("paste",De),r.removeEventListener("drop",Le),r.removeEventListener("dragstart",Se),r.removeEventListener("dragend",Oe))}},command:(r,...P)=>{const D=r(g(),c,...P);D&&O(D)},readonly:r=>{E=r,_()}}};export{I as T,Ot as a,Tt as b,xt as c,qe as d,Be as e,K as f,Ue as g,ct as i,G as r,ze as s};
