const W=([t],[e])=>t===e?0:t<e?1:-1,P=(t,e)=>{const n=W(t,e);return n===0?t[1]===e[1]?0:t[1]<e[1]?1:-1:n},G=([t,e])=>P(t,e)===-1?[e,t]:[t,e],ze=(t,e=n=>V(n)?n.text:"")=>t.reduce((n,r,s)=>(s!==0&&(n+=`
`),n+r.reduce((i,a)=>i+e(a),"")),""),Ce=t=>t.split(`
`).map(e=>e?[{text:e}]:[]);const ke=t=>t._type!==4;class K{constructor(e){this._ops=e?e.slice():[]}get ops(){return this._ops}insert(e,n){return this._ops.push({_type:2,_pos:e,_text:n}),this}insertFragment(e,n){return this._ops.push({_type:3,_pos:e,_fragment:n}),this}delete(e,n){return this._ops.push({_type:1,_start:e,_end:n}),this}select(e,n){return this._ops.push({_type:4,_anchor:e,_focus:n}),this}transform(e){return this._ops.reduce((n,r)=>ke(r)?ce(n,r):n,e)}}const Ge=(t,e,n,r)=>{const s=t.slice();return s.splice(e,n,...r),s},Ue=(t,e)=>t.length===e.length&&t.every((n,r)=>n===e[r]),V=t=>"text"in t,Me=t=>V(t)?t.text.length:1,We=t=>t.reduce((e,n)=>e+Me(n),0),U=(t,e)=>{const n=[...t];if(!n.length)n.push(...e);else for(const r of e){const s=n.length-1,i=n[s];V(r)&&V(i)?n[s]={text:i.text+r.text}:n.push(r)}return n},Y=(t,e)=>{for(let n=0;n<t.length;n++){const r=t[n],s=Me(r);if(s>e){const i=t.slice(0,n),a=t.slice(n+1);if(V(r)){const l=r.text.slice(0,e),f=r.text.slice(e);l&&i.push({text:l}),f&&a.unshift({text:f})}else a.unshift(r);return[i,a]}e-=s}return[t,[]]},oe=(t,e,n,r)=>{const[s]=n,[i]=r||n,[a,l]=Y(t[n[0]],n[1]),f=r?Y(t[r[0]],r[1])[1]:l,d=[...e];return d.length?(d[0]=U(a,d[0]),d[d.length-1]=U(d[d.length-1],f)):d.push(U(a,f)),Ge(t,s,i-s+1,d)},$e=(t,e,n)=>W(e,n)===0?[Y(Y(t[e[0]],n[1])[0],e[1])[1]]:[Y(t[e[0]],e[1])[1],...t.slice(e[0]+1,n[0]),Y(t[n[0]],n[1])[0]],je=t=>{switch(t._type){case 1:return P(t._start,t._end)===1;case 2:return!!t._text;case 3:return!!ze(t._fragment)}return!0},Ze=(t,e)=>{switch(e._type){case 1:return oe(t,[],e._start,e._end);case 2:return oe(t,Ce(e._text),e._pos);case 3:return oe(t,e._fragment,e._pos);default:return e}},ce=(t,e)=>{switch(e._type){case 1:{const{_start:n,_end:r}=e;if(P(t,n)!==1)return P(r,t)===1?[t[0]+n[0]-r[0],t[1]+(W(r,t)===0?n[1]-r[1]:0)]:n;break}case 2:case 3:{const n=e._pos,r=e._type===2?Ce(e._text):e._fragment,s=r.length,i=s-1;if(P(t,n)!==1)return[t[0]+i,t[1]+(W(t,n)===0?We(r[s-1])-(i===0?0:n[1]):0)];break}}return t},Je=(t,e,n,r)=>{try{for(const s of n.ops)je(s)&&(ke(s)?(t=Ze(t,s),e=[ce(e[0],s),ce(e[1],s)]):(s._anchor||s._focus)&&(e=[s._anchor||e[0],s._focus||e[1]]));return[t,e]}catch(s){r&&r("rollback transaction: "+s);return}},Qe=500,et=500,tt=t=>{let e=0,n=0;const r=Date.now,s=[t],i=()=>s[e],a=()=>e>0,l=()=>e<s.length-1;return{get:i,set:f=>{s[e]=f},undo:()=>{if(a())return e--,i()},redo:()=>{if(l())return e++,i()},push:f=>{const d=r();e!==0&&d-n<et&&e--,n=d,s[++e]=f,s.splice(e+1),e>Qe&&(e--,s.shift())}}};let x,p,D,$,ae=!1,le=!1,Be;const nt=1,st=4,fe=1,j=2,Z=3,de=4,rt=5,ot=6,it=1,ct=3,at=8,lt=t=>t.nodeType===ct,J=t=>t.nodeType===it,ut=t=>t.nodeType===at,ft=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Ye=t=>t.contentEditable==="false"||ft.has(t.tagName),ue=()=>p,Ae=()=>D===fe?p.data.length:D===j?1:0,dt=t=>{x.currentNode=x.currentNode.parentNode.children[t]},me=t=>{const e=t.nextSibling;return!!e&&!ut(e)},Et=()=>{for(;;){if(D===j){const t=p;for(;(p=x.nextNode())&&t.contains(p););}else p=x.nextNode();if(D=null,!p)break;if($){if($.contains(p)){if(ae=!0,le)break}else if(ae)break}if(lt(p)){const t=p.data;if(t)return t===`
`?D=me(p)?Z:ot:D=fe}else if(J(p)){if(p.tagName==="BR")return D=me(p)?Z:rt;if(Ye(p))return D=j;if(Be(p))return D=de}}},Ee=(t,e,{_document:n,_isBlock:r},s)=>{try{return Be=r,x=n.createTreeWalker(e,st|nt),s&&(s._startNode&&(x.currentNode=s._startNode,x.previousNode()),s._endNode&&($=s._endNode),le=s._excludeEnd||!1),t(Et)}finally{x=p=D=$=null,ae=le=!1}},pt=Math.min,_t=typeof queueMicrotask=="function"?queueMicrotask:t=>{Promise.resolve().then(t)},Tt=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),ht=t=>Tt.has(t.tagName),gt=2,He=t=>t.ownerDocument,Ke=t=>He(t).getSelection(),Nt=(t,e)=>{if(t.rangeCount){const n=t.getRangeAt(0);if(e.contains(n.commonAncestorContainer))return n}},we=(t,e,n)=>{const r=Ke(t);r.removeAllRanges(),r.addRange(e),n&&(r.collapseToEnd(),r.extend(e.startContainer,e.startOffset))},Ie=(t,e,[n,r],s)=>{const i=P(n,r),a=i===0,l=i===-1,f=l?r:n,d=l?n:r;if(f[0]===0&&f[1]===0&&a&&!e.hasChildNodes()){const m=t.createRange();return m.setStart(e,0),m.setEnd(e,0),we(e,m),!0}const u=be(e,f,s);if(!u)return!1;const T=a?u:be(e,d,s);if(!T)return!1;const _=t.createRange(),[S,L]=u,[R,F]=T;return J(S)?L<1?_.setStartBefore(S):_.setStartAfter(S):_.setStart(S,L),J(R)?F<1?_.setEndBefore(R):_.setEndAfter(R):_.setEnd(R,F),we(e,_,l),!0},be=(t,[e,n],r)=>Ee(s=>{let i,a=!1;for(;i=s();)if(i===de)a||(a=!0,e!==0&&dt(e));else{const l=Ae();if(n<=l)return[ue(),n];n-=l}},t,r),vt=(t,e)=>{let n=e;for(;;){const r=n.parentElement;if(r===t)break;n=r}return n},yt=t=>{let e=0;for(;t=t.previousElementSibling;)e++;return e},Q=(t,e,n,r)=>{let s,i,a=!0;if(t===e&&!e.hasChildNodes())return[0,0];if(J(e)&&!Ye(e)&&e.hasChildNodes()){const f=pt(n,e.childNodes.length-1);e=e.childNodes[f],a=f===n,n=0}const l=vt(t,e);return r._isBlock(l)?(s=l,i=yt(s)):(s=t,i=0),Ee(f=>{let d,u=0;for(;d=f();)d===Z?(i++,u=0):u+=Ae();return[i,u+n]},s,r,{_endNode:e,_excludeEnd:a})},Ve=(t,e,{startOffset:n,startContainer:r,endOffset:s,endContainer:i})=>{const a=Q(t,r,n,e);return[a,r===i&&n===s?a:Q(t,i,s,e)]},Fe=()=>[[0,0],[0,0]],Dt=(t,e)=>t.compareDocumentPosition(e),St=(t,e)=>{const n=Ke(t),r=Nt(n,t);if(!r)return Fe();const s=Ve(t,e,r);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(Dt(n.anchorNode,n.focusNode)&gt)!==0)?[s[1],s[0]]:s},xt=(t,e,n)=>Ee(r=>{let s,i=null,a="",l=!1;const f=[],d=()=>{a&&(i||(i=[]),i.push({text:a}),a="")},u=()=>{d(),!i&&l&&(i=[]),i&&f.push(i),i=null,l=!1};for(;s=r();)if(s===de)u();else if(l=!0,s===fe){const T=ue();a+=T.data}else if(s===j){d();const T=ue(),_=n(T);_&&i.push({data:_})}else s===Z&&u();return u(),f.length||f.push([]),f},t,e),Lt=(t,e,{clientX:n,clientY:r},s)=>{if(t.caretPositionFromPoint){const i=t.caretPositionFromPoint(n,r);if(i)return Q(e,i.offsetNode,i.offset,s)}else if(t.caretRangeFromPoint){const i=t.caretRangeFromPoint(n,r);if(i)return Q(e,i.startContainer,i.startOffset,s)}},Rt=(t,e)=>{let n=!1;const r=[],s=l=>{n&&r.push(...l)},i=new MutationObserver(l=>{s(l),n||e()}),a=()=>{s(i.takeRecords())};return i.observe(t,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(l){!n&&l&&a(),n=l},_flush:()=>(a(),r.splice(0)),_dispose(){r.splice(0),i.disconnect()}}},Ot=()=>({mount:t=>{t.ariaMultiLine=null},apply:(t,e)=>t(new K(e.ops.map(n=>n._type===2?{...n,_text:n._text.replaceAll(`
`,"")}:n._type===3?{...n,_fragment:[n._fragment.reduce((r,s)=>U(r,s),[])]}:n)))}),ie=()=>{},Pt=({schema:{single:t,js:e,doc:n,copy:r,paste:s},doc:i,isBlock:a=ht,onChange:l,onKeyDown:f,onError:d=console.error})=>{let u=Fe(),T=!1,_=ie;const S=()=>L.get()[0],L=tt([n(i),u]),R=[];t&&R.push(Ot());const F=R.reduceRight((o,{apply:h})=>h?(N,C,w)=>h(te=>o(N,C,te),w):o,(o,h,N)=>Je(o,h,N,d)),m=[],A=o=>{T||(m.unshift(o),Xe(qe))},ee=new Set,Xe=o=>{ee.has(o)||(ee.add(o),_t(()=>{ee.delete(o),o()}))},qe=()=>{if(m.length){let o=S(),h=u,N;for(;N=m.pop();){const w=F(o,h,N);w&&(o=w[0],h=w[1])}const C=S();Ue(o,C)||(L.set([C,u]),L.push([o,h]),l(e(o))),u=h}};return{input:o=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return d("beforeinput event is not supported."),ie;const{contentEditable:h,role:N,ariaMultiLine:C,ariaReadOnly:w}=o,te=o.style.whiteSpace;o.role="textbox",o.style.whiteSpace="pre-wrap",o.ariaMultiLine="true",R.forEach(({mount:c})=>{c&&c(o)});let pe=!1,ne=!1,k=null,O=!1,X=!1,q=!1;const M=He(o),I={_document:M,_isBlock:a};_=()=>{o.contentEditable=T?"false":"true",o.ariaReadOnly=T?"true":null},_();const B=Rt(o,()=>{X&&Ie(M,o,u,I)}),H=()=>{u=St(o,I)},se=()=>{const c=B._flush();if(B._record(!1),c.length){let E;for(;E=c.pop();)if(E.type==="childList"){const{target:y,removedNodes:v,addedNodes:g,nextSibling:z}=E;for(let b=v.length-1;b>=0;b--)y.insertBefore(v[b],z);for(let b=g.length-1;b>=0;b--)y.removeChild(g[b])}else E.target.nodeValue=E.oldValue;B._flush(),ne=Ie(M,o,u,I)}A(k),O=!1,k=null},_e=c=>{if(!O){if(f&&f(c)){c.preventDefault();return}if((c.metaKey||c.ctrlKey)&&!c.altKey&&c.code==="KeyZ"&&(c.preventDefault(),B._record(!1),!T)){const E=c.shiftKey?L.redo():L.undo();E&&(l(e(E[0])),u=E[1])}}},Te=()=>{O||se()},he=c=>{c.preventDefault();const E=c.inputType;if(E.startsWith("format")||E==="historyUndo"||E==="historyRedo")return;O?B._record(!0):H();const y=c.getTargetRanges()[0];if(y){const v=Ve(o,I,y);let g=E==="insertParagraph"||E==="insertLineBreak"?`
`:c.data;if(g==null){const z=c.dataTransfer;z&&(g=z.getData("text/plain"))}k||(k=new K().select(...u)),P(...v)!==0&&k.delete(...v),g&&k.insert(v[0],g)}O||se()},ge=()=>{O||H(),O=!0},Ne=()=>{se()},ve=()=>{X=!0,H()},ye=()=>{X=!1},De=()=>{if(ne){ne=!1;return}X&&!O&&!q&&H()},re=c=>{H(),P(...u)!==0&&r(c,$e(S(),...G(u)),o)},Se=c=>{c.preventDefault(),re(c.clipboardData)},Le=c=>{c.preventDefault(),T||(re(c.clipboardData),A(new K().delete(...G(u))))},Re=c=>{c.preventDefault();const[E,y]=G(u);A(new K().delete(E,y).insertFragment(E,s(c.clipboardData,I)))},Oe=c=>{c.preventDefault();const E=c.dataTransfer,y=Lt(M,o,c,I);if(E&&y){const v=new K;q&&v.delete(...G(u));const g=v.transform(y);v.select(g,g).insertFragment(g,s(E,I)).select(g),A(v),o.focus({preventScroll:!0})}},xe=c=>{q=!0,re(c.dataTransfer)},Pe=()=>{q=!1};return M.addEventListener("selectionchange",De),o.addEventListener("keydown",_e),o.addEventListener("input",Te),o.addEventListener("beforeinput",he),o.addEventListener("compositionstart",ge),o.addEventListener("compositionend",Ne),o.addEventListener("focus",ve),o.addEventListener("blur",ye),o.addEventListener("copy",Se),o.addEventListener("cut",Le),o.addEventListener("paste",Re),o.addEventListener("drop",Oe),o.addEventListener("dragstart",xe),o.addEventListener("dragend",Pe),()=>{pe||(pe=!0,_=ie,o.contentEditable=h,o.role=N,o.ariaMultiLine=C,o.ariaReadOnly=w,o.style.whiteSpace=te,B._dispose(),M.removeEventListener("selectionchange",De),o.removeEventListener("keydown",_e),o.removeEventListener("input",Te),o.removeEventListener("beforeinput",he),o.removeEventListener("compositionstart",ge),o.removeEventListener("compositionend",Ne),o.removeEventListener("focus",ve),o.removeEventListener("blur",ye),o.removeEventListener("copy",Se),o.removeEventListener("cut",Le),o.removeEventListener("paste",Re),o.removeEventListener("drop",Oe),o.removeEventListener("dragstart",xe),o.removeEventListener("dragend",Pe))}},command:(o,...h)=>{const N=o(S(),u,...h);N&&A(N)},readonly:o=>{T=o,_()}}};export{K as T,Nt as a,Ke as b,Pt as c,ze as d,V as e,We as g,ut as i,xt as r,Ce as s,G as t};
