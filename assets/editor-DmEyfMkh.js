const X=([e],[t])=>e===t?0:e<t?1:-1,b=(e,t)=>{const n=X(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},W=([e,t])=>b(e,t)===-1?[t,e]:[e,t],st=Math.min,{keys:Be,is:rt}=Object,de=e=>typeof e=="string",ot=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},Fe=(e,t=n=>V(n)?n.text:"")=>e.reduce((n,s,o)=>(o!==0&&(n+=`
`),n+s.reduce((i,a)=>i+t(a),"")),""),ze=(e,t)=>e.split(`
`).map(n=>n?[{...t,text:n}]:[]),ee=1,G=2,te=3,ne=4,qe=e=>e._type!==ne;class q{constructor(t){this._ops=t?t.slice():[]}get ops(){return this._ops}insert(t,n){return this._ops.push({_type:G,_pos:t,_text:n}),this}insertFragment(t,n){return this._ops.push({_type:te,_pos:t,_fragment:n}),this}delete(t,n){return this._ops.push({_type:ee,_start:t,_end:n}),this}select(t,n){return this._ops.push({_type:ne,_anchor:t,_focus:n}),this}transform(t){return this._ops.reduce((n,s)=>qe(s)?pe(n,s):n,t)}}const it=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),V=e=>"text"in e,at=(e,t)=>{const n=Be(e);return n.length!==Be(t).length?!1:n.every(s=>s in t?s==="text"||rt(e[s],t[s]):!1)},Ge=e=>V(e)?e.text.length:1,Ye=e=>e.reduce((t,n)=>t+Ge(n),0),ct=(e,t=0,n=e.length-1)=>{let s=t+1;for(;s<=n;){const o=e[s-1],i=e[s];V(o)&&V(i)&&at(o,i)?(e[s-1]={...o,text:o.text+i.text},e.splice(s,1),n--):s++}},Ue=(e,t)=>{if(t.length){const n=e.length;e.push(...t),n&&ct(e,n-1,n)}},le=(...e)=>{const t=[];return e.forEach(n=>{Ue(t,n)}),t},H=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],o=Ge(s);if(o>t){const i=e.slice(0,n),a=e.slice(n+1);if(V(s)){const u=s.text.slice(0,t),c=s.text.slice(t);u&&i.push({...s,text:u}),c&&a.unshift({...s,text:c})}else a.unshift(s);return[i,a]}t-=o}return[e,[]]},ue=(e,t,n,s)=>{const[o]=n,[i]=s||n,[a,u]=H(e[n[0]],n[1]),c=s?H(e[s[0]],s[1])[1]:u;if(de(t)){const v=a.length;let p;if(v){const y=a[v-1];V(y)&&(p=y)}t=ze(t,p)}let f;t.length?(f=[...t],f[0]=le(a,f[0]),f[f.length-1]=le(f[f.length-1],c)):f=[le(a,c)];const h=e.slice();return h.splice(o,i-o+1,...f),h},lt=(e,t,n)=>X(t,n)===0?[H(H(e[t[0]],n[1])[0],t[1])[1]]:[H(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),H(e[n[0]],n[1])[0]],K=(e,[t,n])=>t>=0&&t<e.length&&n>=0&&n<=Ye(e[t]),ut=(e,t)=>{switch(t._type){case ee:{const{_start:n,_end:s}=t;return K(e,n)&&K(e,s)&&b(n,s)===1}case G:return K(e,t._pos)&&!!t._text;case te:return K(e,t._pos)&&!!Fe(t._fragment);case ne:return(!t._anchor||K(e,t._anchor))&&(!t._focus||K(e,t._focus))}},pe=(e,t)=>{switch(t._type){case ee:{const{_start:n,_end:s}=t;if(b(e,n)!==1)return b(s,e)===1?[e[0]+n[0]-s[0],e[1]+(X(s,e)===0?n[1]-s[1]:0)]:n;break}case G:case te:{const n=t._pos,s=t._type===G?ze(t._text):t._fragment,o=s.length,i=o-1;if(b(e,n)!==1)return[e[0]+i,e[1]+(X(e,n)===0?Ye(s[o-1])-(i===0?0:n[1]):0)];break}}return e},ft=(e,t,n,s)=>{try{for(const o of n.ops)if(ut(e,o)){switch(o._type){case ee:{e=ue(e,[],o._start,o._end);break}case G:{e=ue(e,o._text,o._pos);break}case te:{e=ue(e,o._fragment,o._pos);break}case ne:{(o._anchor||o._focus)&&(t=[o._anchor||t[0],o._focus||t[1]]);break}default:}qe(o)&&(t=[pe(t[0],o),pe(t[1],o)])}return[e,t]}catch(o){s&&s("rollback transaction: "+o);return}},dt=500,pt=500,ht=e=>{let t=0,n=0;const s=Date.now,o=[e],i=()=>o[t],a=()=>t>0,u=()=>t<o.length-1;return{get:i,set:c=>{o[t]=c},undo:()=>{if(a())return t--,i()},redo:()=>{if(u())return t++,i()},push:c=>{const f=s();t!==0&&f-n<pt&&t--,n=f,o[++t]=c,o.splice(t+1),t>dt&&(t--,o.shift())}}};let w,_,L,$,he=!1,Ee=!1,We;const Et=1,gt=4,_e=1,j=2,J=3,Te=4,_t=5,Tt=6,Nt=1,vt=3,yt=8,Dt=e=>e.nodeType===vt,Z=e=>e.nodeType===Nt,Lt=e=>e.nodeType===yt,St=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Xe=e=>e.contentEditable==="false"||St.has(e.tagName),ge=()=>_,$e=()=>L===_e?_.data.length:L===j?1:0,xt=e=>{w.currentNode=w.currentNode.parentNode.children[e]},Ae=e=>{const t=e.nextSibling;return!!t&&!Lt(t)},Ot=()=>{for(;;){if(L===j){const e=_;for(;(_=w.nextNode())&&e.contains(_););}else _=w.nextNode();if(L=null,!_)break;if($){if($.contains(_)){if(he=!0,Ee)break}else if(he)break}if(Dt(_)){const e=_.data;if(e)return e===`
`?L=Ae(_)?J:Tt:L=_e}else if(Z(_)){if(_.tagName==="BR")return L=Ae(_)?J:_t;if(Xe(_))return L=j;if(We(_))return L=Te}}},Ne=(e,t,{_document:n,_isBlock:s},o)=>{try{return We=s,w=n.createTreeWalker(t,gt|Et),o&&(o._startNode&&(w.currentNode=o._startNode,w.previousNode()),o._endNode&&($=o._endNode),Ee=o._excludeEnd||!1),e(Ot)}finally{w=_=L=$=null,he=Ee=!1}},wt=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),bt=e=>wt.has(e.tagName),mt=2,je=e=>e.ownerDocument,Je=e=>je(e).getSelection(),Rt=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},Ke=(e,t,n)=>{const s=Je(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},He=(e,t,[n,s],o)=>{const i=b(n,s),a=i===0,u=i===-1,c=u?s:n,f=u?n:s;if(c[0]===0&&c[1]===0&&a&&!t.hasChildNodes()){const S=e.createRange();return S.setStart(t,0),S.setEnd(t,0),Ke(t,S),!0}const h=Ve(t,c,o);if(!h)return!1;const v=a?h:Ve(t,f,o);if(!v)return!1;const p=e.createRange(),[y,F]=h,[k,C]=v;return Z(y)?F<1?p.setStartBefore(y):p.setStartAfter(y):p.setStart(y,F),Z(k)?C<1?p.setEndBefore(k):p.setEndAfter(k):p.setEnd(k,C),Ke(t,p,u),!0},Ve=(e,[t,n],s)=>Ne(o=>{let i,a=!1;for(;i=o();)if(i===Te)a||(a=!0,t!==0&&xt(t));else{const u=$e();if(n<=u)return[ge(),n];n-=u}},e,s),kt=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},Ct=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},Q=(e,t,n,s)=>{let o,i,a=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(Z(t)&&!Xe(t)&&t.hasChildNodes()){const c=st(n,t.childNodes.length-1);t=t.childNodes[c],a=c===n,n=0}const u=kt(e,t);return s._isBlock(u)?(o=u,i=Ct(o)):(o=e,i=0),Ne(c=>{let f,h=0;for(;f=c();)f===J?(i++,h=0):h+=$e();return[i,h+n]},o,s,{_endNode:t,_excludeEnd:a})},Ze=(e,t,{startOffset:n,startContainer:s,endOffset:o,endContainer:i})=>{const a=Q(e,s,n,t);return[a,s===i&&n===o?a:Q(e,i,o,t)]},Qe=()=>[[0,0],[0,0]],Pt=(e,t)=>e.compareDocumentPosition(t),It=(e,t)=>{const n=Je(e),s=Rt(n,e);if(!s)return Qe();const o=Ze(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(Pt(n.anchorNode,n.focusNode)&mt)!==0)?[o[1],o[0]]:o},Vt=(e,t,n,s)=>Ne(o=>{let i,a=null,u="",c=!1;const f=[],h=()=>{u&&(a||(a=[]),a.push(n(u)),u="")},v=()=>{h(),!a&&c&&(a=[]),a&&f.push(a),a=null,c=!1};for(;i=o();)if(i===Te)v();else if(c=!0,i===_e)u+=ge().data;else if(i===j){h();const p=s(ge());p&&a.push(p)}else i===J&&v();return v(),f.length||f.push([]),f},e,t),Mt=(e,t,{clientX:n,clientY:s},o)=>{if(e.caretPositionFromPoint){const i=e.caretPositionFromPoint(n,s);if(i)return Q(t,i.offsetNode,i.offset,o)}else if(e.caretRangeFromPoint){const i=e.caretRangeFromPoint(n,s);if(i)return Q(t,i.startContainer,i.startOffset,o)}},Bt=(e,t)=>{let n=!1;const s=[],o=u=>{n&&s.push(...u)},i=new MutationObserver(u=>{o(u),n||t()}),a=()=>{o(i.takeRecords())};return i.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(u){!n&&u&&a(),n=u},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),i.disconnect()}}},At=()=>({mount:e=>{e.ariaMultiLine=null},apply:(e,t)=>e(new q(t.ops.map(n=>n._type===2?{...n,_text:n._text.replaceAll(`
`,"")}:n._type===3?{...n,_fragment:[n._fragment.reduce((s,o)=>(Ue(s,o),s),[])]}:n)))}),Kt=e=>(t,n)=>{t.setData("text/plain",Fe(n,e))},Ht=()=>e=>e.getData("text/plain"),fe=()=>{},Ft=({doc:e,singleline:t,copy:n=[Kt()],paste:s=[Ht()],isBlock:o=bt,onChange:i,onKeyDown:a,onError:u=console.error})=>{let c=Qe(),f=!1,h=fe;const v=()=>p.get()[0],p=ht([e,c]),y=[];t&&y.push(At());const F=[r=>{if((r.metaKey||r.ctrlKey)&&!r.altKey&&r.code==="KeyZ"&&!f){const E=r.shiftKey?p.redo():p.undo();return E&&(i(E[0]),c=E[1]),!0}}];a&&F.push(a);const k=y.reduceRight((r,{apply:E})=>E?(x,P,m)=>E(oe=>r(x,P,oe),m):r,(r,E,x)=>ft(r,E,x,u)),C=[],S=r=>{f||(C.unshift(r),et(tt))},se=new Set,et=r=>{se.has(r)||(se.add(r),ot(()=>{se.delete(r),r()}))},tt=()=>{if(C.length){let r=v(),E=c,x;for(;x=C.pop();){const m=k(r,E,x);m&&(r=m[0],E=m[1])}const P=v();it(r,P)||(p.set([P,c]),p.push([r,E]),i(r)),c=E}},re={get doc(){return v()},get selection(){return c},get readonly(){return f},set readonly(r){f=r,h()},apply:(r,...E)=>(typeof r=="function"?r.call(re,...E):S(r),re),input:r=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return u("beforeinput event is not supported."),fe;const{contentEditable:E,role:x,ariaMultiLine:P,ariaReadOnly:m}=r,oe=r.style.whiteSpace;r.role="textbox",r.style.whiteSpace="pre-wrap",r.ariaMultiLine="true",y.forEach(({mount:l})=>{l&&l(r)});let ve=!1,ie=!1,I=null,O=!1,Y=!1,U=!1;const M=je(r),B={_document:M,_isBlock:o};h=()=>{r.contentEditable=f?"false":"true",r.ariaReadOnly=f?"true":null},h();const nt=(l,d)=>{for(const g of n)g(l,d,r)},ye=l=>{for(const d of s){const g=d(l,B);if(g)return g}u("failed to serialize pasted data")},A=Bt(r,()=>{Y&&He(M,r,c,B)}),z=()=>{c=It(r,B)},ae=()=>{const l=A._flush();if(A._record(!1),l.length){let d;for(;d=l.pop();)if(d.type==="childList"){const{target:g,removedNodes:T,addedNodes:N,nextSibling:D}=d;for(let R=T.length-1;R>=0;R--)g.insertBefore(T[R],D);for(let R=N.length-1;R>=0;R--)g.removeChild(N[R])}else d.target.nodeValue=d.oldValue;A._flush(),ie=He(M,r,c,B)}S(I),O=!1,I=null},De=l=>{if(!O){for(const d of F)if(d(l)){l.preventDefault(),A._record(!1);return}}},Le=()=>{O||ae()},Se=l=>{l.preventDefault();const d=l.inputType;if(d.startsWith("format")||d==="historyUndo"||d==="historyRedo")return;O?A._record(!0):z();const g=l.getTargetRanges()[0];if(g){const T=Ze(r,B,g);let N=d==="insertParagraph"||d==="insertLineBreak"?`
`:l.data;if(N==null){const D=l.dataTransfer;D&&(N=D.getData("text/plain"))}I||(I=new q().select(...c)),b(...T)!==0&&I.delete(...T),N&&I.insert(T[0],N)}O||ae()},xe=()=>{O||z(),O=!0},Oe=()=>{ae()},we=()=>{Y=!0,z()},be=()=>{Y=!1},me=()=>{if(ie){ie=!1;return}Y&&!O&&!U&&z()},ce=l=>{z(),b(...c)!==0&&nt(l,lt(v(),...W(c)))},Re=l=>{l.preventDefault(),ce(l.clipboardData)},ke=l=>{l.preventDefault(),f||(ce(l.clipboardData),S(new q().delete(...W(c))))},Ce=l=>{l.preventDefault();const d=ye(l.clipboardData);if(d){const[g,T]=W(c),N=new q().delete(g,T);de(d)?N.insert(g,d):N.insertFragment(g,d),S(N)}},Pe=l=>{l.preventDefault();const d=l.dataTransfer,g=Mt(M,r,l,B);if(d&&g){const T=new q;U&&T.delete(...W(c));const N=ye(d);if(N){const D=T.transform(g);T.select(D,D),de(N)?T.insert(D,N):T.insertFragment(D,N),T.select(D)}S(T),r.focus({preventScroll:!0})}},Ie=l=>{U=!0,ce(l.dataTransfer)},Me=()=>{U=!1};return M.addEventListener("selectionchange",me),r.addEventListener("keydown",De),r.addEventListener("input",Le),r.addEventListener("beforeinput",Se),r.addEventListener("compositionstart",xe),r.addEventListener("compositionend",Oe),r.addEventListener("focus",we),r.addEventListener("blur",be),r.addEventListener("copy",Re),r.addEventListener("cut",ke),r.addEventListener("paste",Ce),r.addEventListener("drop",Pe),r.addEventListener("dragstart",Ie),r.addEventListener("dragend",Me),()=>{ve||(ve=!0,h=fe,r.contentEditable=E,r.role=x,r.ariaMultiLine=P,r.ariaReadOnly=m,r.style.whiteSpace=oe,A._dispose(),M.removeEventListener("selectionchange",me),r.removeEventListener("keydown",De),r.removeEventListener("input",Le),r.removeEventListener("beforeinput",Se),r.removeEventListener("compositionstart",xe),r.removeEventListener("compositionend",Oe),r.removeEventListener("focus",we),r.removeEventListener("blur",be),r.removeEventListener("copy",Re),r.removeEventListener("cut",ke),r.removeEventListener("paste",Ce),r.removeEventListener("drop",Pe),r.removeEventListener("dragstart",Ie),r.removeEventListener("dragend",Me))}}};return re};export{q as T,Rt as a,Je as b,Ft as c,Fe as d,Ht as e,Ye as g,Lt as i,Kt as p,Vt as r,ze as s,W as t};
