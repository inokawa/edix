const U=([t],[e])=>t===e?0:t<e?1:-1,m=(t,e)=>{const n=U(t,e);return n===0?t[1]===e[1]?0:t[1]<e[1]?1:-1:n},z=([t,e])=>m(t,e)===-1?[e,t]:[t,e],Xe=(t,e=n=>K(n)?n.text:"")=>t.reduce((n,s,r)=>(r!==0&&(n+=`
`),n+s.reduce((i,a)=>i+e(a),"")),""),we=t=>t.split(`
`).map(e=>e?[{text:e}]:[]);const Ie=t=>t._type!==4;class H{constructor(e){this._ops=e?e.slice():[]}get ops(){return this._ops}insert(e,n){return this._ops.push({_type:2,_pos:e,_text:n}),this}insertFragment(e,n){return this._ops.push({_type:3,_pos:e,_fragment:n}),this}delete(e,n){return this._ops.push({_type:1,_start:e,_end:n}),this}select(e,n){return this._ops.push({_type:4,_anchor:e,_focus:n}),this}transform(e){return this._ops.reduce((n,s)=>Ie(s)?re(n,s):n,e)}}const qe=(t,e,n,s)=>{const r=t.slice();return r.splice(e,n,...s),r},ze=(t,e)=>t.length===e.length&&t.every((n,s)=>n===e[s]),K=t=>"text"in t,be=t=>K(t)?t.text.length:1,Ge=t=>t.reduce((e,n)=>e+be(n),0),G=(t,e)=>{const n=[...t];if(!n.length)n.push(...e);else for(const s of e){const r=n.length-1,i=n[r];K(s)&&K(i)?n[r]={text:i.text+s.text}:n.push(s)}return n},B=(t,e)=>{for(let n=0;n<t.length;n++){const s=t[n],r=be(s);if(r>e){const i=t.slice(0,n),a=t.slice(n+1);if(K(s)){const l=s.text.slice(0,e),f=s.text.slice(e);l&&i.push({text:l}),f&&a.unshift({text:f})}else a.unshift(s);return[i,a]}e-=r}return[t,[]]},ne=(t,e,n,s)=>{const[r]=n,[i]=s||n,a=B(t[n[0]],n[1]),l=a[0],f=s?B(t[s[0]],s[1])[1]:a[1],d=[...e];return d.length?(d[0]=G(l,d[0]),d[d.length-1]=G(d[d.length-1],f)):d.push(G(l,f)),qe(t,r,i-r+1,d)},Ue=(t,e,n)=>U(e,n)===0?[B(B(t[e[0]],n[1])[0],e[1])[1]]:[B(t[e[0]],e[1])[1],...t.slice(e[0]+1,n[0]),B(t[n[0]],n[1])[0]],We=t=>{switch(t._type){case 1:return m(t._start,t._end)===1;case 2:return!!t._text;case 3:return!!Xe(t._fragment)}return!0},$e=(t,e)=>{switch(e._type){case 1:return ne(t,[],e._start,e._end);case 2:return ne(t,we(e._text),e._pos);case 3:return ne(t,e._fragment,e._pos);default:return e}},re=(t,e)=>{switch(e._type){case 1:{const{_start:n,_end:s}=e;if(m(t,n)!==1)return m(s,t)===1?[t[0]+n[0]-s[0],t[1]+(U(s,t)===0?n[1]-s[1]:0)]:n;break}case 2:case 3:{const n=e._pos,s=e._type===2?we(e._text):e._fragment,r=s.length,i=r-1;if(m(t,n)!==1)return[t[0]+i,t[1]+(U(t,n)===0?Ge(s[r-1])-(i===0?0:n[1]):0)];break}}return t},je=(t,e,n,s)=>{try{for(const r of n.ops)We(r)&&(Ie(r)?(t=$e(t,r),e=[re(e[0],r),re(e[1],r)]):(r._anchor||r._focus)&&(e=[r._anchor||e[0],r._focus||e[1]]));return[t,e]}catch(r){s&&s("rollback transaction: "+r);return}},Ze=500,Je=500,Qe=t=>{let e=0,n=0;const s=Date.now,r=[t],i=()=>r[e],a=()=>e>0,l=()=>e<r.length-1;return{get:i,set:f=>{r[e]=f},undo:()=>{if(a())return e--,i()},redo:()=>{if(l())return e++,i()},push:f=>{const d=s();e!==0&&d-n<Je&&e--,n=d,r[++e]=f,r.splice(e+1),e>Ze&&(e--,r.shift())}}};let P,_,v,W,oe=!1,ie=!1,Ce;const et=1,tt=4,ae=1,$=2,j=3,le=4,nt=5,st=6,rt=1,ot=3,it=8,ct=t=>t.nodeType===ot,Z=t=>t.nodeType===rt,at=t=>t.nodeType===it,lt=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),ke=t=>t.contentEditable==="false"||lt.has(t.tagName),ce=()=>_,Me=()=>v===ae?_.data.length:v===$?1:0,ut=t=>{P.currentNode=P.currentNode.parentNode.children[t]},Re=t=>{const e=t.nextSibling;return!!e&&!at(e)},ft=()=>{for(;;){if(v===$){const t=_;for(;(_=P.nextNode())&&t.contains(_););}else _=P.nextNode();if(v=null,!_)break;if(W){if(W.contains(_)){if(oe=!0,ie)break}else if(oe)break}if(ct(_)){const t=_.data;if(t)return t===`
`?v=Re(_)?j:st:v=ae}else if(Z(_)){if(_.tagName==="BR")return v=Re(_)?j:nt;if(ke(_))return v=$;if(Ce(_))return v=le}}},ue=(t,e,{_document:n,_isBlock:s},r)=>{try{return Ce=s,P=n.createTreeWalker(e,tt|et),r&&(r._startNode&&(P.currentNode=r._startNode,P.previousNode()),r._endNode&&(W=r._endNode),ie=r._excludeEnd||!1),t(ft)}finally{P=_=v=W=null,oe=ie=!1}},dt=Math.min,Et=typeof queueMicrotask=="function"?queueMicrotask:t=>{Promise.resolve().then(t)},_t=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),pt=t=>_t.has(t.tagName),Tt=2,Be=t=>t.ownerDocument,Ye=t=>Be(t).getSelection(),ht=(t,e)=>{if(t.rangeCount){const n=t.getRangeAt(0);if(e.contains(n.commonAncestorContainer))return n}},xe=(t,e,n)=>{const s=Ye(t);s.removeAllRanges(),s.addRange(e),n&&(s.collapseToEnd(),s.extend(e.startContainer,e.startOffset))},Pe=(t,e,[n,s],r)=>{const i=m(n,s),a=i===0,l=i===-1,f=l?s:n,d=l?n:s;if(f[0]===0&&f[1]===0&&a&&!e.hasChildNodes()){const w=t.createRange();return w.setStart(e,0),w.setEnd(e,0),xe(e,w),!0}const u=me(e,f,r);if(!u)return!1;const T=a?u:me(e,d,r);if(!T)return!1;const p=t.createRange(),[D,S]=u,[L,O]=T;return Z(D)?S<1?p.setStartBefore(D):p.setStartAfter(D):p.setStart(D,S),Z(L)?O<1?p.setEndBefore(L):p.setEndAfter(L):p.setEnd(L,O),xe(e,p,l),!0},me=(t,[e,n],s)=>ue(r=>{let i,a=!1;for(;i=r();)if(i===le)a||(a=!0,e!==0&&ut(e));else{const l=Me();if(n<=l)return[ce(),n];n-=l}},t,s),gt=(t,e)=>{let n=e;for(;;){const s=n.parentElement;if(s===t)break;n=s}return n},Nt=t=>{let e=0;for(;t=t.previousElementSibling;)e++;return e},J=(t,e,n,s)=>{let r,i,a=!0;if(t===e&&!e.hasChildNodes())return[0,0];if(Z(e)&&!ke(e)&&e.hasChildNodes()){const f=dt(n,e.childNodes.length-1);e=e.childNodes[f],a=f===n,n=0}const l=gt(t,e);return s._isBlock(l)?(r=l,i=Nt(r)):(r=t,i=0),ue(f=>{let d,u=0;for(;d=f();)d===j?(i++,u=0):u+=Me();return[i,u+n]},r,s,{_endNode:e,_excludeEnd:a})},Ae=(t,e,{startOffset:n,startContainer:s,endOffset:r,endContainer:i})=>{const a=J(t,s,n,e);return[a,s===i&&n===r?a:J(t,i,r,e)]},He=()=>[[0,0],[0,0]],vt=(t,e)=>t.compareDocumentPosition(e),Dt=(t,e)=>{const n=Ye(t),s=ht(n,t);if(!s)return He();const r=Ae(t,e,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(vt(n.anchorNode,n.focusNode)&Tt)!==0)?[r[1],r[0]]:r},Ot=(t,e,n)=>ue(s=>{let r,i=null,a="",l=!1;const f=[],d=()=>{a&&(i||(i=[]),i.push({text:a}),a="")},u=()=>{d(),!i&&l&&(i=[]),i&&f.push(i),i=null,l=!1};for(;r=s();)if(r===le)u();else if(l=!0,r===ae){const T=ce();a+=T.data}else if(r===$){d();const T=ce(),p=n(T);p&&i.push({data:p})}else r===j&&u();return u(),f.length||f.push([]),f},t,e),yt=(t,e,{clientX:n,clientY:s},r)=>{if(t.caretPositionFromPoint){const i=t.caretPositionFromPoint(n,s);if(i)return J(e,i.offsetNode,i.offset,r)}else if(t.caretRangeFromPoint){const i=t.caretRangeFromPoint(n,s);if(i)return J(e,i.startContainer,i.startOffset,r)}},St=(t,e)=>{let n=!1;const s=[],r=l=>{n&&s.push(...l)},i=new MutationObserver(l=>{r(l),n||e()}),a=()=>{r(i.takeRecords())};return i.observe(t,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(l){!n&&l&&a(),n=l},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),i.disconnect()}}},Lt=t=>new H(t.ops.map(e=>e._type===2?{...e,_text:e._text.replaceAll(`
`,"")}:e._type===3?{...e,_fragment:[e._fragment.reduce((n,s)=>G(n,s),[])]}:e)),se=()=>{},Rt=({schema:{single:t,js:e,doc:n,copy:s,paste:r},doc:i,isBlock:a=pt,onChange:l,onKeyDown:f,onError:d=console.error})=>{let u=He(),T=!1,p=se;const D=()=>S.get()[0],S=Qe([n(i),u]),L=[],O=o=>{T||(L.unshift(o),Ke(Ve))},w=new Set,Ke=o=>{w.has(o)||(w.add(o),Et(()=>{w.delete(o),o()}))},Ve=()=>{if(L.length){let o=D(),R=u,y;for(;y=L.pop();){t&&(y=Lt(y));const Y=je(o,R,y,d);Y&&(o=Y[0],R=Y[1])}const V=D();ze(o,V)||(S.set([V,u]),S.push([o,R]),l(e(o))),u=R}};return{input:o=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return d("beforeinput event is not supported."),se;const{contentEditable:R,role:y,ariaMultiLine:V,ariaReadOnly:Y}=o,Fe=o.style.whiteSpace;o.role="textbox",o.style.whiteSpace="pre-wrap",t||(o.ariaMultiLine="true");let fe=!1,Q=!1,C=null,x=!1,F=!1,X=!1;const k=Be(o),I={_document:k,_isBlock:a};p=()=>{o.contentEditable=T?"false":"true",o.ariaReadOnly=T?"true":null},p();const M=St(o,()=>{F&&Pe(k,o,u,I)}),A=()=>{u=Dt(o,I)},ee=()=>{const c=M._flush();if(M._record(!1),c.length){let E;for(;E=c.pop();)if(E.type==="childList"){const{target:N,removedNodes:g,addedNodes:h,nextSibling:q}=E;for(let b=g.length-1;b>=0;b--)N.insertBefore(g[b],q);for(let b=h.length-1;b>=0;b--)N.removeChild(h[b])}else E.target.nodeValue=E.oldValue;M._flush(),Q=Pe(k,o,u,I)}O(C),x=!1,C=null},de=c=>{if(!x){if(f&&f(c)){c.preventDefault();return}if((c.metaKey||c.ctrlKey)&&!c.altKey&&c.code==="KeyZ"&&(c.preventDefault(),M._record(!1),!T)){const E=c.shiftKey?S.redo():S.undo();E&&(l(e(E[0])),u=E[1])}}},Ee=()=>{x||ee()},_e=c=>{c.preventDefault();const E=c.inputType;if(E.startsWith("format")||E==="historyUndo"||E==="historyRedo")return;x?M._record(!0):A();const N=c.getTargetRanges()[0];if(N){const g=Ae(o,I,N);let h=E==="insertParagraph"||E==="insertLineBreak"?`
`:c.data;if(h==null){const q=c.dataTransfer;q&&(h=q.getData("text/plain"))}C||(C=new H().select(...u)),m(...g)!==0&&C.delete(...g),h&&C.insert(g[0],h)}x||ee()},pe=()=>{x||A(),x=!0},Te=()=>{ee()},he=()=>{F=!0,A()},ge=()=>{F=!1},Ne=()=>{if(Q){Q=!1;return}F&&!x&&!X&&A()},te=c=>{A(),m(...u)!==0&&s(c,Ue(D(),...z(u)),o)},ve=c=>{c.preventDefault(),te(c.clipboardData)},De=c=>{c.preventDefault(),T||(te(c.clipboardData),O(new H().delete(...z(u))))},ye=c=>{c.preventDefault();const[E,N]=z(u);O(new H().delete(E,N).insertFragment(E,r(c.clipboardData,I)))},Se=c=>{c.preventDefault();const E=c.dataTransfer,N=yt(k,o,c,I);if(E&&N){const g=new H;X&&g.delete(...z(u));const h=g.transform(N);g.select(h,h).insertFragment(h,r(E,I)).select(h),O(g),o.focus({preventScroll:!0})}},Le=c=>{X=!0,te(c.dataTransfer)},Oe=()=>{X=!1};return k.addEventListener("selectionchange",Ne),o.addEventListener("keydown",de),o.addEventListener("input",Ee),o.addEventListener("beforeinput",_e),o.addEventListener("compositionstart",pe),o.addEventListener("compositionend",Te),o.addEventListener("focus",he),o.addEventListener("blur",ge),o.addEventListener("copy",ve),o.addEventListener("cut",De),o.addEventListener("paste",ye),o.addEventListener("drop",Se),o.addEventListener("dragstart",Le),o.addEventListener("dragend",Oe),()=>{fe||(fe=!0,p=se,o.contentEditable=R,o.role=y,o.ariaMultiLine=V,o.ariaReadOnly=Y,o.style.whiteSpace=Fe,M._dispose(),k.removeEventListener("selectionchange",Ne),o.removeEventListener("keydown",de),o.removeEventListener("input",Ee),o.removeEventListener("beforeinput",_e),o.removeEventListener("compositionstart",pe),o.removeEventListener("compositionend",Te),o.removeEventListener("focus",he),o.removeEventListener("blur",ge),o.removeEventListener("copy",ve),o.removeEventListener("cut",De),o.removeEventListener("paste",ye),o.removeEventListener("drop",Se),o.removeEventListener("dragstart",Le),o.removeEventListener("dragend",Oe))}},command:(o,...R)=>{const y=o(D(),u,...R);y&&O(y)},readonly:o=>{T=o,p()}}};export{H as T,ht as a,Ye as b,Rt as c,Xe as d,K as e,Ge as g,at as i,Ot as r,we as s,z as t};
