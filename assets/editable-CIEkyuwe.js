const U=([e],[t])=>e===t?0:e<t?1:-1,m=(e,t)=>{const n=U(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},z=([e,t])=>m(e,t)===-1?[t,e]:[e,t],Ve=(e,t)=>e.reduce((n,s,o)=>(o!==0&&(n+=`
`),n+s.reduce((r,a)=>r+(H(a)?a.text:t?t(a):""),"")),""),Fe=e=>e.split(`
`).map(t=>t?[{text:t}]:[]);const we=e=>e._type!==3;class w extends Array{static from(t){return new w(...t)}insert(t,n){return this.push({_type:2,_pos:t,_fragment:n}),this}delete(t,n){return this.push({_type:1,_start:t,_end:n}),this}select(t,n){return this.push({_type:3,_anchor:t,_focus:n}),this}rebasePos(t){return this.reduce((n,s)=>we(s)?se(n,s):n,t)}}const qe=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),H=e=>"text"in e,Pe=e=>H(e)?e.text.length:1,ze=e=>e.reduce((t,n)=>t+Pe(n),0),G=(e,t)=>{const n=[...e];if(!n.length)n.push(...t);else for(const s of t){const o=n.length-1,r=n[o];H(s)&&H(r)?n[o]={text:r.text+s.text}:n.push(s)}return n},I=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],o=Pe(s);if(o>t){const r=e.slice(0,n),a=e.slice(n+1);if(H(s)){const c=s.text.slice(0,t),u=s.text.slice(t);c&&r.push({text:c}),u&&a.unshift({text:u})}else a.unshift(s);return[r,a]}t-=o}return[e,[]]},me=(e,t,n,s)=>{const[o]=n,[r]=s||n,a=I(e[n[0]],n[1]),c=a[0],u=s?I(e[s[0]],s[1])[1]:a[1],d=[...t];d.length?(d[0]=G(c,d[0]),d[d.length-1]=G(d[d.length-1],u)):d.push(G(c,u)),e.splice(o,r-o+1,...d)},Ge=(e,t,n)=>U(t,n)===0?[I(I(e[t[0]],n[1])[0],t[1])[1]]:[I(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),I(e[n[0]],n[1])[0]],Ue=e=>{switch(e._type){case 1:return m(e._start,e._end)===1;case 2:return!!Ve(e._fragment)}return!0},We=(e,t)=>{switch(t._type){case 1:{me(e,[],t._start,t._end);break}case 2:{me(e,t._fragment,t._pos);break}}},se=(e,t)=>{switch(t._type){case 1:{const{_start:n,_end:s}=t;if(m(e,n)!==1)return m(s,e)===1?[e[0]+n[0]-s[0],e[1]+(U(s,e)===0?n[1]-s[1]:0)]:n;break}case 2:{const{_pos:n,_fragment:s}=t,o=s.length,r=o-1;if(m(e,n)!==1)return[e[0]+r,e[1]+(U(e,n)===0?ze(s[o-1])-(r===0?0:n[1]):0)];break}}return e},Xe=(e,t,n)=>{const s=[...e],o=[...t];try{for(const r of n)Ue(r)&&(we(r)?(We(e,r),t[0]=se(t[0],r),t[1]=se(t[1],r)):(r._anchor&&(t[0]=r._anchor),r._focus&&(t[1]=r._focus)))}catch(r){console.error("rollback transaction:",r),e.length=0,e.push(...s),t[0]=o[0],t[1]=o[1]}},$e=500,je=500,Qe=e=>{let t=0,n=0;const s=Date.now,o=[e],r=()=>o[t],a=()=>t>0,c=()=>t<o.length-1;return{get:r,set:u=>{o[t]=u},undo:()=>{if(a())return t--,r()},redo:()=>{if(c())return t++,r()},push:u=>{const d=s();t!==0&&d-n<je&&t--,n=d,o[++t]=u,o.splice(t+1),t>$e&&(t--,o.shift())}}};let O,p,v,W,re=!1,oe=!1,Ce;const Ze=1,Je=4,ae=1,X=2,$=3,ce=4,et=5,tt=6,nt=1,st=3,rt=8,ot=e=>e.nodeType===st,j=e=>e.nodeType===nt,it=e=>e.nodeType===rt,at=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),ke=e=>e.contentEditable==="false"||at.has(e.tagName),ie=()=>p,Ie=()=>v===ae?p.data.length:v===X?1:0,ct=e=>{O.currentNode=O.currentNode.parentNode.children[e]},xe=e=>{const t=e.nextSibling;return!!t&&!it(t)},lt=()=>{for(;;){if(v===X){const e=p;for(;(p=O.nextNode())&&e.contains(p););}else p=O.nextNode();if(v=null,!p)break;if(W){if(W.contains(p)){if(re=!0,oe)break}else if(re)break}if(ot(p)){const e=p.data;if(e)return e===`
`?v=xe(p)?$:tt:v=ae}else if(j(p)){if(p.tagName==="BR")return v=xe(p)?$:et;if(ke(p))return v=X;if(Ce(p))return v=ce}}},le=(e,t,{_document:n,_isBlock:s},o)=>{try{return Ce=s,O=n.createTreeWalker(t,Je|Ze),o&&(o._startNode&&(O.currentNode=o._startNode,O.previousNode()),o._endNode&&(W=o._endNode),oe=o._excludeEnd||!1),e(lt)}finally{O=p=v=W=null,re=oe=!1}},ut=Math.min,dt=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},ft=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),Et=e=>ft.has(e.tagName),pt=2,Me=e=>e.ownerDocument,Be=e=>Me(e).getSelection(),ht=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},Re=(e,t,n)=>{const s=Be(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},ne=(e,t,[n,s],o)=>{const r=m(n,s),a=r===0,c=r===-1,u=c?s:n,d=c?n:s;if(u[0]===0&&u[1]===0&&a&&!t.hasChildNodes()){const f=e.createRange();return f.setStart(t,0),f.setEnd(t,0),Re(t,f),!0}const g=be(t,u,o);if(!g)return!1;const L=a?g:be(t,d,o);if(!L)return!1;const T=e.createRange(),[N,y]=g,[x,P]=L;return j(N)?y<1?T.setStartBefore(N):T.setStartAfter(N):T.setStart(N,y),j(x)?P<1?T.setEndBefore(x):T.setEndAfter(x):T.setEnd(x,P),Re(t,T,c),!0},be=(e,[t,n],s)=>le(o=>{let r,a=!1;for(;r=o();)if(r===ce)a||(a=!0,t!==0&&ct(t));else{const c=Ie();if(n<=c)return[ie(),n];n-=c}},e,s),gt=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},Tt=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},Q=(e,t,n,s)=>{let o,r,a=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(j(t)&&!ke(t)&&t.hasChildNodes()){const u=ut(n,t.childNodes.length-1);t=t.childNodes[u],a=u===n,n=0}const c=gt(e,t);return s._isBlock(c)?(o=c,r=Tt(o)):(o=e,r=0),le(u=>{let d,g=0;for(;d=u();)d===$?(r++,g=0):g+=Ie();return[r,g+n]},o,s,{_endNode:t,_excludeEnd:a})},Ae=(e,t,{startOffset:n,startContainer:s,endOffset:o,endContainer:r})=>{const a=Q(e,s,n,t);return[a,s===r&&n===o?a:Q(e,r,o,t)]},He=()=>[[0,0],[0,0]],_t=(e,t)=>e.compareDocumentPosition(t),Nt=(e,t)=>{const n=Be(e),s=ht(n,e);if(!s)return He();const o=Ae(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(_t(n.anchorNode,n.focusNode)&pt)!==0)?[o[1],o[0]]:o},vt=(e,t,n,s)=>le(o=>{let r,a=null,c="",u=!1;const d=[],g=()=>{c&&(a||(a=[]),a.push({text:c}),c="")},L=()=>{g(),!a&&u&&(a=[]),a&&d.push(a),a=null,u=!1};for(;r=o();)if(r===ce)L();else if(u=!0,r===ae){let N=ie().data;c+=N}else if(r===X){g();const T=ie(),N=n(T);N&&a.push({data:N})}else r===$&&L();return L(),d.length||d.push([]),d},e,t,s),yt=(e,t,{clientX:n,clientY:s},o)=>{if(e.caretPositionFromPoint){const r=e.caretPositionFromPoint(n,s);if(r)return Q(t,r.offsetNode,r.offset,o)}else if(e.caretRangeFromPoint){const r=e.caretRangeFromPoint(n,s);if(r)return Q(t,r.startContainer,r.startOffset,o)}},Dt=(e,t)=>{let n=!1;const s=[],o=c=>{n&&s.push(...c)},r=new MutationObserver(c=>{o(c),n||t()}),a=()=>{o(r.takeRecords())};return r.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(c){!n&&c&&a(),n=c},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),r.disconnect()}}},Lt=e=>w.from(e.map(t=>t._type===2?{...t,_fragment:[t._fragment.reduce((n,s)=>G(n,s),[])]}:t)),St=(e,{schema:{single:t,js:n,void:s,copy:o,paste:r},isBlock:a=Et,onChange:c,onKeyDown:u})=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function")){console.error("beforeinput event is not supported.");const i=()=>{};return{dispose:i,command:i,readonly:i}}const{contentEditable:d,role:g,ariaMultiLine:L,ariaReadOnly:T}=e,N=e.style.whiteSpace;e.role="textbox",e.style.whiteSpace="pre-wrap",t||(e.ariaMultiLine="true");let y=!1,x=!1,P=!1,f=He(),C=null,K=null,S=!1,Y=!1,V=!1;const R=Me(e),D={_document:R,_isBlock:a},ue=()=>{e.contentEditable=y?"false":"true",e.ariaReadOnly=y?"true":null};ue();const F=()=>B.get()[0],Z=[],M=i=>{y||(Z.unshift(i),Ke(Ye))},B=Qe([vt(e,D,s),f]),k=Dt(e,()=>{Y&&(ne(R,e,f,D),K!=null&&(clearTimeout(K),K=null))}),J=new Set,Ke=i=>{J.has(i)||(J.add(i),dt(()=>{J.delete(i),i()}))},de=i=>{f=i,K=setTimeout(()=>{ne(R,e,i,D)})},A=()=>{f=Nt(e,D)},ee=()=>{const i=k._flush();if(k._record(!1),i.length){let l;for(;l=i.pop();)if(l.type==="childList"){const{target:E,removedNodes:h,addedNodes:_,nextSibling:q}=l;for(let b=h.length-1;b>=0;b--)E.insertBefore(h[b],q);for(let b=_.length-1;b>=0;b--)E.removeChild(_[b])}else l.target.nodeValue=l.oldValue;k._flush()}M(C),S=!1,C=null,P=ne(R,e,f,D)},Ye=()=>{if(Z.length){let i=[...F()],l=[...f],E;for(;E=Z.pop();)t&&(E=Lt(E)),Xe(i,l,E);const h=F();qe(i,h)||(B.set([h,f]),B.push([i,l]),c(n(i))),de(l)}},fe=i=>{if(!S){if(u&&u(i)){i.preventDefault();return}if((i.metaKey||i.ctrlKey)&&!i.altKey&&i.code==="KeyZ"&&(i.preventDefault(),k._record(!1),!y)){const l=i.shiftKey?B.redo():B.undo();l&&(c(n(l[0])),de(l[1]))}}},Ee=()=>{S||ee()},pe=i=>{i.preventDefault();const l=i.inputType;if(l.startsWith("format")||l==="historyUndo"||l==="historyRedo")return;S?k._record(!0):A();const E=i.getTargetRanges()[0];if(E){const h=Ae(e,D,E);let _=l==="insertParagraph"||l==="insertLineBreak"?`
`:i.data;if(_==null){const q=i.dataTransfer;q&&(_=q.getData("text/plain"))}C||(C=new w().select(...f)),m(...h)!==0&&C.delete(...h),_&&C.insert(h[0],Fe(_))}S||ee()},he=()=>{S||A(),S=!0},ge=()=>{ee()},Te=()=>{Y=!0,A()},_e=()=>{Y=!1},Ne=()=>{if(P){P=!1;return}Y&&!S&&!V&&A()},te=i=>{A(),m(...f)!==0&&o(i,Ge(F(),...z(f)),e)},ve=i=>{i.preventDefault(),te(i.clipboardData)},ye=i=>{i.preventDefault(),y||(te(i.clipboardData),M(new w().delete(...z(f))))},De=i=>{i.preventDefault();const[l,E]=z(f);M(new w().delete(l,E).insert(l,r(i.clipboardData,D)))},Le=i=>{i.preventDefault();const l=i.dataTransfer,E=yt(R,e,i,D);if(l&&E){const h=new w;V&&h.delete(...z(f));const _=h.rebasePos(E);h.select(_,_).insert(_,r(l,D)).select(_),M(h),e.focus({preventScroll:!0})}},Se=i=>{V=!0,te(i.dataTransfer)},Oe=()=>{V=!1};return R.addEventListener("selectionchange",Ne),e.addEventListener("keydown",fe),e.addEventListener("input",Ee),e.addEventListener("beforeinput",pe),e.addEventListener("compositionstart",he),e.addEventListener("compositionend",ge),e.addEventListener("focus",Te),e.addEventListener("blur",_e),e.addEventListener("copy",ve),e.addEventListener("cut",ye),e.addEventListener("paste",De),e.addEventListener("drop",Le),e.addEventListener("dragstart",Se),e.addEventListener("dragend",Oe),{dispose:()=>{x||(x=!0,e.contentEditable=d,e.role=g,e.ariaMultiLine=L,e.ariaReadOnly=T,e.style.whiteSpace=N,k._dispose(),R.removeEventListener("selectionchange",Ne),e.removeEventListener("keydown",fe),e.removeEventListener("input",Ee),e.removeEventListener("beforeinput",pe),e.removeEventListener("compositionstart",he),e.removeEventListener("compositionend",ge),e.removeEventListener("focus",Te),e.removeEventListener("blur",_e),e.removeEventListener("copy",ve),e.removeEventListener("cut",ye),e.removeEventListener("paste",De),e.removeEventListener("drop",Le),e.removeEventListener("dragstart",Se),e.removeEventListener("dragend",Oe))},command:(i,...l)=>{const E=i(F(),f,...l);E&&M(E)},readonly:i=>{y=i,ue()}}};export{w as T,vt as a,ht as b,Be as c,Ve as d,St as e,H as f,ze as g,it as i,z as r,Fe as s};
