const G=([t],[e])=>t===e?0:t<e?1:-1,P=(t,e)=>{const n=G(t,e);return n===0?t[1]===e[1]?0:t[1]<e[1]?1:-1:n},q=([t,e])=>P(t,e)===-1?[e,t]:[t,e],ze=(t,e=n=>H(n)?n.text:"")=>t.reduce((n,s,o)=>(o!==0&&(n+=`
`),n+s.reduce((i,c)=>i+e(c),"")),""),we=t=>t.split(`
`).map(e=>e?[{text:e}]:[]);const Ie=t=>t._type!==4;class A{constructor(e){this._ops=e?e.slice():[]}get ops(){return this._ops}insert(e,n){return this._ops.push({_type:2,_pos:e,_text:n}),this}insertFragment(e,n){return this._ops.push({_type:3,_pos:e,_fragment:n}),this}delete(e,n){return this._ops.push({_type:1,_start:e,_end:n}),this}select(e,n){return this._ops.push({_type:4,_anchor:e,_focus:n}),this}transform(e){return this._ops.reduce((n,s)=>Ie(s)?se(n,s):n,e)}}const ce=t=>[...t],be=t=>[...t],Ge=(t,e)=>t.length===e.length&&t.every((n,s)=>n===e[s]),H=t=>"text"in t,ke=t=>H(t)?t.text.length:1,Ue=t=>t.reduce((e,n)=>e+ke(n),0),z=(t,e)=>{const n=[...t];if(!n.length)n.push(...e);else for(const s of e){const o=n.length-1,i=n[o];H(s)&&H(i)?n[o]={text:i.text+s.text}:n.push(s)}return n},B=(t,e)=>{for(let n=0;n<t.length;n++){const s=t[n],o=ke(s);if(o>e){const i=t.slice(0,n),c=t.slice(n+1);if(H(s)){const l=s.text.slice(0,e),f=s.text.slice(e);l&&i.push({text:l}),f&&c.unshift({text:f})}else c.unshift(s);return[i,c]}e-=o}return[t,[]]},te=(t,e,n,s)=>{const[o]=n,[i]=s||n,c=B(t[n[0]],n[1]),l=c[0],f=s?B(t[s[0]],s[1])[1]:c[1],d=ce(e);d.length?(d[0]=z(l,d[0]),d[d.length-1]=z(d[d.length-1],f)):d.push(z(l,f)),t.splice(o,i-o+1,...d)},We=(t,e,n)=>G(e,n)===0?[B(B(t[e[0]],n[1])[0],e[1])[1]]:[B(t[e[0]],e[1])[1],...t.slice(e[0]+1,n[0]),B(t[n[0]],n[1])[0]],$e=t=>{switch(t._type){case 1:return P(t._start,t._end)===1;case 2:return!!t._text;case 3:return!!ze(t._fragment)}return!0},je=(t,e)=>{switch(e._type){case 1:{te(t,[],e._start,e._end);break}case 2:{te(t,we(e._text),e._pos);break}case 3:{te(t,e._fragment,e._pos);break}}},se=(t,e)=>{switch(e._type){case 1:{const{_start:n,_end:s}=e;if(P(t,n)!==1)return P(s,t)===1?[t[0]+n[0]-s[0],t[1]+(G(s,t)===0?n[1]-s[1]:0)]:n;break}case 2:case 3:{const n=e._pos,s=e._type===2?we(e._text):e._fragment,o=s.length,i=o-1;if(P(t,n)!==1)return[t[0]+i,t[1]+(G(t,n)===0?Ue(s[o-1])-(i===0?0:n[1]):0)];break}}return t},Ze=(t,e,n,s)=>{const o=ce(t),i=be(e);try{for(const c of n.ops)$e(c)&&(Ie(c)?(je(t,c),e[0]=se(e[0],c),e[1]=se(e[1],c)):(c._anchor&&(e[0]=c._anchor),c._focus&&(e[1]=c._focus)))}catch(c){s&&s("rollback transaction: "+c),t.length=0,t.push(...o),e[0]=i[0],e[1]=i[1]}},Je=500,Qe=500,et=t=>{let e=0,n=0;const s=Date.now,o=[t],i=()=>o[e],c=()=>e>0,l=()=>e<o.length-1;return{get:i,set:f=>{o[e]=f},undo:()=>{if(c())return e--,i()},redo:()=>{if(l())return e++,i()},push:f=>{const d=s();e!==0&&d-n<Qe&&e--,n=d,o[++e]=f,o.splice(e+1),e>Je&&(e--,o.shift())}}};let x,p,v,U,re=!1,oe=!1,Ce;const tt=1,nt=4,ae=1,W=2,$=3,le=4,st=5,rt=6,ot=1,it=3,ct=8,at=t=>t.nodeType===it,j=t=>t.nodeType===ot,lt=t=>t.nodeType===ct,ut=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Me=t=>t.contentEditable==="false"||ut.has(t.tagName),ie=()=>p,Be=()=>v===ae?p.data.length:v===W?1:0,ft=t=>{x.currentNode=x.currentNode.parentNode.children[t]},Re=t=>{const e=t.nextSibling;return!!e&&!lt(e)},dt=()=>{for(;;){if(v===W){const t=p;for(;(p=x.nextNode())&&t.contains(p););}else p=x.nextNode();if(v=null,!p)break;if(U){if(U.contains(p)){if(re=!0,oe)break}else if(re)break}if(at(p)){const t=p.data;if(t)return t===`
`?v=Re(p)?$:rt:v=ae}else if(j(p)){if(p.tagName==="BR")return v=Re(p)?$:st;if(Me(p))return v=W;if(Ce(p))return v=le}}},ue=(t,e,{_document:n,_isBlock:s},o)=>{try{return Ce=s,x=n.createTreeWalker(e,nt|tt),o&&(o._startNode&&(x.currentNode=o._startNode,x.previousNode()),o._endNode&&(U=o._endNode),oe=o._excludeEnd||!1),t(dt)}finally{x=p=v=U=null,re=oe=!1}},Et=Math.min,pt=typeof queueMicrotask=="function"?queueMicrotask:t=>{Promise.resolve().then(t)},_t=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),Tt=t=>_t.has(t.tagName),ht=2,Ye=t=>t.ownerDocument,Ae=t=>Ye(t).getSelection(),gt=(t,e)=>{if(t.rangeCount){const n=t.getRangeAt(0);if(e.contains(n.commonAncestorContainer))return n}},xe=(t,e,n)=>{const s=Ae(t);s.removeAllRanges(),s.addRange(e),n&&(s.collapseToEnd(),s.extend(e.startContainer,e.startOffset))},Pe=(t,e,[n,s],o)=>{const i=P(n,s),c=i===0,l=i===-1,f=l?s:n,d=l?n:s;if(f[0]===0&&f[1]===0&&c&&!e.hasChildNodes()){const m=t.createRange();return m.setStart(e,0),m.setEnd(e,0),xe(e,m),!0}const u=me(e,f,o);if(!u)return!1;const T=c?u:me(e,d,o);if(!T)return!1;const _=t.createRange(),[S,y]=u,[L,O]=T;return j(S)?y<1?_.setStartBefore(S):_.setStartAfter(S):_.setStart(S,y),j(L)?O<1?_.setEndBefore(L):_.setEndAfter(L):_.setEnd(L,O),xe(e,_,l),!0},me=(t,[e,n],s)=>ue(o=>{let i,c=!1;for(;i=o();)if(i===le)c||(c=!0,e!==0&&ft(e));else{const l=Be();if(n<=l)return[ie(),n];n-=l}},t,s),Nt=(t,e)=>{let n=e;for(;;){const s=n.parentElement;if(s===t)break;n=s}return n},vt=t=>{let e=0;for(;t=t.previousElementSibling;)e++;return e},Z=(t,e,n,s)=>{let o,i,c=!0;if(t===e&&!e.hasChildNodes())return[0,0];if(j(e)&&!Me(e)&&e.hasChildNodes()){const f=Et(n,e.childNodes.length-1);e=e.childNodes[f],c=f===n,n=0}const l=Nt(t,e);return s._isBlock(l)?(o=l,i=vt(o)):(o=t,i=0),ue(f=>{let d,u=0;for(;d=f();)d===$?(i++,u=0):u+=Be();return[i,u+n]},o,s,{_endNode:e,_excludeEnd:c})},He=(t,e,{startOffset:n,startContainer:s,endOffset:o,endContainer:i})=>{const c=Z(t,s,n,e);return[c,s===i&&n===o?c:Z(t,i,o,e)]},Ke=()=>[[0,0],[0,0]],St=(t,e)=>t.compareDocumentPosition(e),Dt=(t,e)=>{const n=Ae(t),s=gt(n,t);if(!s)return Ke();const o=He(t,e,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(St(n.anchorNode,n.focusNode)&ht)!==0)?[o[1],o[0]]:o},Rt=(t,e,n)=>ue(s=>{let o,i=null,c="",l=!1;const f=[],d=()=>{c&&(i||(i=[]),i.push({text:c}),c="")},u=()=>{d(),!i&&l&&(i=[]),i&&f.push(i),i=null,l=!1};for(;o=s();)if(o===le)u();else if(l=!0,o===ae){const T=ie();c+=T.data}else if(o===W){d();const T=ie(),_=n(T);_&&i.push({data:_})}else o===$&&u();return u(),f.length||f.push([]),f},t,e),yt=(t,e,{clientX:n,clientY:s},o)=>{if(t.caretPositionFromPoint){const i=t.caretPositionFromPoint(n,s);if(i)return Z(e,i.offsetNode,i.offset,o)}else if(t.caretRangeFromPoint){const i=t.caretRangeFromPoint(n,s);if(i)return Z(e,i.startContainer,i.startOffset,o)}},Lt=(t,e)=>{let n=!1;const s=[],o=l=>{n&&s.push(...l)},i=new MutationObserver(l=>{o(l),n||e()}),c=()=>{o(i.takeRecords())};return i.observe(t,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(l){!n&&l&&c(),n=l},_flush:()=>(c(),s.splice(0)),_dispose(){s.splice(0),i.disconnect()}}},Ot=t=>new A(t.ops.map(e=>e._type===2?{...e,_text:e._text.replaceAll(`
`,"")}:e._type===3?{...e,_fragment:[e._fragment.reduce((n,s)=>z(n,s),[])]}:e)),ne=()=>{},xt=({schema:{single:t,js:e,doc:n,copy:s,paste:o},doc:i,isBlock:c=Tt,onChange:l,onKeyDown:f,onError:d=console.error})=>{let u=Ke(),T=!1,_=ne;const S=()=>y.get()[0],y=et([n(i),u]),L=[],O=r=>{T||(L.unshift(r),Ve(Fe))},m=new Set,Ve=r=>{m.has(r)||(m.add(r),pt(()=>{m.delete(r),r()}))},Fe=()=>{if(L.length){let r=ce(S()),w=be(u),D;for(;D=L.pop();)t&&(D=Ot(D)),Ze(r,w,D,d);const K=S();Ge(r,K)||(y.set([K,u]),y.push([r,w]),l(e(r))),u=w}};return{input:r=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return d("beforeinput event is not supported."),ne;const{contentEditable:w,role:D,ariaMultiLine:K,ariaReadOnly:Xe}=r,qe=r.style.whiteSpace;r.role="textbox",r.style.whiteSpace="pre-wrap",t||(r.ariaMultiLine="true");let fe=!1,J=!1,k=null,R=!1,V=!1,F=!1;const C=Ye(r),I={_document:C,_isBlock:c};_=()=>{r.contentEditable=T?"false":"true",r.ariaReadOnly=T?"true":null},_();const M=Lt(r,()=>{V&&Pe(C,r,u,I)}),Y=()=>{u=Dt(r,I)},Q=()=>{const a=M._flush();if(M._record(!1),a.length){let E;for(;E=a.pop();)if(E.type==="childList"){const{target:N,removedNodes:g,addedNodes:h,nextSibling:X}=E;for(let b=g.length-1;b>=0;b--)N.insertBefore(g[b],X);for(let b=h.length-1;b>=0;b--)N.removeChild(h[b])}else E.target.nodeValue=E.oldValue;M._flush(),J=Pe(C,r,u,I)}O(k),R=!1,k=null},de=a=>{if(!R){if(f&&f(a)){a.preventDefault();return}if((a.metaKey||a.ctrlKey)&&!a.altKey&&a.code==="KeyZ"&&(a.preventDefault(),M._record(!1),!T)){const E=a.shiftKey?y.redo():y.undo();E&&(l(e(E[0])),u=E[1])}}},Ee=()=>{R||Q()},pe=a=>{a.preventDefault();const E=a.inputType;if(E.startsWith("format")||E==="historyUndo"||E==="historyRedo")return;R?M._record(!0):Y();const N=a.getTargetRanges()[0];if(N){const g=He(r,I,N);let h=E==="insertParagraph"||E==="insertLineBreak"?`
`:a.data;if(h==null){const X=a.dataTransfer;X&&(h=X.getData("text/plain"))}k||(k=new A().select(...u)),P(...g)!==0&&k.delete(...g),h&&k.insert(g[0],h)}R||Q()},_e=()=>{R||Y(),R=!0},Te=()=>{Q()},he=()=>{V=!0,Y()},ge=()=>{V=!1},Ne=()=>{if(J){J=!1;return}V&&!R&&!F&&Y()},ee=a=>{Y(),P(...u)!==0&&s(a,We(S(),...q(u)),r)},ve=a=>{a.preventDefault(),ee(a.clipboardData)},Se=a=>{a.preventDefault(),T||(ee(a.clipboardData),O(new A().delete(...q(u))))},De=a=>{a.preventDefault();const[E,N]=q(u);O(new A().delete(E,N).insertFragment(E,o(a.clipboardData,I)))},ye=a=>{a.preventDefault();const E=a.dataTransfer,N=yt(C,r,a,I);if(E&&N){const g=new A;F&&g.delete(...q(u));const h=g.transform(N);g.select(h,h).insertFragment(h,o(E,I)).select(h),O(g),r.focus({preventScroll:!0})}},Le=a=>{F=!0,ee(a.dataTransfer)},Oe=()=>{F=!1};return C.addEventListener("selectionchange",Ne),r.addEventListener("keydown",de),r.addEventListener("input",Ee),r.addEventListener("beforeinput",pe),r.addEventListener("compositionstart",_e),r.addEventListener("compositionend",Te),r.addEventListener("focus",he),r.addEventListener("blur",ge),r.addEventListener("copy",ve),r.addEventListener("cut",Se),r.addEventListener("paste",De),r.addEventListener("drop",ye),r.addEventListener("dragstart",Le),r.addEventListener("dragend",Oe),()=>{fe||(fe=!0,_=ne,r.contentEditable=w,r.role=D,r.ariaMultiLine=K,r.ariaReadOnly=Xe,r.style.whiteSpace=qe,M._dispose(),C.removeEventListener("selectionchange",Ne),r.removeEventListener("keydown",de),r.removeEventListener("input",Ee),r.removeEventListener("beforeinput",pe),r.removeEventListener("compositionstart",_e),r.removeEventListener("compositionend",Te),r.removeEventListener("focus",he),r.removeEventListener("blur",ge),r.removeEventListener("copy",ve),r.removeEventListener("cut",Se),r.removeEventListener("paste",De),r.removeEventListener("drop",ye),r.removeEventListener("dragstart",Le),r.removeEventListener("dragend",Oe))}},command:(r,...w)=>{const D=r(S(),u,...w);D&&O(D)},readonly:r=>{T=r,_()}}};export{A as T,gt as a,Ae as b,xt as c,ze as d,H as e,Ue as g,lt as i,Rt as r,we as s,q as t};
