const U=([e],[t])=>e===t?0:e<t?1:-1,m=(e,t)=>{const n=U(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},z=([e,t])=>m(e,t)===-1?[t,e]:[e,t],Fe=(e,t=n=>K(n)?n.text:"")=>e.reduce((n,s,o)=>(o!==0&&(n+=`
`),n+s.reduce((i,a)=>i+t(a),"")),""),qe=e=>e.split(`
`).map(t=>t?[{text:t}]:[]);const we=e=>e._type!==3;class k extends Array{static from(t){return new k(...t)}insert(t,n){return this.push({_type:2,_pos:t,_fragment:n}),this}delete(t,n){return this.push({_type:1,_start:t,_end:n}),this}select(t,n){return this.push({_type:3,_anchor:t,_focus:n}),this}transform(t){return this.reduce((n,s)=>we(s)?ne(n,s):n,t)}}const ze=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),K=e=>"text"in e,be=e=>K(e)?e.text.length:1,Ge=e=>e.reduce((t,n)=>t+be(n),0),G=(e,t)=>{const n=[...e];if(!n.length)n.push(...t);else for(const s of t){const o=n.length-1,i=n[o];K(s)&&K(i)?n[o]={text:i.text+s.text}:n.push(s)}return n},A=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],o=be(s);if(o>t){const i=e.slice(0,n),a=e.slice(n+1);if(K(s)){const l=s.text.slice(0,t),f=s.text.slice(t);l&&i.push({text:l}),f&&a.unshift({text:f})}else a.unshift(s);return[i,a]}t-=o}return[e,[]]},Se=(e,t,n,s)=>{const[o]=n,[i]=s||n,a=A(e[n[0]],n[1]),l=a[0],f=s?A(e[s[0]],s[1])[1]:a[1],d=[...t];d.length?(d[0]=G(l,d[0]),d[d.length-1]=G(d[d.length-1],f)):d.push(G(l,f)),e.splice(o,i-o+1,...d)},Ue=(e,t,n)=>U(t,n)===0?[A(A(e[t[0]],n[1])[0],t[1])[1]]:[A(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),A(e[n[0]],n[1])[0]],We=e=>{switch(e._type){case 1:return m(e._start,e._end)===1;case 2:return!!Fe(e._fragment)}return!0},Xe=(e,t)=>{switch(t._type){case 1:{Se(e,[],t._start,t._end);break}case 2:{Se(e,t._fragment,t._pos);break}}},ne=(e,t)=>{switch(t._type){case 1:{const{_start:n,_end:s}=t;if(m(e,n)!==1)return m(s,e)===1?[e[0]+n[0]-s[0],e[1]+(U(s,e)===0?n[1]-s[1]:0)]:n;break}case 2:{const{_pos:n,_fragment:s}=t,o=s.length,i=o-1;if(m(e,n)!==1)return[e[0]+i,e[1]+(U(e,n)===0?Ge(s[o-1])-(i===0?0:n[1]):0)];break}}return e},$e=(e,t,n,s)=>{const o=[...e],i=[...t];try{for(const a of n)We(a)&&(we(a)?(Xe(e,a),t[0]=ne(t[0],a),t[1]=ne(t[1],a)):(a._anchor&&(t[0]=a._anchor),a._focus&&(t[1]=a._focus)))}catch(a){s&&s("rollback transaction: "+a),e.length=0,e.push(...o),t[0]=i[0],t[1]=i[1]}},je=500,Ze=500,Je=e=>{let t=0,n=0;const s=Date.now,o=[e],i=()=>o[t],a=()=>t>0,l=()=>t<o.length-1;return{get:i,set:f=>{o[t]=f},undo:()=>{if(a())return t--,i()},redo:()=>{if(l())return t++,i()},push:f=>{const d=s();t!==0&&d-n<Ze&&t--,n=d,o[++t]=f,o.splice(t+1),t>je&&(t--,o.shift())}}};let R,p,v,W,se=!1,re=!1,Pe;const Qe=1,et=4,ie=1,X=2,$=3,ae=4,tt=5,nt=6,st=1,rt=3,ot=8,it=e=>e.nodeType===rt,j=e=>e.nodeType===st,at=e=>e.nodeType===ot,ct=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Ce=e=>e.contentEditable==="false"||ct.has(e.tagName),oe=()=>p,ke=()=>v===ie?p.data.length:v===X?1:0,lt=e=>{R.currentNode=R.currentNode.parentNode.children[e]},Oe=e=>{const t=e.nextSibling;return!!t&&!at(t)},ut=()=>{for(;;){if(v===X){const e=p;for(;(p=R.nextNode())&&e.contains(p););}else p=R.nextNode();if(v=null,!p)break;if(W){if(W.contains(p)){if(se=!0,re)break}else if(se)break}if(it(p)){const e=p.data;if(e)return e===`
`?v=Oe(p)?$:nt:v=ie}else if(j(p)){if(p.tagName==="BR")return v=Oe(p)?$:tt;if(Ce(p))return v=X;if(Pe(p))return v=ae}}},ce=(e,t,{_document:n,_isBlock:s},o)=>{try{return Pe=s,R=n.createTreeWalker(t,et|Qe),o&&(o._startNode&&(R.currentNode=o._startNode,R.previousNode()),o._endNode&&(W=o._endNode),re=o._excludeEnd||!1),e(ut)}finally{R=p=v=W=null,se=re=!1}},ft=Math.min,dt=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},Et=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),pt=e=>Et.has(e.tagName),ht=2,Ie=e=>e.ownerDocument,Me=e=>Ie(e).getSelection(),gt=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},xe=(e,t,n)=>{const s=Me(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},Re=(e,t,[n,s],o)=>{const i=m(n,s),a=i===0,l=i===-1,f=l?s:n,d=l?n:s;if(f[0]===0&&f[1]===0&&a&&!t.hasChildNodes()){const w=e.createRange();return w.setStart(t,0),w.setEnd(t,0),xe(t,w),!0}const u=me(t,f,o);if(!u)return!1;const g=a?u:me(t,d,o);if(!g)return!1;const h=e.createRange(),[y,L]=u,[S,O]=g;return j(y)?L<1?h.setStartBefore(y):h.setStartAfter(y):h.setStart(y,L),j(S)?O<1?h.setEndBefore(S):h.setEndAfter(S):h.setEnd(S,O),xe(t,h,l),!0},me=(e,[t,n],s)=>ce(o=>{let i,a=!1;for(;i=o();)if(i===ae)a||(a=!0,t!==0&&lt(t));else{const l=ke();if(n<=l)return[oe(),n];n-=l}},e,s),_t=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},Tt=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},Z=(e,t,n,s)=>{let o,i,a=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(j(t)&&!Ce(t)&&t.hasChildNodes()){const f=ft(n,t.childNodes.length-1);t=t.childNodes[f],a=f===n,n=0}const l=_t(e,t);return s._isBlock(l)?(o=l,i=Tt(o)):(o=e,i=0),ce(f=>{let d,u=0;for(;d=f();)d===$?(i++,u=0):u+=ke();return[i,u+n]},o,s,{_endNode:t,_excludeEnd:a})},Be=(e,t,{startOffset:n,startContainer:s,endOffset:o,endContainer:i})=>{const a=Z(e,s,n,t);return[a,s===i&&n===o?a:Z(e,i,o,t)]},Ae=()=>[[0,0],[0,0]],Nt=(e,t)=>e.compareDocumentPosition(t),vt=(e,t)=>{const n=Me(e),s=gt(n,e);if(!s)return Ae();const o=Be(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(Nt(n.anchorNode,n.focusNode)&ht)!==0)?[o[1],o[0]]:o},St=(e,t,n)=>ce(s=>{let o,i=null,a="",l=!1;const f=[],d=()=>{a&&(i||(i=[]),i.push({text:a}),a="")},u=()=>{d(),!i&&l&&(i=[]),i&&f.push(i),i=null,l=!1};for(;o=s();)if(o===ae)u();else if(l=!0,o===ie){const g=oe();a+=g.data}else if(o===X){d();const g=oe(),h=n(g);h&&i.push({data:h})}else o===$&&u();return u(),f.length||f.push([]),f},e,t),yt=(e,t,{clientX:n,clientY:s},o)=>{if(e.caretPositionFromPoint){const i=e.caretPositionFromPoint(n,s);if(i)return Z(t,i.offsetNode,i.offset,o)}else if(e.caretRangeFromPoint){const i=e.caretRangeFromPoint(n,s);if(i)return Z(t,i.startContainer,i.startOffset,o)}},Dt=(e,t)=>{let n=!1;const s=[],o=l=>{n&&s.push(...l)},i=new MutationObserver(l=>{o(l),n||t()}),a=()=>{o(i.takeRecords())};return i.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(l){!n&&l&&a(),n=l},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),i.disconnect()}}},Lt=e=>k.from(e.map(t=>t._type===2?{...t,_fragment:[t._fragment.reduce((n,s)=>G(n,s),[])]}:t)),te=()=>{},Ot=({schema:{single:e,js:t,doc:n,copy:s,paste:o},doc:i,isBlock:a=pt,onChange:l,onKeyDown:f,onError:d=console.error})=>{let u=Ae(),g=!1,h=te;const y=()=>L.get()[0],L=Je([n(i),u]),S=[],O=r=>{g||(S.unshift(r),He(Ke))},w=new Set,He=r=>{w.has(r)||(w.add(r),dt(()=>{w.delete(r),r()}))},Ke=()=>{if(S.length){let r=[...y()],b=[...u],D;for(;D=S.pop();)e&&(D=Lt(D)),$e(r,b,D,d);const Y=y();ze(r,Y)||(L.set([Y,u]),L.push([r,b]),l(t(r))),u=b}};return{input:r=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function"))return d("beforeinput event is not supported."),te;const{contentEditable:b,role:D,ariaMultiLine:Y,ariaReadOnly:Ye}=r,Ve=r.style.whiteSpace;r.role="textbox",r.style.whiteSpace="pre-wrap",e||(r.ariaMultiLine="true");let le=!1,J=!1,I=null,x=!1,V=!1,F=!1;const M=Ie(r),P={_document:M,_isBlock:a};h=()=>{r.contentEditable=g?"false":"true",r.ariaReadOnly=g?"true":null},h();const B=Dt(r,()=>{V&&Re(M,r,u,P)}),H=()=>{u=vt(r,P)},Q=()=>{const c=B._flush();if(B._record(!1),c.length){let E;for(;E=c.pop();)if(E.type==="childList"){const{target:N,removedNodes:T,addedNodes:_,nextSibling:q}=E;for(let C=T.length-1;C>=0;C--)N.insertBefore(T[C],q);for(let C=_.length-1;C>=0;C--)N.removeChild(_[C])}else E.target.nodeValue=E.oldValue;B._flush(),J=Re(M,r,u,P)}O(I),x=!1,I=null},ue=c=>{if(!x){if(f&&f(c)){c.preventDefault();return}if((c.metaKey||c.ctrlKey)&&!c.altKey&&c.code==="KeyZ"&&(c.preventDefault(),B._record(!1),!g)){const E=c.shiftKey?L.redo():L.undo();E&&(l(t(E[0])),u=E[1])}}},fe=()=>{x||Q()},de=c=>{c.preventDefault();const E=c.inputType;if(E.startsWith("format")||E==="historyUndo"||E==="historyRedo")return;x?B._record(!0):H();const N=c.getTargetRanges()[0];if(N){const T=Be(r,P,N);let _=E==="insertParagraph"||E==="insertLineBreak"?`
`:c.data;if(_==null){const q=c.dataTransfer;q&&(_=q.getData("text/plain"))}I||(I=new k().select(...u)),m(...T)!==0&&I.delete(...T),_&&I.insert(T[0],qe(_))}x||Q()},Ee=()=>{x||H(),x=!0},pe=()=>{Q()},he=()=>{V=!0,H()},ge=()=>{V=!1},_e=()=>{if(J){J=!1;return}V&&!x&&!F&&H()},ee=c=>{H(),m(...u)!==0&&s(c,Ue(y(),...z(u)),r)},Te=c=>{c.preventDefault(),ee(c.clipboardData)},Ne=c=>{c.preventDefault(),g||(ee(c.clipboardData),O(new k().delete(...z(u))))},ve=c=>{c.preventDefault();const[E,N]=z(u);O(new k().delete(E,N).insert(E,o(c.clipboardData,P)))},ye=c=>{c.preventDefault();const E=c.dataTransfer,N=yt(M,r,c,P);if(E&&N){const T=new k;F&&T.delete(...z(u));const _=T.transform(N);T.select(_,_).insert(_,o(E,P)).select(_),O(T),r.focus({preventScroll:!0})}},De=c=>{F=!0,ee(c.dataTransfer)},Le=()=>{F=!1};return M.addEventListener("selectionchange",_e),r.addEventListener("keydown",ue),r.addEventListener("input",fe),r.addEventListener("beforeinput",de),r.addEventListener("compositionstart",Ee),r.addEventListener("compositionend",pe),r.addEventListener("focus",he),r.addEventListener("blur",ge),r.addEventListener("copy",Te),r.addEventListener("cut",Ne),r.addEventListener("paste",ve),r.addEventListener("drop",ye),r.addEventListener("dragstart",De),r.addEventListener("dragend",Le),()=>{le||(le=!0,h=te,r.contentEditable=b,r.role=D,r.ariaMultiLine=Y,r.ariaReadOnly=Ye,r.style.whiteSpace=Ve,B._dispose(),M.removeEventListener("selectionchange",_e),r.removeEventListener("keydown",ue),r.removeEventListener("input",fe),r.removeEventListener("beforeinput",de),r.removeEventListener("compositionstart",Ee),r.removeEventListener("compositionend",pe),r.removeEventListener("focus",he),r.removeEventListener("blur",ge),r.removeEventListener("copy",Te),r.removeEventListener("cut",Ne),r.removeEventListener("paste",ve),r.removeEventListener("drop",ye),r.removeEventListener("dragstart",De),r.removeEventListener("dragend",Le))}},command:(r,...b)=>{const D=r(y(),u,...b);D&&O(D)},readonly:r=>{g=r,h()}}};export{k as T,St as a,gt as b,Ot as c,Fe as d,Me as e,K as f,Ge as g,at as i,z as r,qe as s};
