const U=([e],[t])=>e===t?0:e<t?1:-1,m=(e,t)=>{const n=U(e,t);return n===0?e[1]===t[1]?0:e[1]<t[1]?1:-1:n},z=([e,t])=>m(e,t)===-1?[t,e]:[e,t],ze=(e,t)=>e.reduce((n,s,i)=>(i!==0&&(n+=`
`),n+s.reduce((r,a)=>r+(H(a)?a.text:t?t(a):""),"")),""),Ge=e=>e.split(`
`).map(t=>t?[{text:t}]:[]);const ke=e=>e._type!==3;class w extends Array{static from(t){return new w(...t)}insert(t,n){return this.push({_type:2,_pos:t,_fragment:n}),this}delete(t,n){return this.push({_type:1,_start:t,_end:n}),this}select(t,n){return this.push({_type:3,_anchor:t,_focus:n}),this}rebasePos(t){return this.reduce((n,s)=>ke(s)?se(n,s):n,t)}}const Ue=(e,t)=>e.length===t.length&&e.every((n,s)=>n===t[s]),H=e=>"text"in e,Ie=e=>H(e)?e.text.length:1,We=e=>e.reduce((t,n)=>t+Ie(n),0),G=(e,t)=>{const n=[...e];if(!n.length)n.push(...t);else for(const s of t){const i=n.length-1,r=n[i];H(s)&&H(r)?n[i]={text:r.text+s.text}:n.push(s)}return n},I=(e,t)=>{for(let n=0;n<e.length;n++){const s=e[n],i=Ie(s);if(i>t){const r=e.slice(0,n),a=e.slice(n+1);if(H(s)){const c=s.text.slice(0,t),u=s.text.slice(t);c&&r.push({text:c}),u&&a.unshift({text:u})}else a.unshift(s);return[r,a]}t-=i}return[e,[]]},be=(e,t,n,s)=>{const[i]=n,[r]=s||n,a=I(e[n[0]],n[1]),c=a[0],u=s?I(e[s[0]],s[1])[1]:a[1],d=[...t];d.length?(d[0]=G(c,d[0]),d[d.length-1]=G(d[d.length-1],u)):d.push(G(c,u)),e.splice(i,r-i+1,...d)},Xe=(e,t,n)=>U(t,n)===0?[I(I(e[t[0]],n[1])[0],t[1])[1]]:[I(e[t[0]],t[1])[1],...e.slice(t[0]+1,n[0]),I(e[n[0]],n[1])[0]],$e=e=>{switch(e._type){case 1:return m(e._start,e._end)===1;case 2:return!!ze(e._fragment)}return!0},je=(e,t)=>{switch(t._type){case 1:{be(e,[],t._start,t._end);break}case 2:{be(e,t._fragment,t._pos);break}}},se=(e,t)=>{switch(t._type){case 1:{const{_start:n,_end:s}=t;if(m(e,n)!==1)return m(s,e)===1?[e[0]+n[0]-s[0],e[1]+(U(s,e)===0?n[1]-s[1]:0)]:n;break}case 2:{const{_pos:n,_fragment:s}=t,i=s.length,r=i-1;if(m(e,n)!==1)return[e[0]+r,e[1]+(U(e,n)===0?We(s[i-1])-(r===0?0:n[1]):0)];break}}return e},Qe=(e,t,n)=>{const s=[...e],i=[...t];try{for(const r of n)$e(r)&&(ke(r)?(je(e,r),t[0]=se(t[0],r),t[1]=se(t[1],r)):(r._anchor&&(t[0]=r._anchor),r._focus&&(t[1]=r._focus)))}catch(r){console.error("rollback transaction:",r),e.length=0,e.push(...s),t[0]=i[0],t[1]=i[1]}},Ze=500,Je=500,et=e=>{let t=0,n=0;const s=Date.now,i=[e],r=()=>i[t],a=()=>t>0,c=()=>t<i.length-1;return{get:r,set:u=>{i[t]=u},undo:()=>{if(a())return t--,r()},redo:()=>{if(c())return t++,r()},push:u=>{const d=s();t!==0&&d-n<Je&&t--,n=d,i[++t]=u,i.splice(t+1),t>Ze&&(t--,i.shift())}}};let O,p,v,W,re=!1,oe=!1,Me;const tt=1,nt=4,ae=1,X=2,$=3,ce=4,st=5,rt=6,ot=1,it=3,at=8,ct=e=>e.nodeType===it,j=e=>e.nodeType===ot,lt=e=>e.nodeType===at,ut=new Set(["EMBED","IMG","PICTURE","AUDIO","VIDEO","SVG","CANVAS","MATH","IFRAME","OBJECT"]),Be=e=>e.contentEditable==="false"||ut.has(e.tagName),ie=()=>p,Ae=()=>v===ae?p.data.length:v===X?1:0,dt=e=>{O.currentNode=O.currentNode.parentNode.children[e]},we=e=>{const t=e.nextSibling;return!!t&&!lt(t)},ft=()=>{for(;;){if(v===X){const e=p;for(;(p=O.nextNode())&&e.contains(p););}else p=O.nextNode();if(v=null,!p)break;if(W){if(W.contains(p)){if(re=!0,oe)break}else if(re)break}if(ct(p)){const e=p.data;if(e)return e===`
`?v=we(p)?$:rt:v=ae}else if(j(p)){if(p.tagName==="BR")return v=we(p)?$:st;if(Be(p))return v=X;if(Me(p))return v=ce}}},le=(e,t,{_document:n,_isBlock:s},i)=>{try{return Me=s,O=n.createTreeWalker(t,nt|tt),i&&(i._startNode&&(O.currentNode=i._startNode,O.previousNode()),i._endNode&&(W=i._endNode),oe=i._excludeEnd||!1),e(ft)}finally{O=p=v=W=null,re=oe=!1}},Et=Math.min,pt=typeof queueMicrotask=="function"?queueMicrotask:e=>{Promise.resolve().then(e)},ht=new Set(["DIV","H1","H2","H3","H4","H5","H6","P","PRE","LI","DT","DD","TR"]),Tt=e=>ht.has(e.tagName),gt=2,He=e=>e.ownerDocument,ue=e=>He(e).getSelection(),Ke=(e,t)=>{if(e.rangeCount){const n=e.getRangeAt(0);if(t.contains(n.commonAncestorContainer))return n}},Pe=(e,t,n)=>{const s=ue(e);s.removeAllRanges(),s.addRange(t),n&&(s.collapseToEnd(),s.extend(t.startContainer,t.startOffset))},ne=(e,t,[n,s],i)=>{const r=m(n,s),a=r===0,c=r===-1,u=c?s:n,d=c?n:s;if(u[0]===0&&u[1]===0&&a&&!t.hasChildNodes()){const f=e.createRange();return f.setStart(t,0),f.setEnd(t,0),Pe(t,f),!0}const T=Ce(t,u,i);if(!T)return!1;const D=a?T:Ce(t,d,i);if(!D)return!1;const g=e.createRange(),[N,y]=T,[x,P]=D;return j(N)?y<1?g.setStartBefore(N):g.setStartAfter(N):g.setStart(N,y),j(x)?P<1?g.setEndBefore(x):g.setEndAfter(x):g.setEnd(x,P),Pe(t,g,c),!0},Ce=(e,[t,n],s)=>le(i=>{let r,a=!1;for(;r=i();)if(r===ce)a||(a=!0,t!==0&&dt(t));else{const c=Ae();if(n<=c)return[ie(),n];n-=c}},e,s),_t=(e,t)=>{let n=t;for(;;){const s=n.parentElement;if(s===e)break;n=s}return n},Nt=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},Q=(e,t,n,s)=>{let i,r,a=!0;if(e===t&&!t.hasChildNodes())return[0,0];if(j(t)&&!Be(t)&&t.hasChildNodes()){const u=Et(n,t.childNodes.length-1);t=t.childNodes[u],a=u===n,n=0}const c=_t(e,t);return s._isBlock(c)?(i=c,r=Nt(i)):(i=e,r=0),le(u=>{let d,T=0;for(;d=u();)d===$?(r++,T=0):T+=Ae();return[r,T+n]},i,s,{_endNode:t,_excludeEnd:a})},Ye=(e,t,{startOffset:n,startContainer:s,endOffset:i,endContainer:r})=>{const a=Q(e,s,n,t);return[a,s===r&&n===i?a:Q(e,r,i,t)]},Ve=()=>[[0,0],[0,0]],vt=(e,t)=>e.compareDocumentPosition(t),yt=(e,t)=>{const n=ue(e),s=Ke(n,e);if(!s)return Ve();const i=Ye(e,t,s);return(n.anchorNode===n.focusNode?n.anchorOffset>n.focusOffset:(vt(n.anchorNode,n.focusNode)&gt)!==0)?[i[1],i[0]]:i},Dt=(e,t,n,s)=>le(i=>{let r,a=null,c="",u=!1;const d=[],T=()=>{c&&(a||(a=[]),a.push({text:c}),c="")},D=()=>{T(),!a&&u&&(a=[]),a&&d.push(a),a=null,u=!1};for(;r=i();)if(r===ce)D();else if(u=!0,r===ae){let N=ie().data;c+=N}else if(r===X){T();const g=ie(),N=n(g);N&&a.push({data:N})}else r===$&&D();return D(),d.length||d.push([]),d},e,t,s),Lt=(e,t,{clientX:n,clientY:s},i)=>{if(e.caretPositionFromPoint){const r=e.caretPositionFromPoint(n,s);if(r)return Q(t,r.offsetNode,r.offset,i)}else if(e.caretRangeFromPoint){const r=e.caretRangeFromPoint(n,s);if(r)return Q(t,r.startContainer,r.startOffset,i)}},St=(e,t)=>{let n=!1;const s=[],i=c=>{n&&s.push(...c)},r=new MutationObserver(c=>{i(c),n||t()}),a=()=>{i(r.takeRecords())};return r.observe(e,{characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0}),{_record(c){!n&&c&&a(),n=c},_flush:()=>(a(),s.splice(0)),_dispose(){s.splice(0),r.disconnect()}}},Ot=e=>w.from(e.map(t=>t._type===2?{...t,_fragment:[t._fragment.reduce((n,s)=>G(n,s),[])]}:t)),mt=(e,{schema:{single:t,js:n,void:s,copy:i,paste:r},isBlock:a=Tt,onChange:c,onKeyDown:u})=>{if(!(window.InputEvent&&typeof InputEvent.prototype.getTargetRanges=="function")){console.error("beforeinput event is not supported.");const o=()=>{};return{dispose:o,command:o,readonly:o}}const{contentEditable:d,role:T,ariaMultiLine:D,ariaReadOnly:g}=e,N=e.style.whiteSpace;e.role="textbox",e.style.whiteSpace="pre-wrap",t||(e.ariaMultiLine="true");let y=!1,x=!1,P=!1,f=Ve(),C=null,K=null,L=!1,Y=!1,V=!1;const R=He(e),S={_document:R,_isBlock:a},de=()=>{e.contentEditable=y?"false":"true",e.ariaReadOnly=y?"true":null};de();const fe=(o,l)=>Dt(o,l,s),F=()=>B.get()[0],Z=[],M=o=>{y||(Z.unshift(o),Fe(qe))},B=et([fe(e,S),f]),k=St(e,()=>{Y&&(ne(R,e,f,S),K!=null&&(clearTimeout(K),K=null))}),J=new Set,Fe=o=>{J.has(o)||(J.add(o),pt(()=>{J.delete(o),o()}))},Ee=o=>{f=o,K=setTimeout(()=>{ne(R,e,o,S)})},A=()=>{f=yt(e,S)},ee=()=>{const o=k._flush();if(k._record(!1),o.length){let l;for(;l=o.pop();)if(l.type==="childList"){const{target:E,removedNodes:h,addedNodes:_,nextSibling:q}=l;for(let b=h.length-1;b>=0;b--)E.insertBefore(h[b],q);for(let b=_.length-1;b>=0;b--)E.removeChild(_[b])}else l.target.nodeValue=l.oldValue;k._flush()}M(C),L=!1,C=null,P=ne(R,e,f,S)},qe=()=>{if(Z.length){let o=[...F()],l=[...f],E;for(;E=Z.pop();)t&&(E=Ot(E)),Qe(o,l,E);const h=F();Ue(o,h)||(B.set([h,f]),B.push([o,l]),c(n(o))),Ee(l)}},pe=o=>{if(!L){if(u&&u(o)){o.preventDefault();return}if((o.metaKey||o.ctrlKey)&&!o.altKey&&o.code==="KeyZ"&&(o.preventDefault(),k._record(!1),!y)){const l=o.shiftKey?B.redo():B.undo();l&&(c(n(l[0])),Ee(l[1]))}}},he=()=>{L||ee()},Te=o=>{o.preventDefault();const l=o.inputType;if(l.startsWith("format")||l==="historyUndo"||l==="historyRedo")return;L?k._record(!0):A();const E=o.getTargetRanges()[0];if(E){const h=Ye(e,S,E);let _=l==="insertParagraph"||l==="insertLineBreak"?`
`:o.data;if(_==null){const q=o.dataTransfer;q&&(_=q.getData("text/plain"))}C||(C=new w().select(...f)),m(...h)!==0&&C.delete(...h),_&&C.insert(h[0],Ge(_))}L||ee()},ge=()=>{L||A(),L=!0},_e=()=>{ee()},Ne=()=>{Y=!0,A()},ve=()=>{Y=!1},ye=()=>{if(P){P=!1;return}Y&&!L&&!V&&A()},te=o=>{A(),m(...f)!==0&&i(o,Xe(F(),...z(f)),()=>Ke(ue(e),e).cloneContents())},De=o=>r(o,l=>fe(l,S)),Le=o=>{o.preventDefault(),te(o.clipboardData)},Se=o=>{o.preventDefault(),y||(te(o.clipboardData),M(new w().delete(...z(f))))},Oe=o=>{o.preventDefault();const[l,E]=z(f);M(new w().delete(l,E).insert(l,De(o.clipboardData)))},me=o=>{o.preventDefault();const l=o.dataTransfer,E=Lt(R,e,o,S);if(l&&E){const h=new w;V&&h.delete(...z(f));const _=h.rebasePos(E);h.select(_,_).insert(_,De(l)).select(_),M(h),e.focus({preventScroll:!0})}},xe=o=>{V=!0,te(o.dataTransfer)},Re=()=>{V=!1};return R.addEventListener("selectionchange",ye),e.addEventListener("keydown",pe),e.addEventListener("input",he),e.addEventListener("beforeinput",Te),e.addEventListener("compositionstart",ge),e.addEventListener("compositionend",_e),e.addEventListener("focus",Ne),e.addEventListener("blur",ve),e.addEventListener("copy",Le),e.addEventListener("cut",Se),e.addEventListener("paste",Oe),e.addEventListener("drop",me),e.addEventListener("dragstart",xe),e.addEventListener("dragend",Re),{dispose:()=>{x||(x=!0,e.contentEditable=d,e.role=T,e.ariaMultiLine=D,e.ariaReadOnly=g,e.style.whiteSpace=N,k._dispose(),R.removeEventListener("selectionchange",ye),e.removeEventListener("keydown",pe),e.removeEventListener("input",he),e.removeEventListener("beforeinput",Te),e.removeEventListener("compositionstart",ge),e.removeEventListener("compositionend",_e),e.removeEventListener("focus",Ne),e.removeEventListener("blur",ve),e.removeEventListener("copy",Le),e.removeEventListener("cut",Se),e.removeEventListener("paste",Oe),e.removeEventListener("drop",me),e.removeEventListener("dragstart",xe),e.removeEventListener("dragend",Re))},command:(o,...l)=>{const E=o(F(),f,...l);E&&M(E)},readonly:o=>{y=o,de()}}};export{w as T,H as a,ze as d,mt as e,We as g,lt as i,z as r,Ge as s};
